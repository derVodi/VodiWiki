<!DOCTYPE html>
<html>
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "VodiWiki", major: 1, minor: 0, revision: 7};
//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="Copyright (c) Mark Vodicka 2016-2020 (www.vodi.de)
Copyright (c) TiddlyWiki created by Jeremy Ruston 2004-2007 (jeremy [at] osmosoft [dot] com)
Copyright (c) UnaMesa Association 2007-2012
Copyright (c) abego Software GmbH, 2005-2012 (www.abego-software.de)

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. Neither the name of Mark Vodicka, Jeremy Ruston, the UnaMesa Association, abego Software nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITEDTO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE." />
<!--PRE-HEAD-START-->
<!--PRE-HEAD-END-->
<title> VodiWiki </title>
<style id="styleArea" type="text/css">

/* Anatomy */

body {margin: 0; padding: 0;}
html, body, #contentWrapper, #displayArea, #tiddlerDisplay {height: 100%; overflow:hidden;}
#backstageTabBar {position:relative; padding: 0 0.3em; z-index:900;}
.backstageTabHead {display: inline-block; margin: 1px 1px 0 1px; padding: 0.3em 1em; border-radius: 4px 4px 0 0;}
#backstagePanel {display:none; z-index:900; box-sizing:border-box; max-width: calc(100% - 4em); max-height:calc(100% - 3em); margin-left:4.9em; padding:1em; position:absolute; overflow: auto;}
.backstagePanelBody {position:relative;}

#navigationArea {float: left; min-width: 1em; width: auto; height:100%; position:relative; padding: 9px 1px 0 0;}
#navigationCollapser {position:absolute; top: 5px; right: 0; z-index:200;}
#navigationPanel {position:static; height:100%;}

#navAndSearch {margin-bottom: 0.3em;}
#treePath {border: 1px inset grey; padding: 0 0.3em; line-height: 1.3em; }
#navToolbar, #search, #navButtons, #treePath {display: table-cell;}
#navToolbar, #treePath {width: 100%;}
#search, #treePath {white-space: nowrap;}
.searchField {margin-left: 1em;}
.searchField, #search .button {display: inline-block; box-sizing: border-box; height: 1.7em;}

.articleContentContainer {position:relative; padding-top: 0.5em; padding-bottom: 2em;}
table {border-collapse: collapse;}
table td {vertical-align: top;}
.articleContentContainer table, table.twtable {margin: 1pt 0;}
.articleContentContainer th, .articleContentContainer td, .articleContentContainer tr, .articleContentContainer caption, .twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
.toolbar {text-align:right; font-size:.9em;}
#displayArea {padding-top: 3px}
#pageWrapper {position:relative; height:100%;}
#tiddlerDisplay {position:relative;}
.articleView {bottom: 3em; left: 0; overflow: auto; position: absolute; right: 0; top: 0; padding: 6pt 8pt 0;}

#saveTest {display:none;}

#messageArea {z-index:2000; display:none; position:absolute; top:0; right:0;}
#messageArea {border:1px solid #db4; background:#fe8;}
#messageArea {margin:0.5em; padding:0 0.5em 0.5em 0.5em; }
#messageArea .button {display:block; text-align:right; font-size:0.7em;}

#sidebar {position: static; width:auto; float: right; padding:26px 0;}

#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#builtInArticles {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}

/* Text */

body, #navigationPanel, .articleContentContainer, .editor, h3, h4 {font-size: 11.5pt;}
h5, #search {font-size: 10pt;}
.licenseText, .yourSearchResult .summary .chkBoxLabel {font-size: 8pt;}
.licenseText {display: inline-block; line-height: 1em; width: 51em; text-align: justify;}
body, .articleContentContainer, .editor, h3, h4, h5, h6 {font-family: calibri, tahoma, helvetica; line-height: 1.2em;}

h1, h2, h3, h4, h5, h6 {margin: 0; border: 0;}
h1 {font-size: 14pt; padding: 2pt 0 2pt 0;}
h2 {font-size:13pt;padding: 1pt 0 1pt 0;}
h3, h4, h5, h6 {padding: 1pt 0 0;}
h4 {font-style:italic;}
h5 {font-weight:normal;}
h6 {display:none;}
a {text-decoration: none;}
a img {border: 0;}
pre, code {font-family: consolas, lucida console, mono,courier; font-size: 10pt; line-height: 10pt; margin: 0;}
pre {padding: 4pt;}
code {white-space: nowrap;}
textarea, .articleContentContainer pre {tab-size: 2; -moz-tab-size: 2}
.twtable thead td {font-weight: bold;}
#navigationPanel, #sidebarContent {line-height: 1.3em;}
.articleTreePanel {line-height: 1.4em;}
.title {font-size: 18pt; font-weight: normal;}
#tiddlerDisplay .title {margin:-0.5em 0 12pt 0;}
table.listView {font-size: 0.85em;}
.externalLink {text-decoration: underline;}
.tiddlyLinkNonExisting, .missing .articleContentContainer, .missing .title {font-style:italic;}
.backstageTabHead {font-weight: bold;}

/* Layout Elements */

ul, ol {padding: 0 0 0 12pt; margin: 0 0 0 6pt;}
hr {height: 1px; border: 0; background-color: grey;}
.listBreak {border-bottom: 1px solid;}
table.twtable, .twtable td, .twtable thead td, .twtable th, .wizard, .popup, .yourSearchResult {border: 1px solid;}
table.listView th, table.listView td, table.listView tr {padding: 0 3px 0 3px;}
.dualColorTable {display: inline-block;}
.TODO {color:whitesmoke;background-color: black;	padding: 0.3em 0.7em 0.3em 2.3em;	border-radius: 5px;	display: inline-block;	text-indent: -1.8em;}
.TODO::before {content: '[TODO] ';font-size: 0.7em;vertical-align: top;color:aqua;}
.notice {background-color: khaki; padding: 0.3em 0.7em 0.3em 2.3em;	border-radius: 5px;	display: inline-block;	text-indent: -1.8em;}
.notice::before {content: '🛈 ';font-size: 1.3em;vertical-align: bottom;}
blockquote {line-height: 1.5em;	padding: 0.1em 0.5em 0.3em 1.7em;	margin: 0;	box-shadow: inset 0 0 0.5em gray;	border: 0;position:relative;}
blockquote::before {position:absolute;top:0.3em;left:0.2em;content:'\275D'; font-size: 2em; color:lightgrey;}

/* Interactivity */

.button {border-width:1px; border-style: solid; border-radius: 3px; padding: 0.1em 0.5em; font-weight: bold;}
.buttonWithIcon {display: block; position: relative; padding-left: 1.75em; margin-bottom: 0.5em;}
.buttonWithIcon *:first-child {position: absolute; left: 0;}

.listView input:not([type=checkbox]) {width:  11em; border:0;} /* These are nested in table cells */
.branch .button {position: absolute; left: -1em; padding: 0;}
.tab {margin: 0 1pt 0 0; padding: 2px 0.6em; border-radius: 0.4em 0.4em 0 0;}
.tabContents {padding: 0.3em;}
.sideBarTabSet .tabContents li {list-style:none;}
.tabContents li.listLink {margin-left:.75em;}
.tabContents {position: relative; height: 100%; height: calc(100% - 49px); overflow-y: scroll; padding-right: 0.8em;}

#navigationPanel .tabsetWrapper {height:100%; position:relative;}
#navigationPanel .button {display: block; border: 0;}
#navigationPanel li {list-style: none;}
.articleTreePanel > .nodesWrapper {margin-left: 0;}
.nodesWrapper {margin-left: 1em;}
.branch {position: relative;}
.branch a {display: block;}
.branch, .leaf {display: block; margin-left: 1em;}
.branch .tiddlyLink, .leaf {padding-left: 0.3em;}
.articleTreeButtons {display: block; margin-top: 0.5em;}

#backstageCloak {display:none; z-index:500; position:absolute; width:100%; height:100%; background: black; opacity:0.6; filter:alpha(opacity=60);}

#backstageButton {position:absolute; z-index:1000; top:0; right:0; font-size:0.7em;}
#backstageButton a {padding:0.1em 0.4em; margin:0.1em;}
#backstageShow {color: transparent;}

#sidebarCollapser {text-align:right;}
#sidebarTabs .tabContents {overflow:hidden;}

.popup {position:absolute; z-index:1000; font-size:.9em; padding:0; list-style:none; margin:0;}

.inputDialogPanel{left: 0;margin: auto; padding: 0.3em 0.7em 0.7em; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 640px; z-index: 1000;}
.inputDialogPanel h1, .inputDialogPanel input {margin-bottom: 0.3em;}
.inputDialogPanel input {display:block; width:99%;}
.inputDialogPanel-buttonsPanel {text-align: right;margin-top: 1em;}
.inputDialogPanel-buttonsPanel button {min-width: 75px;margin: 0 0.3em;}

.wizard {box-sizing: border-box; height: 100%; padding: 2.75em 1em 0.3em 1em} /* Top: Leave space for title */
.wizard .title {position:absolute; top: 0.4em;} /* Float title, otherwise it would consume vertical space and break height calculation of nested divs */
.wizard h1 {margin-bottom: 0.5em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0; text-align: right;}
.wizardFooter .status {text-align: left; margin-bottom: 0.5em; }
.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

.yourSearchResult {position: absolute; width: 800px; padding: 0.2em; list-style: none; margin: 0; background: lightyellow;}
.yourSearchResult .summary {border-bottom-width: thin; border-bottom-style: solid; padding-bottom: 4px;}
.yourSearchItem {margin-top: 2px;}
.yourSearchNumber {color: #808080;} /* todo: tree shake */
.yourSearchTags {color: #008000;}
.yourSearchText {color: #808080; margin-bottom: 6px;}
.yourSearchFooter {margin-top: 8px; border-top-width: thin; border-top-style: solid; border-top-color: #999999;}
.yourSearchFooter a:hover{background: none; color: none;}
.yourSearchNaviBar a {font-size: 16px; margin-left: 4px; margin-right: 4px; color: black; text-decoration: underline;}
.yourSearchNaviBar a:hover {background-color: none;}
.yourSearchNaviBar .prev {font-weight: bold; color: blue;}
.yourSearchNaviBar .currentPage {color: red; font-weight: bold; text-decoration: none;}
.yourSearchNaviBar .next {font-weight: bold; color: blue;}

/* Colors.Foregrounds (sorting: getting lighter) */

.twtable thead td, .backstageTabHead:hover, #backstageShow, a.backstageSelTab {color: black;}
.anchor, .anchor:hover, .title, .inputDialogPanel {color: black;}
.button, .button:hover, .button a, #treePath a {color: darkblue;}

a, a:hover {color:blue;}

#navigationPanel .button, .editorFooter {color: darkgray;}
.yourSearchResult .summary {border-color: darkgray;}
table.twtable, .twtable td, .twtable thead td, .twtable th, .wizard, .yourSearchResult {border-color: darkgray;}
h5, .popup li.disabled, #backstageTabBar {color: gray;}
.popup, .wizard, .listBreak {border-color: lightgray;}
pre {border: 1px solid lightblue;}
.tabContents {color: deepskyblue;}
h1 {color: #003600;}
h2, h3, h4, h5 {color: #366092;}
.button {border-color: transparent;}
.button:hover {border-color: #db4;}
.button:active {background: #db4; border-color: #841;}

.backstageTabHead, .tabSelected, .tabUnselected, .tab:hover, .tabContents a, .tabContents a:hover, #backstageHide {color: white;}

/* Colors.Backgrounds (sorting: getting darker) */

a:hover {background-color:transparent;}
#tiddlerDisplay, .inputDialogPanel, .wizard {background-color:white;}
body, .twtable thead td, .twtable th, #backstagePanel, .backstageSelTab, pre, .popup, .readOnly {background-color: whitesmoke;}
.yourSearchResult {background: lightyellow;}
.highlight, .marked, .toBeImported .tiddlyLinkExisting {background: yellow;}
.backstageTabHead:hover, .button:hover, .wizardFooter .button:hover {background-color: khaki;}
.dualColorTable tbody td:first-child, .listView tbody td:first-child {background-color: #DEEBF6;} /* Blue 80% */
.error, .errorButton {background: #f88;} /* Red */
.wizardFooter .button {background-color: lightgrey;}
.tab:hover {background-color:#BFBFBF;}
.tab {background-color: darkgray;}
.tabSelected:hover, .tabContents a:hover {background-color:#636363 !important;}
.tabSelected, .tabContents {background-color: #535353 !important;} /* Black 35% */
.tiddlyLink.current {background-color: #333333 !important;} /* Black 35% */
.tiddlyLink.current {box-shadow: 0px 0px 0px 1px #333333;}
#backstageTabBar {background-color: black;}

/* Shadows */

.popup, .wizard, #yourSearchResult {box-shadow: 3px 3px 5px lightgray;}

</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if (window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<noscript>
	<div id="javascriptWarning">This page requires JavaScript to function properly.</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageTabBar"></div>
<div id="backstagePanel"></div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="builtInArticles">
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class="toolbar" macro="toolbar +saveTiddler -cancelTiddler"&gt;&lt;/div&gt;
&lt;div class="title" macro="view title"&gt;&lt;/div&gt;
&lt;div class="editor" macro="edit title"&gt;&lt;/div&gt;
&lt;div class="editor" macro="edit text"&gt;&lt;/div&gt;
&lt;div class="editor" macro="edit tags"&gt;Tags: &lt;/div&gt;
&lt;div class="editor" macro="edit parenttitle"&gt;Parent:&lt;/div&gt;
&lt;div class="editorFooter"&gt;&lt;span macro="message views.editor.tagHint"&gt;&lt;/span&gt;&lt;span macro="tagChooser"&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div id='navigationArea'&gt;
	&lt;div id='navigationCollapser' macro='collapseArea navigationPanel'&gt;&lt;/div&gt;
	&lt;div id='navigationPanel' refresh='content' force='true' tiddler='NavigationPanel'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='sidebar'&gt;
	&lt;div id='sidebarCollapser' macro='collapseArea sidebarContent true "Side Bar" "»«"'&gt;&lt;/div&gt;
	&lt;div id='sidebarContent'&gt;
		&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
	&lt;div id='navAndSearch'&gt;
		&lt;div id='navToolbar'&gt;
			&lt;span id='navButtons' macro='navigate'&gt;&lt;/span&gt;
			&lt;div id='treePath'&gt;&lt;/div&gt;
		&lt;/div&gt;
		&lt;span id='search' macro='search'&gt;&lt;/span&gt;
	&lt;/div&gt;
	&lt;div id='pageWrapper'&gt;
		&lt;div id='messageArea'&gt;&lt;/div&gt;	
		&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
	&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/

#contentWrapper .chkOptionInput {border:0;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0; font-size:.9em;}

.fieldsetFix {border:0; padding:0; margin:1px 0px;}

/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#navigationPanel, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none !important;}
noscript {display:none;} /* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar'&gt;&lt;span macro='toolbar editTiddler deleteTiddler &gt; references &lt;'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='articleContentContainer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>

</div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="- Home -" created="201904232038" modified="202001260819" modifier="Anonymous" changecount="45">
<pre>| ''[[Download VodiWiki.zip|http://www.vodi.de/VodiWiki/VodiWiki.zip]]'' (Version &lt;&lt;version&gt;&gt;) |

!What is VodiWiki

* It's a single HTML file containing many documents 
* Built-in viewer with search function
* Built-in editor with local save function
* No cloud, no need to be online
* Portable
* Easy to publish

!Is It For Me?

!!Private Usage

* Use it to keep your notes together in a single file instead of having them spread in several files
* Create your private reference books 

!!Productive Usage

* Use it to document your product
* Put the HTML file on a web server and you're done (no CMS needed)

!!Collaborative Usage? Sync between devices?

* No. (not yet, but in the long term pipeline)

!Getting Started

* Just go here: [[Anatomy Of The Main Window]] (and following pages)

!Some Words on Data Protection

When working with sensitive data consider the following advice:

* Disable all browser plugins - they can read everything in a browser (even password fields, single key strokes, etc.).
* Turned off all &quot;cloud clipboard&quot; functionalities (copy &amp; paste contents will be transferred to your trusted(?) provider.).
** Note: Windows 10 comes with such a &quot;feature&quot; - check if it's enabled.
* Consider using an extra browser for the wiki that is blocked by a firewall

!Sources

* https://github.com/derVodi/VodiWiki

* https://trello.com/b/QffB4q5s/vodiwiki

!License

&lt;&lt;licenseText&gt;&gt;

&lt;html&gt;
	&lt;div style=&quot;position:absolute;top:0;right:2.5em;&quot;&gt;		
		&lt;a href=&quot;http://www.vodi.de/VodiWiki/index-de.html&quot;&gt;
			&lt;svg width=&quot;30&quot; height=&quot;18&quot; viewBox=&quot;0 0 5 3&quot;&gt;&lt;rect width=&quot;5&quot; height=&quot;3&quot; y=&quot;0&quot; x=&quot;0&quot; fill=&quot;#0&quot;/&gt;&lt;rect width=&quot;5&quot; height=&quot;2&quot; y=&quot;1&quot; x=&quot;0&quot; fill=&quot;#D00&quot;/&gt;&lt;rect width=&quot;5&quot; height=&quot;1&quot; y=&quot;2&quot; x=&quot;0&quot; fill=&quot;#FFCE00&quot;/&gt;&lt;/svg&gt;
			Deutsch
		&lt;/a&gt;
	&lt;/div&gt;
&lt;/html&gt;
</pre>
</div>
<div title="Anatomy Of The Main Window" created="201701242104" modified="202001251729" modifier="Anonymous" changecount="37" parenttitle="Getting Started">
<pre>|Backstage Menu (hidden)|&gt;|&gt;|
|Navigation Tabs|← → Navigation Bar| Search|
|Navigation&lt;br&gt;tree or&lt;br&gt;list views|&lt;br&gt;&lt;br&gt;Current Page&lt;br&gt;&lt;br&gt;&lt;br&gt; |&gt;|

!Backstage

* Can be shown by clicking ⌵ at the upper right
* Provides functions like New, Save, Import, Update, etc.

!Navigation Tabs

* Offer different kinds of views of the contained articles
* Can be hidden by clicking « at the left of the navigation bar

!Navigation Bar

* Offers relative navigation
* ← → - Navigates back/forward in view history
* You can click into the bar to jump directly to a parent article

!Search

* Search the content of all articles
</pre>
</div>
<div title="Embedding Parts Of Other Pages" created="201906080811" modified="201906081653" modifier="YourName" changecount="53" parenttitle="​Advanced Use Cases">
<pre>This is useful if you want to create some kind of overview page for other pages (e.g. a thesaurus).

!How To Embed

You'll have to address the page and it's part which you want to embed:

{{{
&lt;&lt;tiddler 'PageTitle##SectionName'&gt;&gt;
&lt;&lt;tiddler [[PageTitle::SliceName]]&gt;&gt;
}}}

The page title and part name is never embedded - only the inner part.
SliceNames must not contain spaces.

!What Is A &quot;Section&quot;?

Any text between one heading and another heading (or to the end of the document, in the case of the final section) is treated as a part. 
The name of the part is the title. The level of heading (!, !!, !!!, i.e. heading level 1, 2, 3, etc.) is irrelevant for this purpose.

!!!!!!InvisibleSection
This is a section with an invisible heading which can be done using 6 exclamation marks (like this: {{{!!!!!!InvisibleSection}}})

!What Is A &quot;Slice&quot;?

!!Table Cells

|FirstTableCell|Second table cell is the inner part content.|

!!Lines With Colons

SliceName: The text right from the colon (to the line end) is the inner part.&lt;br&gt;This pseudo new line (after {{{&lt;br&gt;}}}) is included.
This real new line is not.

!Example

The following code...

{{{
&lt;&lt;tiddler '##What Is A &quot;Section&quot;?'&gt;&gt;
&lt;&lt;tiddler 'Embedding Parts Of Other Pages##InvisibleSection'&gt;&gt;
&lt;&lt;tiddler [[Embedding Parts Of Other Pages::FirstTableCell]]&gt;&gt;
&lt;&lt;tiddler [[Embedding Parts Of Other Pages::SliceName]]&gt;&gt;
}}}

...generates this output:

|&lt;&lt;tiddler '##What Is A &quot;Section&quot;?'&gt;&gt;|
|&lt;&lt;tiddler 'Embedding Parts Of Other Pages##InvisibleSection'&gt;&gt;|
|&lt;&lt;tiddler [[Embedding Parts Of Other Pages::FirstTableCell]]&gt;&gt;|
|&lt;&lt;tiddler [[Embedding Parts Of Other Pages::SliceName]]&gt;&gt;|
</pre>
</div>
<div title="Getting Started" created="201904231951" modified="201904231951" modifier="YourName" changecount="1">
<pre></pre>
</div>
<div title="How to Customize Stuff" created="201904232039" modified="202001251730" modifier="Anonymous" changecount="7" parenttitle="Getting Started">
<pre>!The Window Title

* By default this is &quot;VodiWiki&quot;
* This can be changed in the backstage area
</pre>
</div>
<div title="How to Read Content" created="201904232015" modified="201904232018" modifier="YourName" changecount="3" parenttitle="Getting Started">
<pre>Only one page can be read at a time. There's no tabbed browsing.

* Use the tree/list in the left area to directly navigate through the pages
* Use the ← → buttons in the top area to navigate back/forward
* Use the search field to search for content
* Click on links in pages to navigate to other pages</pre>
</div>
<div title="How to Write Content" created="201904232018" modified="202001251849" modifier="Anonymous" changecount="18" parenttitle="Getting Started">
<pre>!Creating a New, Empty Wiki

* Unhide the backstage by clicking ⌵ on the upper right
* In the &quot;File&quot; menu choose &quot;New&quot;
** An empty file will be pushed into your download location.

!Adding a New Page

* Click on &quot;New Article&quot; to add a page on the root level
* Click on &quot;New Sub Article&quot; to add a page below the current page
** The parent of a page can also be changed afterwards (by typing another page title into the &quot;Parent&quot; field)
* Type your text (using [[wiki syntax|Syntax Reference]])
*Commit your edits by pressing the &quot;Done&quot; button or [Ctrl]-[Enter].
** The whole wiki is auto-saved now - some browsers might alert you to acknowledge the saving action.

!Editing an Existing Page

* Place the cursor to the spot you want to edit (or double click a word)
* Click on the &quot;Edit&quot; button in the upper right corner
** The cursor is now located at the previously clicked word

!Deleting a Page

* Navigate to the desired page
* Click on the &quot;Delete&quot; button (upper right area)

!Embedding Images

* Place the image file besides the Wiki-File (or create a sub directory, e.g. &quot;Files&quot;)
* Use a tag like this: {{{[img[Label|Files/Bars.svg]]}}}
** Example: [img[Label|index-Files/Bars.svg]]

!Saving

{{notice{
Never use the browser File/Save functions - this would save the file without your changes!
}}}

* Saving will be done automatically after every change
* &quot;Saving&quot; means: The changed wiki is pushed as a download.
** Due to browser restrictions the wiki cannot overwrite it's original file - therefore the download strategy is the only possible way (yet)
</pre>
</div>
<div title="Index Sorting" created="201906080758" modified="201906080810" modifier="YourName" changecount="4" parenttitle="​Advanced Use Cases">
<pre>Normally the index tree is sorted alphabetically. You can change the order of items only by using a trick:
Add an invisible space in front of the page title to push it at the bottom.

Here is a non printing space you can copy &amp; paste:

|Double click into the right table cell to select and copy to clipboard -&gt;|​|</pre>
</div>
<div title="Keyboard Shortcuts" created="201303170925" modified="201906080808" modifier="YourName" changecount="7" parenttitle="​Reference">
<pre>|Keys|Function|Available|h
|Ctrl-E|Search|Always|
|Ctrl-Enter|Toggle editing|Always|
|Ctrl-K|Edit link|When editing|</pre>
</div>
<div title="Link Variations" created="201701242104" modified="201911231541" modifier="YourName" changecount="42" parenttitle="​Reference">
<pre>|Code|Demo|h
|{{{[[Web link to Startpage|https://www.startpage.com]]}}}|[[Web link to Startpage|https://www.startpage.com]]|
|{{{[[Internal link to another wiki page|Syntax Examples]]}}}|[[Internal link to another wiki page|Syntax Examples]]|
|{{{[[Internal link to another wiki page's headline|Syntax Examples##Links &amp; Stylings]]}}}|[[Internal link to another wiki page's headline|Syntax Examples##Links &amp; Stylings]]|
|{{{[[Internal link to a non existing wiki page|IDoNotExist]]}}}|[[Internal link to a non existing wiki page|IDoNotExist]]|
|{{{[[Labeled Local link to Head 1|##Head 1]]}}}|[[Labeled Local link to Head 1|##Head 1]]|
|{{{Local link to [[##Head 2]]}}}|Local link to [[##Head 2]]|
|{{{[[Local link to table cell B1|##TableCell B1]]}}}|[[Local link to table cell B1|##TableCell B1]]|
|{{{[[Local link to table cell C3|##TableCell C3]]}}}|[[Local link to table cell C3|##TableCell C3]]|
|{{{[[Local link to a named anchor|##MyAnchorName]]}}}|[[Local link to a named anchor|##MyAnchorName]]|
|{{{[img[This is the image tip|Files/Bars.svg][##Head 1]]}}}|[img[This is the image tip|index-Files/Bars.svg][##Head 1]]|
|{{{[img[This is the image tip|Files/Bars.svg][https://startpage.com]]}}}|[img[This is the image tip|index-Files/Bars.svg][https://startpage.com]]|

!Head 1

Some dummy text.

!!Head 2

Some dummy text.

|TableCell A1|TableCell A2|TableCell A3|
|TableCell B1|TableCell B2|TableCell B3|
|TableCell C1|TableCell C2|TableCell C3|

Some dummy text.

Demo code, directly followed by it's output:

{{{
&lt;&lt;anchor 'MyAnchorName' 'Here is an explicite anchor'&gt;&gt; followed by some regular text.
}}}

&lt;&lt;anchor 'MyAnchorName' 'Here is an explicite anchor'&gt;&gt; followed by some regular text.

Some dummy text.
</pre>
</div>
<div title="Syntax Examples" created="201208271404" modified="201912011414" modifier="YourName" changecount="51" parenttitle="​Reference">
<pre>!Headings

{{{
!Heading1
!!Heading2
!!!Heading3
!!!!Heading4
!!!!!Heading5
!!!!!!Heading6 (becomes invisible, used only as section marker)
}}}

!Heading1
!!Heading2
!!!Heading3
!!!!Heading4
!!!!!Heading5
!!!!!!Heading6

!Lists

{{{
*Bullet list
**Bullet list
***Bullet list&lt;br&gt;with line break
***Bullet list same level
****Bullet list

#Numbered list
##Numbered list
###Numbered list
####Numbered list
}}}

*Bullet list
**Bullet list
***Bullet list&lt;br&gt;with line break
***Bullet list same level
****Bullet list

#Numbered list
##Numbered list
###Numbered list
####Numbered list

!Tables

&lt;html&gt;&lt;pre&gt;
|table|table| centered header |h
|table|table|left aligned text is default|
|table|table| right|
|table|table| centered |

{{dualColorTable{
|Foo ▸&amp;lt;br&amp;gt;▾ Bar|This|That|h
|Ding|Cell Content|Cell Content|
|Batz|Cell Content|Cell Content|
}}}&lt;/pre&gt;&lt;/html&gt;

|table|table| centered header |h
|table|table|left aligned text is default|
|table|table| right|
|table|table| centered |

{{dualColorTable{
|Foo ▸&lt;br&gt;▾ Bar|This|That|h
|Ding|Cell Content|Cell Content|
|Batz|Cell Content|Cell Content|
}}}

!Links &amp; Stylings

&lt;html&gt;&lt;pre&gt;
Regular Text with @@highlighted@@ part.

Link to wiki page with title [[Syntax Reference]]

Web-link to [[Startpage|https://www.startpage.com]]

{{notice{
This is an explicite notice which will be decorated with a symbol and khaki background color.
Line breaks are possible.
}}}

{{TODO{Marks an unfinished part of an article}}}
&lt;/pre&gt;&lt;/html&gt;

Regular Text with @@highlighted@@ part.

Link to wiki page with title [[Syntax Reference]]

Web-link to [[Startpage|https://www.startpage.com]]

{{notice{
This is an explicite notice which will be decorated with a symbol and khaki background color.
Line breaks are possible.
}}}

{{TODO{Marks an unfinished part of an article}}}

!Pre-Formatted Text

&lt;html&gt;&lt;pre&gt;
Some text with a {{{code snippet}}} in the middle.

{{{
Code-Block
  Code-Block with 2 leading spaces
	Code-Block with 1 leading tab
Code-Block
}}}&lt;/pre&gt;&lt;/html&gt;

Some text with a {{{code snippet}}} in the middle

{{{
Code-Block
  Code-Block with 2 leading spaces
	Code-Block with 1 leading tab
Code-Block
}}}

!Quoted Blocks

{{{
&lt;&lt;&lt;
Several lines of blockquoted text.
Several lines of blockquoted text.
&lt;&lt;&lt;

&gt; If you want to create nested blockquotes,
&gt; you'll have to mark every single line.
&gt;&gt; Bla
&gt;&gt;&gt; Bla
}}}

&lt;&lt;&lt;
Several lines of blockquoted text.
Several lines of blockquoted text.
&lt;&lt;&lt;

&gt; If you want to create nested blockquotes,
&gt; you'll have to mark every single line.
&gt;&gt; Bla
&gt;&gt;&gt; Bla
</pre>
</div>
<div title="Syntax Reference" created="201208280946" modified="202001260754" modifier="Anonymous" changecount="50" parenttitle="​Reference">
<pre>|Headings|Lists|Lists|Formatting|Code|h
|{{{!Heading 1}}}&lt;br&gt;{{{!!Heading 2}}}&lt;br&gt;{{{!!!Heading 3}}}|{{{*Unordered 1}}}&lt;br&gt;{{{**Unordered 2}}}&lt;br&gt;{{{***Unordered 3}}}|{{{#Ordered 1}}}&lt;br&gt;{{{##Ordered 2}}}&lt;br&gt;{{{###Ordered 3}}}|{{{''Bold text''}}}&lt;br&gt;{{{//Italic text//}}}&lt;br&gt;{{{--Strikethrough text--}}}&lt;br&gt;{{{@@Highlighted text@@}}}&lt;br&gt;{{{{{notice{Your notice text.}}}}}}&lt;br&gt;{{{@@css:value;css:value;text@@}}}&lt;br&gt;{{{{{class{styled text}}}}}}|&lt;html&gt;&lt;code&gt;{{{Monospaced text}}}&lt;/code&gt;&lt;/html&gt;&lt;br&gt;&quot;&quot;&quot;{{{&quot;&quot;&quot;&lt;br&gt;{{{ Code Block}}}&lt;br&gt;&quot;&quot;&quot;}}}&quot;&quot;&quot;|

|Tables|Linking &amp; Embedding|Escaping|h
|{{{|Table caption|c}}}&lt;br&gt;{{{|Heading 1|Heading 2|h}}}&lt;br&gt;{{{|Table|Footer|f}}}&lt;br&gt;{{{|!Heading 1|!Heading 2|}}}&lt;br&gt;{{{| Centered |cell|}}}&lt;br&gt;{{{|Left-Aligned |cell|}}}&lt;br&gt;{{{| Right-Aligned|cell|}}}&lt;br&gt;{{{|bgcolor(blue):Coloured|cell|}}}&lt;br&gt;{{{|&gt;|Colspan cell|}}}&lt;br&gt;{{{|Rowspan|cells|}}}&lt;br&gt;{{{|~|~|}}}|{{{[[PageTitle]]}}}&lt;br&gt;{{{[[Label|PageTitle]]}}}&lt;br&gt;{{{[[Label|##PageElement]]}}}&lt;br&gt;{{{[[Label|PageTitle##PageElement]]}}}&lt;br&gt;{{{[[Label|https://foo.com]]}}}&lt;br&gt;{{{[img[Label|LocalFileName.png]]}}}&lt;br&gt;{{{[img[Label|LocalFileName.png][PageTitle]]}}}&lt;br&gt;{{{[img[Label|LocalFileName.png][https://foo.com]]}}}|{{{&lt;br&gt;}}} - Line Break&lt;br&gt;{{{&quot;&quot;&quot;Escaped Text&quot;&quot;&quot;}}}&lt;br&gt;{{{/%Invisible Comment%/}}}&lt;br&gt;{{{&lt;html&gt;Raw HTML&lt;/html&gt;}}}|





</pre>
</div>
<div title="SystemSettings" created="201912221052" modified="201912221052" modifier="Anonymous" changecount="3">
<pre>txtUserName: Anonymous
txtWikiTitle: VodiWiki
</pre>
</div>
<div title="Unicode Collection" created="201907110746" modified="201909151030" modifier="YourName" changecount="123" parenttitle="​Reference">
<pre>!Spaces

|NBSP|1 EM|½ EM|0 EM|Marker|
|&amp;nbsp;| | |​|␣|
!!!!!Double click cell to copy

!Arrows

|&gt;|&gt;|&gt;|&gt;|Regular||&gt;|&gt;|&gt;|&gt;|Triangle Head||&gt;|&gt;|&gt;|&gt;|Black||&gt;|&gt;|&gt;|&gt;|White|
|←|→|↖|↗|↔|~|⭠|⭢|⭦|⭧|⭤ |~|⬅|➡|⬉|⬈|⬌|~|⇦|⇨|⬁|⬀|⬄|
|↑|↓|↙|↘|↕|~|⭡|⭣|⭩|⭨|⭥|~|⬆|⬇|⬋|⬊|⬍|~|⇧|⇩|⬃|⬂|⇳|
|⇇|⇉|⇆|⇄|⤡|~|⮄|⮆|⮀|⮂||~||||||~|⇐|⇒|⇖|⇗|⇔|
|⇈|⇊|⇅|⇵|⤢|~|⮅|⮇|⮁|⮃||~||||||~|⇑|⇓|⇙|⇘|⇕|
|↱|↰|⬐|⬎||~|⮣|⮢|⮦|⮧||~|⮫|⮪|⮮|⮯||~|⮳|⮲|⮶|⮷||
|↳|↲|⬑|⬏||~|⮡|⮠|⮤|⮥||~|⮩|⮨|⮬ |⮭||~|⮱|⮰|⮴|⮵||
|⇤|⇥|⇱||↹|~|⭰|⭲|⭶|⭷|⭾|~||||||~|⇽|⇾|||⇿|
|⤒|⤓||⇲|↨|~|⭱|⭳|⭹|⭸|⭿|~||||||~||||||
|⇠|⇢||||~|⭪|⭬ |⮌|⮎||~||||||~||||||
|⇡|⇣||||~|⭫|⭭|⮍|⮏||~||||||~||||||

|↤|↦|↥|↧|⍇|⍈|⍐|⍗||⟵|⟶|⟷|⟻|⟼|⬳|⟿|
|⬸|⤑|⤌|⤍|⤎|⤏|⤝|⤞|~|⟸|⟹|⟺|⟽|⟾|||

|⤶|⤷|⤴|⤵|⟲|⟳|↺|↻|🗘|⮔|↵|↯|⚡|
|↩|↪|↶|↷|⥀|⥁|🔄|🔁|🔃||⏎|⭍||

|◀|▶|▲|▼|◢|◣|◥|◤|◄|►|≺|≻|∧|∨|⋖|⋗|⌲|⸢|⸣|⸝|⸜|◜|◝|
|◁|▷|△|▽|◿|◺|◹|◸|◅|▻|⮜|⮞|⮝|⮟|≪|≫|◬|⸤|⸥|⸌|⸍|◟|◞|
|◂|▸|▴|▾|◃|▹|▵|▿||⌳|⮘|⮚|⮙|⮛|⋘|⋙|⌵|⌈|⌉|「|」|◠|
|||||||||||⍃|⍄|⍓|⍌|〈|〉||⌊|⌋|『|』|◡|

!UI Widgets

|🗔|🗕|🗖|🗗|🗙|⨯|⌵|☰|…|⋮|⌂|🏠|⚙|⛭|⏣|⚒|✎|🖉|
|📄|📂|💾|✂|🗐|📋|↶|↷|👤|👥|🝖|🔎|⎗|⎘|🗑|
|💾| 📁|📂|📁|📂|🖿|🗀|🗁|🖴|🖧|🗄|🗜|
|📄|📃|📜|🗆|🗅|🗌|🗋|🗉|🗈|🗏|🗎|🖹|🗇|🗊|🗍|🗐|
|🗒|🗓|📝|📋|📛|🗟|🖺|🖻|🖼|🖽|🖾|
|💻|🖳|🖵|🖥|⌨|🖮|⎙|🗑|
|🛈|⚠|⮿|🅧|☐|☑|☒|⚪|🔘|🗸|✓|✔|
|⚓|🔗|🔒|🔓|🔏|🔐|⚿|🔑|🗝|🌍|🌐|
|🗢|🗣|🗨|💬|🗪|🗫|🗬|🗭|🗮|🗯|🗰|💭|

!Abstract

|·|•|⚉|⚫|●|⬤|◦|⚬|⚪|○|○|◯|☉|⚇|⊙|⊚|⦾|⦿|⊛|⊝|⊜|⊕|⊖|⊗|⊘|◌|◍|◎|◖|◗|⯊|⯋|
|Ⓞ|①|②|③|④|⑤|⑥|⑦|⑧|⑨|⑩|♾|
|▪|◾|◼|■|⬛|▫|◽|◻|□|⬜|🔲|🔳|🖵|⛶|⛚|⊞|⊟|⊠|⊡|▣|⛋|🝙|🝚|▍|
|◆|⋄|◇|⎔|⬟|⬢|⬣|🔶|🔷|🔸|🔹|◈|⟐|💠|🞡|🞢|🞣|🞤|🞥|🞦|🞧|✙|✚|✛|✜|
|⿰|⿱|⿳|⿲|⿴|⿵|⿶|⿷|⿸|⿹|⿺|⿻|▤|▥|▦|⩩|⫵|
|☷|☰|≡|≣|⌯|⚌|⚏|𝌮|𝌀|𝌅|𝍖|𝌠|𝍔|𝌞|⠸|⠇|⡆|⠐|⠒|⠛|⠤|⠨|⠭|⠶|⠿|⣿|…|⋮|⋮|⋯|⋰|⋱|﹍|
|⑅|⑀|⑁|⑂|⑃|⑄|🝗|🝘|🜙|⊶|⊷|⊸|⚯|🜺|🝓|🝢|☍|☌|🝯|🝰|☊|☋|⎌|⚮|⚭|🝆|⚲|🜣|⟟|⫱|🜽|⍝|⊍|
|⎎|⏍|⍞|⍠|⎕|⎄|⎅|␣|⌴|⍽|⎍|⌶|⏙|⟝|⟞|⊢|⊣|⊤|⊥|⟛|⧿|ꕯ|⥐|

!Emoticons

¯ \ _ (ツ) _ / ¯
|ꙭ|Ꙭ|👀|💩|💣|💤|👑|🜲|
|😃|😢|👍|👎|🖕|❤️|💀|🕱|
|🖖|👽|👾|⍾|🜶|🜸|☄|🕳|

!Web Links

*[[Name Search|https://unicode-search.net/unicode-namesearch.pl]]
*[[Shape Catcher|http://shapecatcher.com]]
*[[Spaces|http://jkorpela.fi/chars/spaces.html]]
*[[Xah Lee|http://xahlee.info/comp/unicode_index.html]]
*File Format Info
**[[Arrows|https://www.fileformat.info/info/unicode/block/arrows/utf8test.htm]], [[Misc|http://www.fileformat.info/info/unicode/block/miscellaneous_symbols_and_arrows/utf8test.htm]], [[Supplemental A|https://www.fileformat.info/info/unicode/block/supplemental_arrows_a/utf8test.htm]], [[Supplemental B|https://www.fileformat.info/info/unicode/block/supplemental_arrows_b/utf8test.htm]], [[Supplemental C|https://www.fileformat.info/info/unicode/block/supplemental_arrows_c/utf8test.htm]]
**[[Box Drawing|https://www.fileformat.info/info/unicode/block/box_drawing/utf8test.htm]]
**[[Dingbats|https://www.fileformat.info/info/unicode/block/dingbats/utf8test.htm]]
**[[Enclosed Alphanumerics|http://www.fileformat.info/info/unicode/block/enclosed_alphanumerics/utf8test.htm]], [[Supplement|http://www.fileformat.info/info/unicode/block/enclosed_alphanumeric_supplement/utf8test.htm]]
**[[Geometric Shapes|https://www.fileformat.info/info/unicode/block/geometric_shapes/utf8test.htm]]
**[[Mathematical Operators|http://www.fileformat.info/info/unicode/block/mathematical_operators/utf8test.htm]]
**[[Technical|https://www.fileformat.info/info/unicode/block/miscellaneous_technical/utf8test.htm]]
**[[Symbols|http://www.fileformat.info/info/unicode/block/miscellaneous_symbols/utf8test.htm]], [[Pictographs|http://www.fileformat.info/info/unicode/block/miscellaneous_symbols_and_pictographs/utf8test.htm]], [[Transport|http://www.fileformat.info/info/unicode/block/transport_and_map_symbols/utf8test.htm]], [[Supplemental|https://www.fileformat.info/info/unicode/block/supplemental_symbols_and_pictographs/utf8test.htm]], [[Other|https://www.fileformat.info/info/unicode/category/So/list.htm]]
</pre>
</div>
<div title="Updating the Viewer" created="202001252100" modified="202001252110" modifier="Anonymous" changecount="3" parenttitle="​Advanced Use Cases">
<pre>! How To

* The viewer and editor can be updated via the backstage area (unhide by clicking ⌵ at the upper right)
* Choose &quot;About / Upgrade&quot;
* The updater will save an updated HTML file preserving your content

! Major Updates

* Major updates will only happen, if the content would need to be migrated due to internal changes
* In this case, you cannot skip major versions, e.g. from 1.x.x to 3.x.x
* You would need to update twice, from 1.x.x to 2.x.x to 3.xx
* This is because the content will be migrated between the major versions
</pre>
</div>
<div title="`VodiConfigPlugin" created="201208271031" modified="201702011759" modifier="YourName" changecount="24">
<pre>/***
|''Name:''|VodiConfigPlugin|
|''Version:''|2016.01.08|
|''Description:''|Configures the core and 3rd party plugins|
|''Requires:''|TagsTreePlugin YourSearchPlugin|
!Code
***/
//{{{
	// nix.
//}}}
</pre>
</div>
<div title="​Advanced Use Cases" created="201906080756" modified="201906080757" modifier="YourName" changecount="1">
<pre></pre>
</div>
<div title="​Reference" created="201906080803" modified="201906080807" modifier="YourName" changecount="8">
<pre></pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->

<!--POST-BODY-END-->
<!-- Begin Namespace Imported -->
<script src="CopyAndPaste/CopyAndPaste.js"></script>
<script src="Data/Data.js"></script>
<script src="Data/Tiddler.js"></script>
<script src="Data/ArticleStore.js"></script>
<script src="Data/FileImporter.js"></script>
<script src="Engine/Config.js"></script>
<script src="Engine/Engine.js"></script>
<script src="Engine/JQuery.js"></script>
<script src="FileSystem/FileSystem.js"></script>
<script src="Importing/ImporterUi.js"></script>
<script src="Networking/Networking.js"></script>
<script src="PluginSystem/PluginEngine.js"></script>
<script src="PluginSystem/PluginUi.js"></script>
<script src="UI/Backstage.js"></script>
<script src="UI/Story.js"></script>
<script src="UI/UI.js"></script>
<script src="Updating/UpdaterUi.js"></script>
<script src="Saving/Saving.js"></script>
<!-- End Namespace Imported -->
<script id="jsArea" type="text/javascript">
//<![CDATA[

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.tasks, {
	save: {text: "File", tooltip: "New, Save, ...", content: '<<fileTasks>>'},
	importTask: {text: "Import", tooltip: "Import content and plugins from other wiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "Tweak", tooltip: "Tweak some options", content: '<<options>>'},
	upgrade: {text: "About / Upgrade", tooltip: "Upgrade integrated viewer and editor", content: '<<upgrade>>'},
	plugins: {text: "Plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc, {
	chkAutoSave: "Automatically save changes",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",	
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	txtBackupFolder: "Name of folder to use for backups",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtTheme: "Name of the theme to use",
	txtUserName: "Username for signing your edits",
	txtWikiTitle: "The title of the wiki (used as window title)."
});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this Wiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#Download for details",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your Wiki file contains illegal characters\n- the Wiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid Wiki",
	emptySaved: "Empty Wiki created in your download location.",
	emptyFailed: "Failed to create empty Wiki file",
	mainSaved: "Wiki saved.",
	mainDownloadManual: "RIGHT CLICK HERE to download/save main Wiki file",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in Wiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in Wiki. If you continue you will lose those changes\n\n--------------------------------",
	unsupportedTWFormat: "Unsupported Wiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	invalidCookie: "Invalid cookie '%0'"
});

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th","th","th","th","th","th","th","th","th","th","th","st","nd","rd","th","th","th","th","th","th","th","st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	tooltip: "Show tiddlers tagged with '%0'",	
	popupNone: "No other tiddlers tagged with '%0'"
});

merge(config.views.wikified,{
	defaultText: "The article '%0' doesn't yet exist. Click 'Edit' to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"
});

merge(config.views.editor,{
	tagHint: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing "
});

merge(config.views.editor.tagChooser,{
	text: "Tags",
	hint: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"
});

merge(config.messages,{
	sizeTemplates: [
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
	]
});

merge(config.macros.timeline, {
	dateFormat: "DD MMM YYYY"
});

merge(config.macros.allTags, {
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"
});

merge(config.macros.saveChanges, {
	label: "save changes",
	hint: "Save all articles to create a new Wiki",
	accessKey: "S"
});

config.macros.fileTasks = {};

config.macros.fileTasks.handler = function(place, macroName, params, wikifier, paramString) { // Implements IMacroResolver.handler()
	renderTiddlyButton(place, "New", "Create and save an empty wiki file.", function(e){createEmptyWikiAction();}, null, null, null, null, "📄")
	renderTiddlyButton(place, "Save", "Automatically find the best save method.", function(e){saveChangesAction();}, null, null, null, null, "💾")
	renderTiddlyButton(place, "Save Manually...", "Create a download link (in case normal saving doesn't work).", function(e){saveChangesAction(true);}, null, null, null, null, "⤓")
}

merge(config.macros.options, {
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in the wiki file itself.",
	step1Html: "<input id='chkUnknown' name='chkUnknown' type='checkbox' checked='false'/><label for='chkUnknown'>Show undocumented options</label><br/><input type='hidden' name='listViewPlaceholder'/>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Name', field: 'name', title: "Name", type: 'String'},
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'}
		],
		rowClasses: []
	}
});

merge(config.macros.toolbar,{
	moreLabel: "…",
	morePrompt: "Show additional commands",
	lessLabel: "«",
	lessPrompt: "Hide additional commands",
	separator: "|"
});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	hint: "Redraw the entire Wiki display"
});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only Wiki file. Try opening it from a file:// URL",
	wizardTitle: "Import articles from another wiki file",
	step1Title: "Step 1: Locate the file",
	step1Html: "<input type='file' size=50 name='choseFileButton'>",
	openLabel: "Inspect...",
	openPrompt: "List up the articles of the chosen wiki.",
	cancelLabel: "Cancel",
	cancelPrompt: "Cancel this import",
	statusRetrievingArticleList: "Retrieving the list of available articles",
	errorRetrievingArticleListFromFile: "Error retrieving article list from local file!",
	step2Title: "Step 2: Choose the Articles to import",
	step2Html: "<input type='hidden' name='listViewPlaceholder'></input>",
	importLabel: "Import",
	importPrompt: "Import these Articles",
	confirmOverwriteText: "Are you sure you want to overwrite these Articles:\n\n%0",
	step3Title: "Step 3: Importing %0 article(s)",
	step3Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "Done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing articles",
	statusDoneImport: "All articles imported",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Title", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
		],
		rowClasses: []
	}		
});

merge(config.macros.upgrade,{
	wizardTitle: "VodiWiki",
	step1Title: "About",
	step1Html:
		"VodiWiki is a single page application developed and maintained by Mark Vodicka (<a href='http://www.vodi.de/VodiWiki/' target='_blank'>www.vodi.de</a>).<br/>" +
		"It contains parts of Jeremy Ruston's TiddlyWiki, abego Software's YourSearchPlugin.<br/><br/>" +
		"<h1>License</h1><span macro=\"licenseText\"></span><br/><br/>" +
		"<h1>Check for Upgrade (This Version: <span macro=\"version\"></span>)</h1>" +
		"Hitting the button will check for an update of the integrated viewer and editor.<br/>"+
		"Your content will be preserved.<br/>"+
	  "(Update source: <a href='%0' class='externalLink' target='_blank'>%0</a>).",	
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm",
	step2Html_downgrade: "You are about to downgrade to Wiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This Wiki appears to be already using the latest version of the core code (%0).<br><br>You can try to reload the core anyway - in case you damaged s.th. by editing the html file directly.",
	step2Html_upgrade: "You are about to upgrade to Wiki version %0 from %1",
	upgradeLabel: "Check...",
	upgradePrompt: "Prepare for the upgrade process",
	statusRetrievingUpdate: "Retrieving update...",
	errorLoadingCore: "Error retrieving update!",
	errorCoreFormat: "Error with the recieved update code!",
	statusSavingCore: "Saving the updated wiki",
	statusUpdateSaved: "The updated wiki has been saved to your download location.",
	startLabel: "Upgrade Now",
	startPrompt: "Start the upgrade process",
	cancelLabel: "Cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
});

merge(config.commands.editTiddler,{
	text: "✎ Edit",
	tooltip: "Edit This Article\n[Ctrl - Enter]",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this article"
});

merge(config.commands.saveTiddler,{
	text: "✔ Done",
	tooltip: "Save changes to this article\n[Ctrl - Enter]"
});

merge(config.commands.cancelTiddler,{
	text: "⨯ Cancel",
	tooltip: "Undo Changes to This Article",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this article normally"
});

merge(config.commands.deleteTiddler,{
	text: "🗙 Delete",
	tooltip: "Delete This Article",
	warning: "Are you sure you want to delete '%0'?"
});

merge(config.commands.permalink,{
	text: "Permalink",
	tooltip: "Permalink for this article"
});

merge(config.commands.references,{
	text: "➷ References",
	tooltip: "Show article that link to this one",
	popupNone: "No references"
});

merge(config.commands.jump,{
	text: "Jump",
	tooltip: "Jump to another open article"
});

merge(config.commands.fields,{
	text: "Fields",
	tooltip: "Show the extended fields of this article",
	emptyText: "There are no extended fields for this article",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
		],
		rowClasses: [],
		buttons: []
	}
});

merge(config.shadowTiddlers,{
	SiteUrl: "",
	SideBarTabs: '<<tabs sideBarTabSet "Missing" "Missing links & pages" TabMoreMissing "Tags" "All tags" TabTags "Resources" "Images And Stuff" TabResources>>'
});

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // Article entities in-memory storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo, tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file is being viewed locally
window.isLocal = function() {
	return (document.location.protocol == "file:");
}

if (!window || !window.console) {
	console = {tiddlywiki: true, log: function(message) {displayMessage(message);}};
}

// Starting up
function main() {
	window.originalHTML = recreateOriginal();
	// todo hier wird ein riesen snapshot gemacht - stattdessen sollte recreateOriginal() so gepimpt werden, dass auch später dynamisch befüllte interne DIVs ALLE geleert werden!
	
	startingUp = true;
	// var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) {if (window.confirmExit) return confirmExit();};
	
	// process the right part of an url after a hash sign
	if (window.location.hash) params = decodeURIComponent(window.location.hash.substr(1));	
	if (params)	params = params.parseParams("open", null, false);
		
	store = new ArticleStore({config: config});
		
	story = new Story("tiddlerDisplay");
	
	document.addEventListener("click", Popup.onDocumentClick, false);
	
	saveTest();
	var s;
	for (s = 0; s < config.notifyTiddlers.length; s++) {
		store.addNotification(config.notifyTiddlers[s].name, config.notifyTiddlers[s].notify);
	}

	loadBuiltInArticlesFromHtmlIntoJsDictionary();	

	store.loadFromDiv("storeArea", true);
	
	loadOptions();
	
	readOnly = window.isLocal() ? false : config.options.chkHttpReadOnly;
	
	var pluginProblem = loadPlugins();

	formatter = new Formatter(config.formatters);
	
	var m;
	for (m in config.macros) {
		if (config.macros[m].init)
			config.macros[m].init();
	}
	
	store.notifyAll();
	
	restart();
	refreshDisplay();
	
	if (pluginProblem) {
		story.showArticle("PluginManager");
		displayMessage(config.messages.customConfigError);
	}	
	backstage.init();
		
	startingUp = false;
	// doc.trigger("startup");
}

//--
//-- Paramifiers
//--

function invokeParamifier(params, handler) {
	if (! params || params.length == undefined || params.length <= 1)
		return;
	var i;
	for (i = 1; i < params.length; i++) {
		var p = config.paramifiers[params[i].name];
		if (p && p[handler] instanceof Function)
			p[handler](params[i].value);
		else {
			var h = config.optionHandlers[params[i].name.substr(0,3)];
			if (h && h.set instanceof Function)
				h.set(params[i].name, params[i].value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.open = {
	onstart: function(title) {
		if (! readOnly || store.tiddlerExists(title) || isShadowTiddler(title))	story.showArticle(title);
	}
};

//--
//-- Formatter helpers
//--

function Formatter(formatters) {
	var n;
	this.formatters = [];
	var pattern = [];
	for (n = 0; n < formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"), "mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)	{
		w.subWikifyTerm(createTiddlyElement(w.output, this.element), this.termRegExp);
	},

	inlineCssHelper: function(w)	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while (lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if (lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if (s == "bgcolor") s = "backgroundColor";
			if (s == "float") s = "cssFloat";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)	{
		var t;
		for (t = 0; t < styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if (config.browser.isIE && (config.browser.ieVersion[1] < 10)) text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link) {

		link = link.split(config.textPrimitives.sectionSeparator)[0]; // handle internal section links (e.g. "foo##bar" => "foo" or "##bar" => "")
		
		if (!link.length || store.tiddlerExists(link) || isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern, "mg");
		if (urlRegExp.exec(link)) {
			return true;
		}
		if (link.indexOf(".") != -1 || link.indexOf("\\") != -1 || link.indexOf("/") != -1 || link.indexOf("#") != -1) {
			return true;
		}
		return false;
	}

};

function resolveImageSource(unresolved){
	if (! unresolved || unresolved.indexOf('/') > -1)	return unresolved;	
	var blobArticle = store.getArticle(unresolved);
	if (! blobArticle) return "./%0-Files/%1".format([getFileName(document.location.toString(), true), unresolved]);	
	return blobArticle.text;
}

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w) {
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		var onmouseover = function() {jQuery(this).addClass("hoverRow");};
		var onmouseout = function() {jQuery(this).removeClass("hoverRow");};
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while (lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if (nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if (nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if (currRowType == "c") {
					// Caption
					w.nextMatch++;
					if (rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,rowCount%2?"oddRow":"evenRow");
					theRow.onmouseover = onmouseover;
					theRow.onmouseout = onmouseout;
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns) {
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while (cellMatch && cellMatch.index == w.nextMatch) {
			if (cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if (last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
					if (colSpanCount > 1) {
						last.element.setAttribute("colspan",colSpanCount);
						last.element.setAttribute("colSpan",colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if (cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if (cellMatch[2]) {
				// End of row
				if (prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while (chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if (chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if (colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if (w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if (spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w) {
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w) {
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while (lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if (lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if (lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if (lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if (lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if (!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if (listLevel > currLevel) {
				for (t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target, listType));
				}
			} else if (listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if (listLevel < currLevel) {
				for (t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if (listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w) {
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t, matched;
		do {
			if (newLevel > currLevel) {
				for (t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if (newLevel < currLevel) {
				for (t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if (matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while (matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?|<hr ?/?>\\n?",
	handler: function(w) {
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w) {
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w) {
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var linkElement;
			var text = lookaheadMatch[1];
			if (lookaheadMatch[3]) { // Pretty bracketted link
				var link = lookaheadMatch[3];
				linkElement = (! lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link))
					? renderExternalLink(w.output, link) 
					: renderLinkElement(w.output, link, false, null, w.isStatic)
				;
			} else {
				// Simple bracketted link
				linkElement = renderLinkElement(w.output, text, false, null, w.isStatic);
			}
			if (text.substring(0, 2) == config.textPrimitives.sectionSeparator) text = text.substring(2); // remove leading "##" of local section links.
			createTiddlyText(linkElement, text); // before, the linkElement has been rendered without innerHtml. We've now inserted the text as innerHtml.
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w) {
		w.outputText(renderExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if (lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = (
					config.formatterHelpers.isExternalLink(link) ?
					renderExternalLink(w.output, link) :
					renderLinkElement(w.output, link, false, null, w.isStatic, w.tiddler)
				);
				jQuery(e).addClass("imageLink");
			}
			var img = createTiddlyElement(e, "img");
			if (lookaheadMatch[1])
				img.align = "left";
			else if (lookaheadMatch[2])
				img.align = "right";
			if (lookaheadMatch[3]) img.title = lookaheadMatch[3];
			img.src = resolveImageSource(lookaheadMatch[4]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output, "span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w) {
		switch (w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w) {
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if (styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if (lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w) {
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w) {
		createTiddlyElement(w.output, "br");
	}
},

{
	name: "rawText",
	match: "\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w) {
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if (lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w) {
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler, format) {
	if (tiddler) {
		if (! format)
			format = tiddler.fields["wikiformat"];
		var i;
		if (format) {
			for (i in config.parsers) {
				if (format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for (i in config.parsers) {
				if (tiddler.isTagged(config.parsers[i].formatTag)) return config.parsers[i];
			}
		}
	}
	return formatter;
}

function Wikifier(wikiSyntaxText, formatter, highlightRegExp, tiddler) {
	this.source = wikiSyntaxText;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if (highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(wikiSyntaxText);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function() {
	var e = createTiddlyElement(document.body, "div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(targetDomElement, terminator) {
	try {
		if (terminator) //# Handle the terminated and unterminated cases separately, this speeds up wikifikation by about 30%
			this.subWikifyTerm(targetDomElement, new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(targetDomElement);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(targetElement) {
	var oldOutput = this.output; //# subWikify can be indirectly recursive, so we need to save the old output pointer
	this.output = targetElement;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;//# Get the first match
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while (formatterMatch) {
		// Output any text before the match
		if (formatterMatch.index > this.nextMatch)
			this.outputText(this.output, this.nextMatch, formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		//# Figure out which formatter matched and call its handler
		var t;
		for (t = 1; t < formatterMatch.length; t++) {
			if (formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		//# Get the next match
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	//# Output any text after the last match
	if (this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	//# Restore the output pointer
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output, terminatorRegExp) {
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while (terminatorMatch || formatterMatch) {
		if (terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if (terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if (formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		var t;
		for (t=1; t<formatterMatch.length; t++) {
			if (formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if (this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place, startPos, endPos) {
	while (this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if (this.highlightMatch.index > startPos) {
			createTiddlyText(place, this.source.substring(startPos, this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if (startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if (startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

function wikify(wikiSyntaxText, targetDomElement, highlightRegExp, tiddler) {
	if (wikiSyntaxText) {
		var wikifier = new Wikifier(wikiSyntaxText, getParser(tiddler), highlightRegExp, tiddler);		
		wikifier.subWikify(targetDomElement);	
	}
}

function wikifyPlainText(text,limit,tiddler) {
	if (limit > 0) text = text.substr(0, limit);
	var wikifier = new Wikifier(text, formatter, null, tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler) {
	if (source) {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

//--
//-- Macro definitions
//--

/**
	* @typedef {Object} IMacroResolver
	*
	* A Module that will be called (IOC by invokeMacro()) when a macro (like "<<toolbar +saveTiddler -cancelTiddler deleteTiddler>>") is resolved.
	* The name of the actual implementation must match the macro name.
	*
	* @property {function} handler - The actual resolving function, that should render stuff into "place"	
*/

/**
	* IMacroResolver.handler()
	*
	* @param {element}  place               - The target dom element (toolbar div), into which a macro "handler" should render stuff.
	* @param {string}   macroName           - The name of the macro for which an implementation will be located.
	* @param {string[]} preParsedParameters - ???
	* @param {string}   wikifier            - ???
	* @param {string}   params              - Generic parameter string (cut from the macro token from the article)
	* @param {Object}   tiddler             - The currently processed article for which the macro is resolved.	
*/

/**
	* This will locate a macro module implementation (by name) and invoke it's "handler",
	* which will resolve the macro and (mostly) render stuff into the target "place" element.
	*
	* @param {element} place     - The target dom element (toolbar div), into which a macro "handler" should render stuff.
	* @param {string}  macroName - The name of the macro for which an implementation will be located.
	* @param {string}  params    - Generic parameter string that will be passed to the macro "handler".
	* @param {string}  wikifier  - Seems to be always null.	
	* @param {Object}  tiddler   - The currently processed article entity for which the macro is resolved.
*/
function invokeMacro(place, macroName, params, wikifier, tiddler) {
	try {
		var iMacroResolver = config.macros[macroName]; // Dynamically find the macro module implementation by name (VB = GetType("config.macros." + macroName))
		if (iMacroResolver && iMacroResolver.handler) { // We hope that the module implements IMacroResolver
			var articleView = story.getArticleViewByChild(place);
			window.tiddler = articleView ? store.getArticle(articleView.getArticleTitle()) : null;
			window.place = place;
			var allowEval = true;
			if (config.evaluateMacroParameters == "system") {
				if (!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			
			// Actually invoke the macro implementation's "handler" (hoping the signature would match)			
			iMacroResolver.handler(place, macroName, params.readMacroParams(! allowEval), wikifier, params, tiddler); // see IMacroResolver.handler()
			
		} else {
			createTiddlyError(place, config.messages.macroError.format([macroName]), config.messages.macroErrorDetails.format([macroName,config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place, config.messages.macroError.format([macroName]), config.messages.macroErrorDetails.format([macroName,ex.toString()]));
	}
}

config.macros.collapseArea = {	
	defaultTooltip: "Hide / Unhide"
};

config.macros.collapseArea.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	// process command line parameters	
	var elementID = params[0];
	var startHidden = (params[1] == "true");
	var tooltip = params[2] || this.defaultTooltip;
	var buttonSymbols = params[3] || "«»"
	var buttonClass = params[4] || "button collapserButton";	
	// create toggle button
	var button = renderTiddlyButton(
		place, buttonSymbols[0], tooltip,
		function() {config.macros.collapseArea.toggle(this, elementID);},
		buttonClass
	);
	button.buttonSymbols = buttonSymbols;
	
	if (startHidden == true) config.macros.collapseArea.toggle(button, elementID);
};

config.macros.collapseArea.toggle = function(sender, id) {
	var e = document.getElementById(id);
	if (e) {
		if (e.style.display != "none") {
			e.style.display = "none";
			sender.innerHTML = sender.buttonSymbols[1];
		} else {
			e.style.display = "";
			sender.innerHTML = sender.buttonSymbols[0];
		}
	}
};

config.macros.licenseText = {};

config.macros.licenseText.handler = function(place) { // Implements IMacroResolver.handler()
	var s = createTiddlyElement(place, "span", null, "licenseText");
	s.innerHTML =  document.querySelector('meta[name="copyright"]').content.lineBreaksToBr();
};

config.macros.version.handler = function(place) { // Implements IMacroResolver.handler()
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";

config.macros.list.handler = function(place, macroName, params, wikifier, paramString) { // Implements IMacroResolver.handler()
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	jQuery(list).empty().addClass("list list-" + type);
	var template = args.template ? store.getArticleTextPartOrSlice(args.template[0]) : false;
	if (!template) {
		template = config.macros.list.template;
	}
	if (this[type].hint)
		createTiddlyElement(list, "li", null, "listTitle", this[type].hint);
	var results;
	if (this[type].handler)
		results = this[type].handler(params);
	var t;
	for (t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		var tiddler = results[t];
		if (typeof(tiddler) == 'string') {
			tiddler = store.getArticle(tiddler) || new Tiddler(tiddler); // HACK: type of "tiddler" changes from string to article!
		}
		wikify(template, li, null, tiddler);
	}
	if (results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getArticlesQuickly("title");
};

config.macros.list.missing.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getOrphans();
};

config.macros.list.resources.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getResourceTitles();
};

config.macros.list.shadowed.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params) { // Implements IMacroResolver.handler()
	return store.getTouched();
};

config.macros.list.filter.handler = function(params) { // Implements IMacroResolver.handler()
	var filter = params[1];
	var results = [];
	if (filter) {
		var tiddlers = store.filterTiddlers(filter);
		for (var t = 0; t < tiddlers.length; t++) results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	var tags = store.getTags();
	var ul = createTiddlyElement(place, "ul");
	if (tags.length == 0) createTiddlyElement(ul, "li", null, "listTitle", this.noTags);
	var t;
	for (t = 0; t < tags.length; t++) {
		var title = tags[t][0];
		var classNames = buildClassNames(title);
		var li = createTiddlyElement(ul, "li");
		var btn = renderTiddlyButton(li, title + " (" + tags[t][1] + ")", this.tooltip.format([title]), onClickTag, classNames);
		btn.setAttribute("tag", title);
		btn.setAttribute("refresh", "link");
		btn.setAttribute("tiddlyLink", title);
		if (params[0]) btn.setAttribute("sortby", params[0]);
	}
};

config.macros.articleTree = {
	expand : "▹",
	collapse : "◿",
	collapsedTag : "collapsed"	
}

config.macros.articleTree.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	var id = config.macros.articleTree.getId(place);
	config.macros.articleTree.createSubTree(place, id, "", 0);
}

var firstLeaf;

config.macros.articleTree.createSubTree = function(place, id, parentTitle, level) {
	var isOpen = true;
	
	var subArticles = store.getArticlesByField('parenttitle', true, parentTitle);
	
	if (! subArticles.length) {
		if (! firstLeaf) firstLeaf = parentTitle;
		createTiddlyText(renderLinkElement(place, parentTitle, false, "leaf"), parentTitle); // leaf
		return;
	}
		
	if (parentTitle != ""){
		var parentArticle = store.getArticle(parentTitle);
		if (parentArticle.tags.contains("collapsed")) isOpen = false;

		// render branch head (row with collapser button - will stay visible even when collapsed)
		var branchElement = createTiddlyElement(place , "div", null, "branch"); 
		renderTiddlyButton(branchElement, isOpen ? this.collapse : this.expand, null, this.onClick);
		renderLinkElement(branchElement, parentTitle, true);
	}
	
	var nodesWrapper; // the (collapsible) nodes are NOT nested inside their branch, they are underneath! Otherwise collapsing would be hard to realize.
	for (var i = 0; i < subArticles.length; i++){
		var title = subArticles[i].title;
		if (! nodesWrapper){
			nodesWrapper = createTiddlyElement(place, "div", null, "nodesWrapper");
			nodesWrapper.style.display = isOpen ? "block" : "none";
		}
		this.createSubTree(nodesWrapper, id, title, level + 1); // RECURSION
	}
}

config.macros.articleTree.onClick = function(e) {
	var n = this.parentNode.nextSibling;
	var isOpen = n.style.display != "none";
	n.style.display = isOpen ? "none" : "block";
	this.firstChild.nodeValue = isOpen ? config.macros.articleTree.expand : config.macros.articleTree.collapse;
	return false;
}

config.macros.articleTree.getId = function(element) {
	while (! element.id && element.parentNode) element = element.parentNode;
	return element.id ? element.id : "<html>";
}

var macro = config.macros.timeline; // HACK

// <<timeline field maxlength dateformat template:title groupTemplate:title filter:filter>>
//
// field         - determines the field used as the basis for the list, usually "modified" or "created"
// maxlength     - an integer that limits the maximum number of tiddlers in the list
// dateformat    - a date format string
// template      - a reference to a tiddler or tiddler section used as the template for list entries
// groupTemplate - a reference to a tiddler or tiddler section used as the template for grouping entries in the list with {{{%0}}} being the name of 
//                 the field that is displayed and {{{%1}}} being a rendered date based on the date format, see parameter "dateformat" above
// filter        - a filter used to filter the tiddlers relevant for the list

merge(macro, {
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var sortBy = params[0] || "modified";
		var prefix = sortBy.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? sortBy.substr(1, sortBy.length) : sortBy;
		var dateFormat = params[2] || this.dateFormat;

		var groupTemplate = macro.groupTemplate.format(no_prefix_field, dateFormat);
		groupTemplate = args.groupTemplate ? 
			store.getArticleTextPartOrSlice(args.groupTemplate[0]) || groupTemplate :
			groupTemplate;

		var itemTemplate = macro.itemTemplate;
		itemTemplate = args.template ? store.getArticleTextPartOrSlice(args.template[0]) || itemTemplate :
			itemTemplate;

		var articles = store.getArticlesQuickly(sortBy);

		var lastGroup = "", ul;
		var last = params[1] ? articles.length-Math.min(articles.length, parseInt(params[1], 10)) : 0;
		var i;
		for (i = articles.length - 1; i >= last; i--) { // backwards => most recent on top
			var article = articles[i];
			var theGroup = wikifyPlainText(groupTemplate, 0, article);
			if (typeof(ul) == "undefined" || theGroup != lastGroup) {
				ul = document.createElement("ul");
				jQuery(ul).addClass("timeline");
				container.appendChild(ul);
				createTiddlyElement(ul, "li", null, "listTitle", theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul, "li", null, "listLink");
			wikify(itemTemplate, item, null, article);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>", 
	itemTemplate: "<<view title link>>"
});

/**
	* Renders an article (or parts of it) into another article (called "transclusion").
	* Optionally resolves placeholders like string.format() would do:
	* The included article may contain numbered placeholders like "$1, $2" which will be replaced by arguments after the keyword "with:"
	*
	* Examples: <<tiddler 'PageTitle##SectionName'>>
	*           <<tiddler [[PageTitle::SliceName]]>>
	*           <<tiddler book with: "Dan Brown" "The DaVinci Code">> => would replace "$1" by "Dan Brown" and "$2" by "The DaVinci Code"
*/
config.macros.tiddler.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if (stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length - 1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if (pos != -1) {
			title = title.substr(0, pos); // get the base tiddler title
		}
		var t = store.getArticle(title);
		if (! t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name", null, allowEval, false, true);
	var names = params[0]["name"];
	var titleAndSection = names[0]; // e.g. "foo", "foo##bar", "##bar"

	// Complete '##section' to 'thisTitle##section'
	var sep = config.textPrimitives.sectionSeparator;
	var parts = titleAndSection.split(sep);
	var title = parts[0];
	var sectionName = parts[1];
	if (sectionName) sectionName = sectionName.trim();
	if ((! title.length) && sectionName) {
		var articleView = story.getArticleViewByChild(place);
		title = articleView ? articleView.getAttribute('tiddler') : tiddler ? tiddler.title : '';
		titleAndSection = title + sep + sectionName;
	}

	var className = names[1] || null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place, "span", null, className, null, {
		refresh: "content", tiddler: titleAndSection
	});
	if (args !== undefined)
		wrapper.setAttribute("args", "[[" + args.join("]] [[") + "]]");
	this.transclude(wrapper, titleAndSection, args);
};

config.macros.tiddler.transclude = function(wrapper, titleAndSection, args) {
	var text = store.getArticleTextPartOrSlice(titleAndSection);
	if (! text)
		return;
	var stack = config.macros.tiddler.tiddlerStack;
	if (stack.indexOf(titleAndSection) !== -1)
		return;
	stack.push(titleAndSection);
	try {
		if (typeof args == "string")
			args = args.readBracketedList();
		var n = args ? Math.min(args.length, 9) : 0;
		for (var i = 0; i < n; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
			text = text.replace(placeholderRE, args[i]);
		}
		config.macros.tiddler.renderText(wrapper, text, titleAndSection);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place, text, title) {
	wikify(text, place, null, store.getArticle(title));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	var btn = createTagButton(place, params[0], null, params[1], params[2]);
	if (params[3]) {
		btn.setAttribute('sortby', params[3]);
	}
};

config.macros.tags.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	params = paramString.parseParams("anon", null, true, false, false);
	var ul = createTiddlyElement(place, "ul");
	var title = getParam(params, "anon", "");
	if (title && store.tiddlerExists(title)) tiddler = store.getArticle(title);
	var sep = getParam(params, "sep", " ");
	var lingo = config.views.wikified.tag;
	var label = null;
	var t;
	for (t = 0; t < tiddler.tags.length; t++) {		
		if (! label) label = createTiddlyElement(ul, "li", null, "listTitle", lingo.labelTags.format([tiddler.title]));
		createTagButton(createTiddlyElement(ul, "li"), tiddler.tags[t], tiddler.title);
		if (t < tiddler.tags.length - 1) createTiddlyText(ul, sep);
	}
	if (! label) createTiddlyElement(ul, "li", null, "listTitle", lingo.labelNoTags.format([tiddler.title]));
};

config.macros.saveChanges.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	if (!readOnly)
		renderTiddlyButton(place, params[0] || this.label, params[1] || this.hint, this.onClick, null, null, this.accessKey);
};

config.macros.saveChanges.onClick = function(e) {
	saveChangesAction();
	return false;
};

/**
	* Message macro. Searches the "config" object container for a given message qualifier and renders a span containing the message text.
	*
	* @param  {object[]} params - Accepts only two string parameters. 1st has to be a string like "views.editor.tagHint" - the fully qualified name of the internal message string. 2nd can be a format string.
*/

config.macros.message.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	if (! params[0]) {
		return;
	}
	var names = params[0].split(".");
	var lookupMessage = function(haystack, nameIndex) {
		var needle = names[nameIndex];
		var found = haystack[needle];
		if (found) {
			if (nameIndex < names.length - 1)
				return (lookupMessage(found, nameIndex + 1));
			else
				return found;
		} else
			return null;
	};
	var m = lookupMessage(config, 0);
	if (m == null)
		m = lookupMessage(window, 0);
	createTiddlyText(place, m.toString().format(params.splice(1)));
};


config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value, place, highlightHack, tiddler);
	},
	link: function(value, place, params, wikifier, paramString, tiddler) {
		renderLinkElement(place, value, true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if (config.macros.view.depth>50)
			return;
		if (config.macros.view.depth>0) {
			if (value==config.macros.view.values[config.macros.view.depth-1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if (params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value, place, highlightHack, tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	if ((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if (value) {
			var type = params[1] || config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if (handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler) { // Implements IMacroResolver.handler()
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if ((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if (field != "text" && !rows) {
			e = createTiddlyElement(null, "input", null, null, null, {
				type: "text", edit: field, size: "40", autocomplete: "off"
			});
			e.value = store.getValue(tiddler, field) || defVal;
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null, "fieldset", null, "fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1, "div");
			e = createTiddlyElement(wrapper2, "textarea");
			e.value = v = store.getValue(tiddler, field) || defVal;
			rows = rows || 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows, 10), 5);
			if (lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows, maxLines);
			e.setAttribute("rows", rows);
			e.setAttribute("edit", field);
			place.appendChild(wrapper1);
		}
		if (tiddler.isReadOnly()) {
			e.setAttribute("readOnly", "readOnly");
			jQuery(e).addClass("readOnly");
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev) {
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if (tags.length == 0)
		jQuery("<li/>").text(lingo.popupNone).appendTo(popup); // "There are not tags defined"
	var t;
	for (t = 0; t < tags.length; t++) {
		var tag = renderTiddlyButton(createTiddlyElement(popup, "li"), tags[t][0], lingo.tagTooltip.format([tags[t][0]]), config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag", tags[t][0]);
		tag.setArticleTitle(this.getArticleTitle());
	}
	Popup.show();
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return false;
};

/**
	* Event handler after clicking on a tag - will assign the tag to the article.
	*
	* @param  {element} ev - the <a> which represented the tag
*/
config.macros.tagChooser.onTagClick = function(ev) { // (do not mix up with onClickTag)
	var e = ev || window.event;
	if (e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getArticleTitle();
	if (!readOnly)
		story.setTiddlerTag(title, tag, 0);
	return false;
};

config.macros.tagChooser.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	if (tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = renderTiddlyButton(place, lingo.text, lingo.hint, this.onClick);
		btn.setArticleTitle(tiddler.title);
	}
};

config.macros.refreshDisplay.handler = function(place) { // Implements IMacroResolver.handler()
	renderTiddlyButton(place, this.label, this.hint, this.onClick);
};

config.macros.refreshDisplay.onClick = function(e) {
	refreshAll();
	return false;
};

//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	var tabSetName = params[0];
	var numTabs = (params.length - 1) / 3;
	var wrapper = createTiddlyElement(null, "div", null, "tabsetWrapper " + tabSetName);
	var tabSet = createTiddlyElement(wrapper, "div", null, "tabSet");		
	var t;
	for (t = 0; t < numTabs; t++) {
		var label = params[t * 3 + 1];
		var tooltip = params[t * 3 + 2];
		var content = params[t * 3 + 3];
		var tab = renderTiddlyButton(tabSet, label, tooltip, this.onClickTab, "tab tabUnselected");		
		tab.setAttribute("tab", label);
		tab.setAttribute("content", content);
	}	
	place.appendChild(wrapper);
	this.switchTab(tabSet, params[1]);
};

config.macros.tabs.onClickTab = function(e) {
	config.macros.tabs.switchTab(this.parentNode, this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabSet, tab) {	
	var tabElement = null;
	var nodes = tabSet.childNodes;
	var t;
	for (t = 0; t < nodes.length; t++) {
		if (nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			tabElement = nodes[t];
			tabElement.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if (tabElement) {
		if (tabSet.nextSibling && tabSet.nextSibling.className == "tabContents")
			jQuery(tabSet.nextSibling).remove();
		var tabContent = createTiddlyElement(null, "div", null, "tabContents");
		tabSet.parentNode.insertBefore(tabContent, tabSet.nextSibling);
		var contentTitle = tabElement.getAttribute("content");
		wikify(store.getArticleTextPartOrSlice(contentTitle), tabContent, null, store.getArticle(contentTitle));		
	}
};

//--
//-- Tiddler toolbar
//--

config.macros.toolbar.renderCommandButton = function(place, commandName, tiddler, className) {
	if (tiddler instanceof Tiddler) {
		var command = config.commands[commandName];
		if (command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command, tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command, tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command, tiddler);
			var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
			var btn = renderTiddlyButton(null, text, tooltip, cmd);
			btn.setAttribute("commandName",commandName);
			btn.setArticleTitle(tiddler.title);
			jQuery(btn).addClass("command_" + commandName);
			if (className)
				jQuery(btn).addClass(className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command, tiddler) {
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = (title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command, tiddler) {
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e, this, this.getArticleTitle()); // Expects ICommand.handler()
};

config.macros.toolbar.onClickPopup = function(ev) {
	var e = ev || window.event;
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getArticleTitle();
	popup.setArticleTitle(title);
	command.handlePopup(popup, title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place, className, event) {
	var children = place.getElementsByTagName("a");
	var t;
	for (t = 0; t < children.length; t++) {
		var c = children[t];
		if (jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if (c.onclick instanceof Function)
				c.onclick.call(c, event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev) {
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev) {
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

/**
	* This is the macro resolving handler for the "toolbar" macro. 
	* It will render toolbar buttons from an array of command names.
	*
	* @param {element}  place       - The target dom element (toolbar div), into which the toolbar buttons will be rendered.
	* @param {string}   macroName   - Always "toolbar".
	* @param {string}   wikifier    - Always null.
	* @param {string[]} params      - The command names to be rendered (as array).
	* @param {string}   paramString - The command names to be rendered (as unparsed string).
	* @param {Object}   tiddler     - The article for which the toolbar should be effecitve.
*/
config.macros.toolbar.handler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	var i;
	for (i = 0; i < params.length; i++) {
		var btn;
		var commandName = params[i];
		switch (commandName) {
		case "!":
			createTiddlyText(place, this.separator);
			break;
		case "*":
			createTiddlyElement(place,"br");
			break;
		case "<":
			btn = renderTiddlyButton(place, this.lessLabel, this.lessPrompt, config.macros.toolbar.onClickLess);
			jQuery(btn).addClass("lessCommand");
			break;
		case ">":
			btn = renderTiddlyButton(place, this.moreLabel, this.morePrompt, config.macros.toolbar.onClickMore);
			jQuery(btn).addClass("moreCommand");
			var e = createTiddlyElement(place,"span",null,"moreCommand");
			e.style.display = "none";
			place = e;
			break;
		default:
			var className = "";
			switch (commandName.substr(0,1)) {
			case "+":
				className = "defaultCommand"; // ToDo: Get rid of the default command
				commandName = commandName.substr(1);
				break;
			case "-":
				className = "cancelCommand";
				commandName = commandName.substr(1);
				break;
			}
			if (config.commands[commandName]) {
				this.renderCommandButton(place, commandName, tiddler, className);
			} else {
				this.customCommand(place, commandName, wikifier, tiddler);
			}
			break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place,command,wikifier,tiddler) {
};

//--
//-- Menu and toolbar commands
//--

config.commands.saveTiddler.handler = function(event, src, title) { // Implements ICommand.handler()
	var newTitle = story.saveTiddler(title); // todo - wieso kann sich title ändern?
	if (newTitle) story.showArticle(newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event, src, title) { // Implements ICommand.handler()
	if (story.hasChanges(title) && ! readOnly) {
		if (! confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title, false);
	story.showArticle(title);
	return false;
};

config.commands.deleteTiddler.handler = function(event, src, title) { // Implements ICommand.handler()
	var deleteIt = true;
	if (config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if (deleteIt) {
		store.removeTiddler(title);
		story.closeView(title);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event, src, title) { // Implements ICommand.handler()
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if (window.location.hash != t) window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup, title) {
	var references = store.getReferringTiddlers(title);
	var c = false;
	var r;
	for (r = 0; r < references.length; r++) {
		if (references[r].title != title) {
			renderLinkElement(createTiddlyElement(popup, "li"), references[r].title, true);
			c = true;
		}
	}
	if (!c) createTiddlyElement(popup, "li", null, "disabled", this.popupNone);
};

config.commands.jump.handlePopup = function(popup, title) {
	story.forEachArticleView(function(title, element) {
		renderLinkElement(createTiddlyElement(popup, "li"), title, true, null, false, null, true);
	});
};

config.commands.fields.handlePopup = function(popup,title) {
	var tiddler = store.getArticle(title);
	if (!tiddler)	return;
	var items = [];
	store.forEachField(tiddler, function(tiddler,fieldName,value) {items.push({field:fieldName,value:value});},true);
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if (items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup, "div", null, null, this.emptyText);
};

//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results, match) {
		var title = match[1] || match[4];
		var tiddler = this.getArticle(title);
		if (tiddler) {
			results.pushUnique(tiddler);
		} else if (isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title, this.getArticleTextPartOrSlice(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results, match) {
		var matched = this.getArticlesByTag(match[3]);
		for (var m=0; m < matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	},
	sort: function(results, match) {
		return this.sortTiddlers(results, match[3]);
	},
	limit: function(results, match) {
		return results.slice(0, parseInt(match[3], 10));
	},
	field: function(results, match) {
		var matched = this.getArticlesByField(match[2], true, match[3]);
		var m;
		for (m = 0; m < matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	}
};

function StringFieldAccess(n, readOnly) {
	this.set = readOnly ?
		function(t,v) {if (v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
		function(t,v) {if (v != t[n]) {t[n] = v; return true;}};		
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n) {
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if (d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n) {
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if (s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.buildInternalLinksTuple(t[n]);};
}

ArticleStore.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

ArticleStore.isStandardField = function(name) {
	return ArticleStore.standardFieldAccess[name] != undefined;
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
ArticleStore.prototype.getValue = function(tiddler, fieldName) {
	var t = this.resolveTiddler(tiddler);
	if (!t)
		return undefined;
	if (fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 || fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0) {
		var sliceType = fieldName.substr(0, 2);
		var sliceName = fieldName.substring(2);
		return store.getArticleTextPartOrSlice("%0%1%2".format(t.title,sliceType,sliceName));
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = ArticleStore.standardFieldAccess[fieldName];
		if (accessor) {
			return accessor.get(t);
		}
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
ArticleStore.prototype.forEachField = function(articleOrTitle, callback, onlyExtendedFields, sortExtendedFields) { // HACK: Das sollte am Article kleben und nicht am Store
	var t = this.resolveTiddler(articleOrTitle);
	if (! t) return undefined;
	var result;
		
	// We want to sort the extended fields because they will be externalized when saving.
	// If sorted randomly, we would produce unnecessary changes in the saved file which would pop up in any diff viewer.
	var keys = Object.keys(t.fields); // JavaScript cannot sort t.fields hashtable directly. We rip the keys array and sort that.
	keys.sort();

	for (var i = 0; i < keys.length; i++) {
		result = callback(t, keys[i], t.fields[keys[i]]);
		if (result)	return result;
	}

	if (onlyExtendedFields) return undefined;
	
	for (var n in ArticleStore.standardFieldAccess) {
		if (n != "tiddler") {
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			result = callback(t, n, ArticleStore.standardFieldAccess[n].get(t));
			if (result)	return result;
		}
	}
	return undefined;
};

Element.prototype.getArticleTitle = function(){
	return this.getAttribute("tiddler");
}

Element.prototype.setArticleTitle = function(title){
	this.setAttribute("tiddler", title);
}

function blobToNewArticle(blob, cb){
	blobToDataUrlAsync(blob, function(dataUrl){
		article = new Tiddler();
		var now = new Date();
		var title = "$" + now.convertToYYYYMMDDHHMMSSMMM(); // "$" is the prefix for resource containing articles
		article.set(title, dataUrl, config.views.wikified.defaultModifier, now, ["resource"], now);
		store.addTiddler(article);
		if (cb) cb(title, article);
	});
}

function blobToDataUrlAsync(blob, cb){
	var reader = new FileReader();
	reader.onloadend = function() { cb(reader.result); }
	reader.readAsDataURL(blob);
}

//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{name: "SystemSettings", notify: onSystemSettingsChange},
	{name: "StyleSheetLayout", notify: refreshStyles},	
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},	
	{name: null, notify: refreshDisplay}
];

config.refreshers = {
	link: function(e, changeList) {
		var title = e.getAttribute("tiddlyLink");
		var classNames = buildClassNames(title, e.className);
		e.className = classNames;
		return true;
	},

	tiddler: function(e, changeList)	{
		var title = e.getArticleTitle();
		var templateNameOrNumber = e.getAttribute("template");
		if (changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && ! story.isDirty(title))
			story.populateViewOrChangeTemplate(title, templateNameOrNumber, true);
		else
			refreshElements(e, changeList);
		return true;
	},

	content: function(e, changeList)	{
		var title = e.getArticleTitle();
		var force = e.getAttribute("force");
		var args = e.getAttribute("args");
		if (force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e,title,args);
			return true;
		} else
			return false;
	},

	macro: function(e, changeList)	{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if (macro)
			macro = config.macros[macro];
		if (macro && macro.refresh)
			macro.refresh(e, params);
		return true;
	}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate"
};

function refreshElements(root, changeList) {
	var nodes = root.childNodes;
	for (var i = 0; i < nodes.length; i++) {
		var e = nodes[i], type = null;
		if (e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true)) type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if (refresher != undefined) refreshed = refresher(e, changeList);
		if (e.hasChildNodes() && ! refreshed) refreshElements(e, changeList); // recursion!
	}
}

// scans html code for elements with macro attributes and executes the macros. E.g. <span macro="version"></span>
function applyHtmlMacros(root, tiddler) {
	var e = root.firstChild;
	while (e) {
		var nextChild = e.nextSibling;
		if (e.getAttribute) {
			var macro = e.getAttribute("macro");
			if (macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if (p != -1) {
					params = macro.substr(p + 1);
					macro = macro.substr(0, p);
				}
				invokeMacro(e, macro, params, null, tiddler);
			}
		}
		if (e.hasChildNodes()) applyHtmlMacros(e, tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title) {
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getArticleWrapper();
	var nodes;
	if (display) {
		nodes = display.childNodes;
		for (var t = nodes.length - 1; t >= 0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if (!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if (!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	wrapper.innerHTML = store.getArticleRawTextResolveIncludes(title, null, 10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getArticleWrapper();
	jQuery(display).empty();
	if (!display)
		display = createTiddlyElement(wrapper, "div", story.articleWrapperId);
	nodes = stash.childNodes;
	for (var t = nodes.length - 1; t >= 0; t--)
		display.appendChild(nodes[t]);
	jQuery(stash).remove();
}

function refreshDisplay(hint) { // hint dürfte immer undefined sein!
	if (typeof hint == "string") hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e, hint);
	if (backstage.isPanelVisible()) {
		refreshElements(backstage.panel, hint);
	}
}

function getPageTitle() { // document.title = getPageTitle();
	return wikifyPlainText(config.options.txtWikiTitle, null, null);	
}

function refreshStyles(title, doc) {
	setStylesheet(title == null ? "" : store.getArticleRawTextResolveIncludes(title, "", 10), title, doc || document);
}

function refreshAll() {
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");	
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}

//--
//-- Option handling
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name, value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? 'true' : 'false';},
		set: function(name, value) {config.options[name] = value == 'true';}
	}
};

function setOption(name, value) {
	var optType = name.substr(0,3);
	if (config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name,value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name) {
	var optType = name.substr(0, 3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ? config.optionHandlers[optType].get(name) : null;
}

function loadOptions() {
	if (safeMode) return;
	loadSystemSettings();
}

function loadSystemSettings() {
	var settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for (var key in settings) {
		setOption(key,settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange() {
	if (! startingUp) {
		loadSystemSettings();
	}
	document.title = getPageTitle();
}

function saveOption(name) {
	
	if (safeMode) return;
	
	if (name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}
		
	if (config.optionsSource[name] == 'setting') {
		saveSystemSetting(name, true);
	}
}

var systemSettingSave;

function commitSystemSettings(storeWasDirty) {
	if (systemSettingSave) window.clearTimeout(systemSettingSave);
	systemSettingSave = window.setTimeout(function() {autoSaveChanges();}, 1000);
}

function saveSystemSetting(name, doSaveFile) {
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title,name);
	if (readOnly || slice === getOption(name)) {
		return; //# don't save if read-only or the option hasn't changed
	}
	var slices = store.calcAllSlices(title);
	var key;
	for (key in config.optionsSource) {
		var value = getOption(key) || '';
		if (slices[key] !== value) {
			slices[key] = value;
		}
	}
	var text = [];
	for (key in slices) {
		text.push('%0: %1'.format([key, slices[key]]));
	}
	text = text.sort().join('\n');
	var storeWasDirty = store.isDirty();
	var tiddler = store.getArticle(title);
	if (tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title, title, text, 'System', new Date(), null, null);
	}
	if (doSaveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s) {
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s) {
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,'')));});
}

// Renders a newly created element into place. The element type is looked up in option.types[optionTypeName].elementType
config.macros.option.genericCreate = function(place, optionTypeName, optionName, className, desc) {
	var typeInfo = config.macros.option.types[optionTypeName];
	var element = document.createElement(typeInfo.elementType);
	if (typeInfo.typeValue)
		element.setAttribute('type', typeInfo.typeValue);
	element[typeInfo.eventName] = typeInfo.onChange;
	element.setAttribute('option', optionName);
	element.className = className || typeInfo.className;
	if (config.optionsDesc[optionName])
		element.setAttribute('title', config.optionsDesc[optionName]);
	place.appendChild(element);
	if (desc != 'no')
		createTiddlyText(place, config.optionsDesc[optionName] || optionName);
	element[typeInfo.valueField] = config.options[optionName];
	return element;
};

config.macros.option.genericOnChange = function(e) {
	var opt = this.getAttribute('option');
	if (opt) {
		var optionTypeName = opt.substr(0, 3);
		var typeInfo = config.macros.option.types[optionTypeName];
		if (typeInfo.elementType && typeInfo.valueField)
			config.macros.option.propagateOption(opt, typeInfo.valueField, this[typeInfo.valueField], typeInfo.elementType, this);
	}
	return true;
};

config.macros.option.types = { // Dictionary(Of OptionTypeName, OptionTypeInfo)
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt, valueField, value, elementType, elem) {
	config.options[opt] = value;
	saveOption(opt);
	var t,nodes = document.getElementsByTagName(elementType);
	for (t = 0; t < nodes.length; t++) {
		var optNode = nodes[t].getAttribute('option');
		if (opt == optNode && nodes[t]!=elem)
			nodes[t][valueField] = value;
	}
};

config.macros.option.handler = function(place, macroName, params, wikifier, paramString) { // Implements IMacroResolver.handler()
	params = paramString.parseParams('anon', null, true, false, false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params, 'name', null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params, 'class', null);
	var desc = getParam(params, 'desc', 'no');
	var optionTypeName = opt.substr(0,3);
	var optionTypeInfo = config.macros.option.types[optionTypeName];
	if (optionTypeInfo && optionTypeInfo.create)
		optionTypeInfo.create(place, optionTypeName, opt, className, desc);
};

// renders a wizard containing a list view containing all options
config.macros.options.handler = function(place, macroName, params, wikifier, paramString) { // Implements IMacroResolver.handler()
	params = paramString.parseParams('anon', null, true, false, false);
	var showUnknown = getParam(params, 'showUnknown', 'no');
	var presenter = new WizardPresenter();
	presenter.renderNewView(place, this.wizardTitle);
	presenter.renderBodyContent(this.step1Title, this.step1Html);
	var listViewPlaceholder = presenter.getElement('listViewPlaceholder');
	var chkUnknown = presenter.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	listViewPlaceholder.parentNode.insertBefore(listWrapper, listViewPlaceholder);
	presenter.setValue('listWrapper', listWrapper);
	this.refreshOptions(listWrapper, showUnknown == 'yes');
};

// renders a listview representing the option entities
config.macros.options.refreshOptions = function(listWrapper, showUnknown) {
	var optionViews = [];
	for (var optionName in config.options) { // Reflection, iterate all members of "config" singleton
		var optionView = {};
		optionView.option = '';
		optionView.name = optionName;		
		if (config.optionsDesc[optionName]) {
			optionView.description = config.optionsDesc[optionName];
			optionViews.push(optionView);
		} else {
			if (showUnknown) {
				optionView.description = this.unknownDescription;
				optionViews.push(optionView);
			}
		}
	}
	optionViews.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	
	ListView.create(listWrapper, optionViews, this.listViewTemplate); // This is a bidirectional wire-up. A ListView will be rendered, but "optionViews" will receive a tableCellByFieldName dictionary!
	
	// The list view was created with read only elements.
	// The following code will render interactive input elements into table cells.
	
	for (var i = 0; i < optionViews.length; i++) {
		var optionTypeName = optionViews[i].name.substr(0, 3);
		var typeInfo = config.macros.option.types[optionTypeName];
		if (typeInfo && typeInfo.create) {
			typeInfo.create(optionViews[i].tableCellByFieldName['option'], optionTypeName, optionViews[i].name, null, 'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e) {
	var presenter = new WizardPresenter(this);
	var listWrapper = presenter.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper, this.checked);
	return false;
};

// Vodi

config.macros.anchor = {};

config.macros.anchor.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	var e =	createTiddlyElement(place, "a");
	e.name = params[0];
	e.text = params[1];
	e.className = "anchor";
};

config.macros.navigate = {};

config.macros.navigate.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	renderTiddlyButton(place, '←', "Navigate Backwards", function() {config.commands.navigateBack.handler();},	null, null, null);
	renderTiddlyButton(place, '→', "Navigate Foward", function() {config.commands.navigateForward.handler();},	null, null, null);
};

config.macros.newArticleButton = {};

// This will render the button
config.macros.newArticleButton.handler = function(place, macroName, params) { // Implements IMacroResolver.handler()
	// process command line parameters
	var label = params[0];
	var createRoot = params[1];
	if (createRoot == "true") {
		renderTiddlyButton(place, label, "Create a new root level page", function() {config.macros.newArticleButton.onClick(true);},	null, null, null);
	} else{
		renderTiddlyButton(place, label, "Create a sub page for the current page", function() {config.macros.newArticleButton.onClick(false);},	null, null, null);
	}
};

config.macros.newArticleButton.onClick = function(createRoot) {
	var parentTitle = store.currentTiddler ? store.currentTiddler.title : null;
	if (createRoot || ! parentTitle || parentTitle == "Untitled")	parentTitle = "";
	story.showArticle("Untitled", DEFAULT_EDIT_TEMPLATE, parentTitle ? "parenttitle:[[" + parentTitle + "]]" : null);
	story.focusTiddler("Untitled", "title");
};

config.macros.sectionTOC = { // todo: this only works when the user positions the macro at the end of the article - this should be fixed.
	targetClass: 'sectionTOC',
	linkFormat: '[[%0|##%0]]',
	handler: function(place,macroName,params, wikifier, paramString,tiddler) {
		var out = [];
		var targetClass = params[0]||this.targetClass;
		var t = story.getArticleViewByChild(place);
		if (! t) return;
		var elems = t.getElementsByTagName('*');
		var level = 5; // topmost heading level
		for (var i = 0; i < elems.length; i++) {
			var txt = getPlainText(elems[i]).trim();
			var link = this.linkFormat.format([txt]);
			switch (elems[i].nodeName) {
				case 'H1': out.push('#'+link);		level = 1; break;
				case 'H2': out.push('##'+link);		level = level < 2 ? level : 2; break;
				case 'H3': out.push('###'+link);	level = level < 3 ? level : 3; break;
				case 'H4': out.push('####'+link);	level = level < 4 ? level : 4; break;
				case 'H5': out.push('#####'+link); level = level < 5 ? level : 5; break;
				default: if (hasClass(elems[i], targetClass)) var target = elems[i]; // search for element with 'sectionTOC' class like {{sectionTOC{}}}
			}
		}
		// trim excess bullet levels
		if (level > 1) for (var i = 0; i < out.length; i++) out[i] = out[i].substr(level - 1);
		// show numbered list
		if (out.length && target) {
			if (target.style.display == 'none') target.style.display = 'block';
			wikify(out.join('\n'), target);
		}
	}
}

// Zähle, der wievielte Treffer das Wort needle im DOM ist, wenn man bis zum Anker (=selektierter Node) navigiert.
function recurseViewer(node, anchor, needle) {
	for (var i = 0; i < node.childNodes.length; i++) {
		var child = node.childNodes[i];
		if (child.nodeType == Node.TEXT_NODE) {
		  if (child.nodeValue.indexOf(needle) >= 0) {
				recurseViewerOccurance++;
				if (child == anchor) {
					return false;
				}
			}
		}
		var cont = recurseViewer(child, anchor, needle);
		if (! cont) {
			return false;
		}	
	}
	return true;
}

function highlightArticleTree() {
	if (typeof _PreviousCurrentArticleTreeElement !== 'undefined') _PreviousCurrentArticleTreeElement.classList.remove('current');

	if (! store.currentTiddler) return; // todo: current darf nicht im store leben, sondern nur in story!

	var articleTreePanel = document.getElementsByClassName('articleTreePanel')[0];
	var nodeElement = document.querySelector('[tiddlylink="' + store.currentTiddler.title + '"]');
	
	if (! articleTreePanel || ! nodeElement) return;
	
	nodeElement.classList.add('current');	 

	_PreviousCurrentArticleTreeElement = nodeElement;

	var container = articleTreePanel.parentNode;	

	var offsetToContainer = calcOffsetTo(nodeElement, container);

	if (offsetToContainer < container.scrollTop) container.scrollTop =  Math.max(0, offsetToContainer - nodeElement.offsetHeight);

	var visibleBottom = container.scrollTop + container.clientHeight;
	var elementBottom = offsetToContainer + nodeElement.offsetHeight;

	if (elementBottom > visibleBottom) {
		container.scrollTop =  elementBottom - container.clientHeight + nodeElement.offsetHeight;
	}		 
}

function calcOffsetTo(inner, outer) {
	var curtop = 0;
	while (inner.offsetParent) {		
		curtop += inner.offsetTop;
		if (inner.offsetParent == outer) break;
		inner = inner.offsetParent;		
	}
	return curtop;
}

config.commands.editTiddler.handler = function(event, src, title) { // Implements ICommand.handler()

	var articleView;

	if (title){
		articleView = story.getArticleViewByTitle(title);
	} else {
		articleView = story.getCurrentArticleView();
		title = articleView ? articleView.getArticleTitle() : null;
	}

	if (! articleView || story.isDirty(title)) return;

	clearMessage();
		
	// Selected text: Count the number of occurances of the selected text until we reach the actually selected element
	recurseViewerOccurance = 0;
	var found = -1;
	var selectedText = window.getSelection().toString();
	if (selectedText.length) {
		var articleContentContainer = null;
		for (var i = 0; i < articleView.childNodes.length; i++) {
			if (articleView.childNodes[i].className == "articleContentContainer") { // HACK: Code dependency to CSS class name!
				articleContentContainer = articleView.childNodes[i];
				break;
			}
		}		
		recurseViewer(articleContentContainer, window.getSelection().anchorNode, selectedText);
	}

	var article = store.getArticle(title);
	if (article) article.rescuedScrollTop = articleView.scrollTop;
	
	//var fields = articleView.getAttribute("tiddlyFields");
	var fields = null;
	
	story.showArticle(title, DEFAULT_EDIT_TEMPLATE, fields);
	
	var textAreaElement = story.getTiddlerField(title, "text");	
	textAreaElement.onpaste = onPasted;
	
	// Selected text: Reconstruct the selection by locating the n-th occurance of the formerly selected text
	if (recurseViewerOccurance) {		
		found = -1;
		do {
			recurseViewerOccurance--;
			found = textAreaElement.value.indexOf(selectedText, found + 1);
		} while (recurseViewerOccurance && found >= 0)
	}
	if (found > -1) {
		setCaretPosition(textAreaElement, found);
	} else {
		setCaretPosition(textAreaElement, (articleView.rescuedCaretPosition ? articleView.rescuedCaretPosition : 0));
	}
	
	return false;
}

function insertAtCursor(input, textToInsert) {
  // get current text of the input
  const value = input.value;

  // save selection start and end position
  const start = input.selectionStart;
  const end = input.selectionEnd;

  // update the value with our text inserted
  input.value = value.slice(0, start) + textToInsert + value.slice(end);

  // update cursor to be at the end of insertion
  input.selectionStart = input.selectionEnd = start + textToInsert.length;
}

config.commands.cancelTiddler.handlerBase = config.commands.cancelTiddler.handler;

config.commands.cancelTiddler.handler = function(event, src, title) { // Implements ICommand.handler()
	var pos = story.getTiddlerField(title,"text").selectionStart;
	var baseResult = config.commands.cancelTiddler.handlerBase(event, src, title);
	story.getArticleViewByTitle(title).rescuedCaretPosition = pos;
	return baseResult;
};

config.commands.navigateBack = {
	text: 'Back',
	tooltip: 'View the previous page.',
	handler: function(event, src, title) { // Implements ICommand.handler()
		story.history.back();
		return false;
	}
};

config.commands.navigateForward = {
	text: 'Forward',
	tooltip: 'View the previous page.',
	handler: function(event, src, title) { // Implements ICommand.handler()
		story.history.forward();
		return false;
	}
};

config.commands.saveTiddler.handlerBase = config.commands.saveTiddler.handler; // ToDo: patch the base method instead of hijacking

config.commands.saveTiddler.handler = function(event, src, title) { // Implements ICommand.handler()
	var pos = story.getTiddlerField(title, "text").selectionStart;
	var baseResult = config.commands.saveTiddler.handlerBase(event, src, title);
	story.getArticleViewByTitle(title).rescuedCaretPosition = pos;
	return baseResult;
};

function refreshTreePath() {
	var place = document.getElementById('treePath');
	while (place.firstChild) {
    place.removeChild(place.firstChild);
	}
	var tiddler = store.currentTiddler;
	if (! tiddler) return;
	var parentTitle;
	var parentTitles = [];
	do {
		parentTitle = tiddler.fields['parenttitle'];
		if (parentTitle) {
			parentTitles.push(parentTitle);
			tiddler = store.getArticle(parentTitle);
		}		
	} while (parentTitle && tiddler);
	
	for (var i = parentTitles.length - 1; i >= 0; i--) {		
	 renderLinkElement(place, parentTitles[i], parentTitles[i]);
	 createTiddlyText(place, " ▸ ");
	}	
	createTiddlyText(place, store.currentTiddler.title);
};

inputDialog = {
	createElement: function(tag, innerHtml) { // todo: better UX, focus handling (especially after closing the dialog), default selection...
		var element = document.createElement(tag);
		element.innerHTML = innerHtml;
		return element;
	},
	close: function(isOk) {
		this.cloak.style.display = 'none';
		document.body.removeChild(this.inputPanel);
		if (isOk) this.okHandler(this.labelsAndValues);
	},
	cloak: document.getElementById("backstageCloak"),
	rescuedCloakClickHandler: null,
	inputPanel:null,
	labelsAndValues: null,
	okHandler:null,
	keyPressed: function(e) {		
		var allFields = this.inputPanel.getElementsByClassName('inputDialogPanel-field');		
		for (i = 0; i < allFields.length; i++) {
			this.labelsAndValues[allFields[i].getAttribute('name')] = allFields[i].value;
		}
		switch(e.keyCode) {
			case 13:
				inputDialog.close(true);
				break;
			case 27: // Escape
				inputDialog.close(false);
				break;
			}
	},
	awaitUserInput: function(labelsAndValues, focusingIndex, okHandler) {
		this.rescuedCloakClickHandler = this.cloak.onmousedown;
		this.cloak.onmousedown = null;
		
		var inputPanel = document.createElement("div");
		inputPanel.onkeydown = this.keyPressed.bind(this);
		inputPanel.setAttribute('class','inputDialogPanel');
		document.body.appendChild(inputPanel);
		
		var title = this.createElement("h1", 'Edit link');
		inputPanel.appendChild(title);
		
		var focusingField;
		var i = 0;
		for (labelText in labelsAndValues) {
			var label = this.createElement("div", labelText);
			label.setAttribute('class','inputDialogPanel-label');
			inputPanel.appendChild(label);
			
			var field = document.createElement("input");
			field.setAttribute('name', labelText);
			field.setAttribute('class', 'inputDialogPanel-field');
			field.value = labelsAndValues[labelText];
			if (i == focusingIndex) focusingField = field;
			//field.onkeypress = this.keyPressed;
			
			inputPanel.appendChild(field);
			i++;			
		}
					
		var buttonsPanel = document.createElement("div");
		buttonsPanel.setAttribute('class', 'inputDialogPanel-buttonsPanel');
		
		var okButton = this.createElement('button', 'Ok');
		okButton.onclick = function() {inputDialog.close(true);}
		buttonsPanel.appendChild(okButton);
		
		var cancelButton = this.createElement('button', 'Cancel');
		cancelButton.onclick = function() {inputDialog.close(false);}
		buttonsPanel.appendChild(cancelButton);
		
		inputPanel.appendChild(buttonsPanel);
		
		this.cloak.style.display = 'block';

		this.inputPanel = inputPanel;
		this.labelsAndValues = labelsAndValues;
		this.okHandler = okHandler;

		focusingField.focus();
		focusingField.select();
	}
}

// YourSearch

if (! window.abego) { // Ensure_that_the_Plugin_is_only_installed_once.

window.abego = {};

// define the Array forEach when not yet defined (e.g. by Mozilla)
if (!Array.forEach) {
	Array.forEach = function(obj, callback, thisObj) {
		for (var i = 0,len = obj.length; i < len; i++)
			callback.call(thisObj, obj[i], i, obj);
	};
	Array.prototype.forEach = function(callback, thisObj) {
		for (var i = 0,len = this.length; i < len; i++)
			callback.call(thisObj,  this[i], i, this);
	};
}

abego.toInt = function(s, defaultValue) {
	if (!s) return defaultValue;
	var n = parseInt(s);
	return (n == NaN) ? defaultValue : n;
};

abego.createEllipsis = function(place) {
	var e = createTiddlyElement(place,"span");
	e.innerHTML = "&hellip;";
};

//#concept Object
//
abego.shallowCopy = function(object) {
	if (!object)
		return object;
	var result = {};
	for (var n in object) 
		result[n] = object[n];
	return result;
};

// Returns a shallow copy of the options, or a new, empty object if options is null/undefined.
//
// @param options [may be null/undefined]
//
//#concept Object, Options
//#import abego.shallowCopy
//
abego.copyOptions = function(options) {
	return !options ? {} : abego.shallowCopy(options);
};

//#import abego.define-namespace
// returns the number of occurances of s in the text
abego.countStrings = function(text, s) {
	if (!s)
		return 0;
		
	var len = s.length;
	var n = 0;
	var lastIndex = 0;
	while (true) {
		var i = text.indexOf(s, lastIndex);
		if (i < 0)
			return n;
		n++;
		lastIndex = i+len;
	}
	return n;
};

// Returns the content of the first "braced" text {...}
// Also takes care of nested braces
//
// Returns undefined when no braced text is found or it is not properly nested
//
// @param [optional] when defined and a braced text is found lastIndexRef.lastIndex will contain the index of the char following the (final) closing brace on return.
//
abego.getBracedText = function(text, offset, lastIndexRef) {
	if (!offset) offset = 0;
	var re = /\{([^\}]*)\}/gm;
	re.lastIndex = offset;
	var m = re.exec(text);
	if (m) {
		// The matching stopped at the first closing brace.
		// But if the matched text contains opening braces 
		// this is not the final closing brace.
		// Handle this case specially, find the "corresponding" closing brace
		var s = m[1];
		var nExtraOpenBrace = abego.countStrings(s,"{");
		
		if (!nExtraOpenBrace) {
			if (lastIndexRef)
				lastIndexRef.lastIndex = re.lastIndex;
			// simple case: no nested braces
			return s;
		}

		// special case: "nested braces"
		var len = text.length;
		for (var i = re.lastIndex; i < len && nExtraOpenBrace; i++) {
			var c = text.charAt(i);
			if (c == "{") 
				nExtraOpenBrace++;
			else if (c == "}")
				nExtraOpenBrace--;
		}
		if (!nExtraOpenBrace) {
			// found the corresponding "}".
			if (lastIndexRef)
				lastIndexRef.lastIndex = i - 1;
			return text.substring(m.index + 1, i - 1);
		}
	}
	
	// no return means: return undefined;
};

// Returns an array with those items from the array that pass the given test
//
// @param test an one-arg boolean function that returns true when the item should be added.
// @param testObj [optional] the receiver for the test function (global if undefined or null)
// @param result [optional] an array. When define the selected items are added to this array, otherwise a new array is used.
//
//#import Array.prototype.forEach
//
abego.select = function(array,test,testObj,result) {
	if (!result) result = [];
	array.forEach(function(t) {
		if (test.call(testObj,t)) 
			result.push(t);
		}
	);
	return result;
};

// A portable way to "consume an event"
// 
// (Uses "stopPropagation" and "preventDefault", but will also "cancelBubble",
// even though this is a "non-standard method" , just in case).
//
abego.consumeEvent = function(e) {
	if (e.stopPropagation) e.stopPropagation();
	if (e.preventDefault) e.preventDefault();
	e.cancelBubble = true;
	e.returnValue = true;
};

// Class abego.TiddlerFilterTerm
//
// Used to check if a tiddler contains a given text.
//
// A list of fields (standard and/or extended) may be specified to restrict the search to certain fields. 
//
// When no explicit fields are given the fields defined by defaultFields are checked, plus all extended 
// fields (when options.withExtendedFields is true).
//
// @param options [may be null/undefined]
//		options.fields @seeParam abego.MultiFieldRegExpTester.fields
// 		options.withExtendedFields @seeParam abego.MultiFieldRegExpTester.withExtendedFields  
// 		options.caseSensitive [Default: false]
// 		options.fullWordMatch [Default: false]
// 		options.textIsRegExp [Default: false] when true the given text is already a regExp
//
//#import abego.MultiFieldRegExpTester
//
abego.TiddlerFilterTerm = function(text,options) {
	if (!options) options = {};

	var reText = text;
	if (!options.textIsRegExp) {
		reText = text.escapeRegExp();
		if (options.fullWordMatch) 
			reText = "\\b"+reText+"\\b";
	}
	var regExp = new RegExp(reText, "m"+(options.caseSensitive ? "" : "i"));

	this.tester = new abego.MultiFieldRegExpTester(regExp, options.fields, options.withExtendedFields);
};

abego.TiddlerFilterTerm.prototype.test = function(tiddler) {
	return this.tester.test(tiddler);
};

// 		options.defaultFields [@seeOptionDefault abego.TiddlerFilterTerm.fields] fields to check when no fields are explicitly specified in queryText.
// 		options.withExtendedFields [@seeOptionDefault abego.TiddlerFilterTerm.withExtendedFields] when true and no fields are explicitly specified in queryText also the extended fields are considered (in addition to the ones in defaultFields).
// @seeOptions abego.TiddlerFilterTerm (-fields -fullWordMatch -withExtendedFields)
//
//#import abego.getBracedText
//#import abego.copyOptions
//#import abego.TiddlerFilterTerm
//
abego.parseTiddlerFilterTerm = function(queryText,offset,options) {
	
	// group 1: {...} 		(JavaScript expression)
	// group 2: '=' 		(full word match (optional))
	// group 3: [!%#] 		(field selection short cuts)
	// group 4: fieldName ':'
	// group 5: String literal "..."
	// group 6: RegExp literal /.../
	// group 7: scheme '://' nonSpaceChars
	// group 8: word
	var re = /\s*(?:(?:\{([^\}]*)\})|(?:(=)|([#%!])|(?:(\w+)\s*\:(?!\/\/))|(?:(?:("(?:(?:\\")|[^"])+")|(?:\/((?:(?:\\\/)|[^\/])+)\/)|(\w+\:\/\/[^\s]+)|([^\s\)\-\"]+)))))/mg;
	var shortCuts = {'!':'title','%':'text','#':'tags'};
	
	var fieldNames = {};
	var fullWordMatch = false;
	re.lastIndex = offset;
	while (true) {
		var i = re.lastIndex;
		var m = re.exec(queryText);
		if (!m || m.index != i) 
			throw "Word or String literal expected";
		if (m[1]) {
			var lastIndexRef = {};
			var code = abego.getBracedText(queryText,0,lastIndexRef);
			if (!code)
				throw "Invalid {...} syntax";
			var f = Function("tiddler", "return (" + code + ");");
			return {
				func: f,
				lastIndex: lastIndexRef.lastIndex,
				markRE: null
			};
		}
		if (m[2])
			fullWordMatch = true;
		else if (m[3]) 
			fieldNames[shortCuts[m[3]]] = 1;
		else if (m[4]) 
			fieldNames[m[4]] = 1;
		else {
			var textIsRegExp = m[6];
			var text = m[5] ? window.eval(m[5]) : m[6] ? m[6] :  m[7] ? m[7] : m[8];
			
			options = abego.copyOptions(options);
			options.fullWordMatch = fullWordMatch;
			options.textIsRegExp = textIsRegExp;

			var fields = [];
			for (var n in fieldNames)
				fields.push(n);
			if (fields.length == 0) {
				options.fields = options.defaultFields;
			} else {
				options.fields = fields;
				options.withExtendedFields	= false;
			}	
			var term = new abego.TiddlerFilterTerm(text, options);
			var markREText = textIsRegExp ? text : text.escapeRegExp();
			if (markREText && fullWordMatch)
				markREText = "\\b"+markREText+"\\b";
			return {func: function(tiddler) {return term.test(tiddler);},
					lastIndex:re.lastIndex,
					markRE: markREText ? "(?:"+markREText+")" : null};
		}
	}
};

// Class abego.BoolExp
//
// Allows the execution/evaluation of a boolean expression, according to this syntax:
//
// boolExpression    : unaryExpression (("AND"|"OR"|"&&"|"||")? unaryExpression)*
//                   ;
//
// unaryExpression   : ("not"|"-")? primaryExpression
//                   ;
//
// primaryExpression : "(" boolExpression ")" 
//                   | Term
//                   ;
//
// For flexibility the Term syntax is defined by a separate parse function.
//
// Notice that there is no precedence between "AND" and "OR" operators, i.e. they are evaluated from left to right.
//
// To evaluate the expression in a given context use code like this:
//
//	var be = new abego.BoolExp(s, termParseFunc);
//  var result = be.exec(context);
// 
// @param s the text defining the expression 
// @param parseTermFunc a Function(text,offset,options) that parses the text starting at offset for a "Term" and returns an object with properties {func: Function(context), lastIndex: ...}. func is the function to be used to evaluate the term in the given context.
// @param options [may be null/undefined] (is also passed to the parseTermFunc)
// 			options.defaultOperationIs_OR [Default: false] When true the concatenation of unaryExpressions (without an operator) is interpreted as an "OR", otherwise as an "AND".
// 			options.caseSensitive [default: false]
//
abego.BoolExp = function(s, parseTermFunc, options) {
	this.s = s;
	var defaultOperationIs_OR = options && options.defaultOperationIs_OR;
	
	var reCloseParenthesis = /\s*\)/g;  			// match )
	var reAndOr = /\s*(?:(and|\&\&)|(or|\|\|))/gi; 	// group 1: AND, group 2: OR
	
	var reNot_Parenthesis = /\s*(\-|not)?(\s*\()?/gi;
	
	var parseBoolExpression; //#Pre-declare function name to avoid problem with "shrinkSafe"
	
	var parseUnaryExpression = function(offset) {
		reNot_Parenthesis.lastIndex = offset;
		var m = reNot_Parenthesis.exec(s);
		var negate = false;
		var result = null;
		if (m && m.index == offset) {
			offset += m[0].length;
			negate = m[1];
			if (m[2]) {
				// case:  (...)
				var e = parseBoolExpression(offset);
				reCloseParenthesis.lastIndex = e.lastIndex;
				if (!reCloseParenthesis.exec(s))
					throw "Missing ')'";
				result = {func: e.func, lastIndex: reCloseParenthesis.lastIndex, markRE: e.markRE};
			}
		}
		if (!result)
			result = parseTermFunc(s,offset,options);

		if (negate) {
			result.func = (function(f){return function(context) {return !f(context);};})(result.func);
			// don't mark patterns that are negated
			// (This is essential since the marking may also be used to calculate "ranks". If we
			// would also count the negated matches (i.e. that should not exist) the rank may get too high)
			result.markRE = null;
		}
		return result;
	};

	parseBoolExpression = function(offset) {
		var result = parseUnaryExpression(offset);
		while (true) {
			var l = result.lastIndex;
			reAndOr.lastIndex = l;
			var m = reAndOr.exec(s);
			var isOrCase;
			var nextExp;
			if (m && m.index == l) {
				isOrCase = !m[1];
				nextExp = parseUnaryExpression(reAndOr.lastIndex);
			} else {
				// no "AND" or "OR" found. 
				// Maybe it is a concatenations of parseUnaryExpression without operators
				try {
					nextExp = parseUnaryExpression(l);
				} catch (e) {
					// no unary expression follows. We are done
					return result;
				}
				isOrCase = defaultOperationIs_OR;
			}
			result.func = (function(func1, func2, isOrCase) {
					return isOrCase
						? function(context) {return func1(context) || func2(context);}
						: function(context) {return func1(context) && func2(context);};
				})(result.func,nextExp.func,isOrCase);
			result.lastIndex = nextExp.lastIndex;
			if (!result.markRE)
				result.markRE = nextExp.markRE;
			else if (nextExp.markRE) 
				result.markRE = result.markRE + "|" + nextExp.markRE;
		}
	};
	
	var expr = parseBoolExpression(0);
	this.evalFunc = expr.func;
	if (expr.markRE)
		this.markRegExp = new RegExp(expr.markRE, options.caseSensitive ? "mg" : "img");
};

abego.BoolExp.prototype.exec = function() {
	return this.evalFunc.apply(this,arguments);
};

abego.BoolExp.prototype.getMarkRegExp = function() {
	return this.markRegExp;
};

abego.BoolExp.prototype.toString = function() {
	return this.s;
};

// Class abego.MultiFieldRegExpTester
//
// @param fields [optional; Default: ["title","text","tags"]] array of names of fields to be considered
// @param withExtendedFields [optional; Default: false] when true also extended fields are considered (in addition to the ones given in 'fields')
//
abego.MultiFieldRegExpTester = function(re, fields, withExtendedFields) {
	this.re = re;
	this.fields = fields ? fields : ["title","text","tags"];
	this.withExtendedFields = withExtendedFields;
};

// Returns the name of the first field found that value succeeds the given test,
// or null when no such field is found
//
abego.MultiFieldRegExpTester.prototype.test = function(tiddler) {
	var re = this.re;
	// Check the fields explicitly specified
	for (var i = 0; i < this.fields.length; i++) {
		var s = store.getValue(tiddler, this.fields[i]);
		if (typeof s == "string" && re.test(s))
			return this.fields[i];		
	}
	// Check the extended fields (if required)
	if (this.withExtendedFields) 
		return store.forEachField(
			tiddler,
			function(tiddler, fieldName, value) {
				return typeof value == "string" && re.test(value) ? fieldName : null;
			}, 
			true
		);
		
	return null;
};

// Class abego.TiddlerQuery
//
//#import abego.select
//#import abego.MultiFieldRegExpTester
//
abego.TiddlerQuery = function(queryText,caseSensitive,useRegExp,defaultFields,withExtendedFields) {
	if (useRegExp) {
		this.regExp = new RegExp(queryText, caseSensitive ? "mg" : "img");
		this.tester = new abego.MultiFieldRegExpTester(this.regExp, defaultFields, withExtendedFields);
	} else {
		this.expr = new abego.BoolExp(
			queryText,
			abego.parseTiddlerFilterTerm, {
				defaultFields: defaultFields,
				caseSensitive: caseSensitive,
				withExtendedFields: withExtendedFields
			}
		);
	}
	
	this.getQueryText = function() {
		return queryText;
	};
	this.getUseRegExp = function() {
		return useRegExp;
	};
	this.getCaseSensitive = function() {
		return caseSensitive;
	};
	this.getDefaultFields = function() {
		return defaultFields;
	};
	this.getWithExtendedFields = function() {
		return withExtendedFields;
	};
};

// Returns true iff the query includes the given tiddler
//
// @param tiddler [may be null/undefined]
//
abego.TiddlerQuery.prototype.test = function(tiddler) {
	if (!tiddler) return false;
	if (this.regExp) {
		return this.tester.test(tiddler);
	}
	return this.expr.exec(tiddler);
};

// Returns an array with those tiddlers from the tiddlers array that match the query.
//
abego.TiddlerQuery.prototype.filter = function(tiddlers) {
	return abego.select(tiddlers,this.test,this);
};

abego.TiddlerQuery.prototype.getMarkRegExp = function() {
	if (this.regExp) {
		// Only use the regExp for marking when it does not match the empty string.
		return "".search(this.regExp) >= 0 ? null :  this.regExp;
	}
	return this.expr.getMarkRegExp();
};

abego.TiddlerQuery.prototype.toString = function() {
	return (this.regExp ? this.regExp : this.expr).toString();
};

// Class abego.PageWiseRenderer ================================================
//
// Subclass or instance must implement getItemsPerPage function;
// They should also implement onPageChanged and refresh the container of the
// PageWiseRenderer on that event.
//
//#import abego.toInt
//
abego.PageWiseRenderer = function() {
	this.firstIndexOnPage = 0; // The index of the first item of the lastResults list displayed on the search result page
};

merge(abego.PageWiseRenderer.prototype, { // abego_PageWiseRenderer_prototype
	setItems: function(items) {
		this.items = items;
		this.setFirstIndexOnPage(0);
	},
	
	// Maximum number of pages listed in the navigation bar (before or after the current page)
	//
	getMaxPagesInNavigation: function() {
		return 10;
	},
	
	getItemsCount: function(items) {return this.items ? this.items.length : 0;},
	
	getCurrentPageIndex: function() {return Math.floor(this.firstIndexOnPage / this.getItemsPerPage());},
	
	getLastPageIndex: function() {return Math.floor((this.getItemsCount()-1) / this.getItemsPerPage());},
	
	setFirstIndexOnPage: function(index) {this.firstIndexOnPage = Math.min(Math.max(0, index), this.getItemsCount()-1);},
	
	getFirstIndexOnPage: function() {
		// Ensure that the firstIndexOnPage is really a page start. 
		// This may have become violated when getItemsPerPage has changed,
		// (e.g. when switching between previewText and simple mode.)
		this.firstIndexOnPage = Math.floor(this.firstIndexOnPage / this.getItemsPerPage()) * this.getItemsPerPage();
	
		return this.firstIndexOnPage;
	},
	
	getLastIndexOnPage: function() {return Math.min(this.getFirstIndexOnPage()+this.getItemsPerPage()-1, this.getItemsCount()-1);},
	
	onPageChanged: function(pageIndex,oldPageIndex) {},
	
	renderPage: function(itemRenderer) {
		if (itemRenderer.beginRendering) itemRenderer.beginRendering(this);
		try {
			// When there are items found add them to the result page (pagewise)
			if (this.getItemsCount()) {
				// Add the items of the current page
				var lastIndex = this.getLastIndexOnPage();
				var iInPage = -1;
				for (var i=this.getFirstIndexOnPage(); i <= lastIndex; i++) {
					iInPage++;
					
					itemRenderer.render(this,this.items[i],i,iInPage);
				}
			}
		} finally {
			if (itemRenderer.endRendering)
				itemRenderer.endRendering(this);
		}
	},
	
	addPageNavigation: function(place) {
		if (!this.getItemsCount()) return;
	
		var self = this;
		var onNaviButtonClick = function(e) {
			if (!e) e = window.event;

			abego.consumeEvent(e);

			var pageIndex = abego.toInt(this.getAttribute("page"),0);
			var oldPageIndex = self.getCurrentPageIndex();
			if (pageIndex == oldPageIndex)
				return;
			var index = pageIndex * self.getItemsPerPage();
			self.setFirstIndexOnPage(index);
			self.onPageChanged(pageIndex,oldPageIndex);	
		};
	
		var button;
		var currentPageIndex = this.getCurrentPageIndex();
		var lastPageIndex = this.getLastPageIndex();
		if (currentPageIndex > 0) {
			button = renderTiddlyButton(place, "Previous", "Go to previous page (Shortcut: Alt-'<')", onNaviButtonClick, "prev");
			button.setAttribute("page",(currentPageIndex-1).toString());
			button.setAttribute("accessKey","<");
		}
	
		for (var i = -this.getMaxPagesInNavigation(); i < this.getMaxPagesInNavigation(); i++) {
			var pageIndex = currentPageIndex+i;
			if (pageIndex < 0) continue;
			if (pageIndex > lastPageIndex) break;
	
			var pageNo = (i+currentPageIndex+1).toString();
			var buttonClass = pageIndex == currentPageIndex ? "currentPage" : "otherPage";
			button = renderTiddlyButton(place, pageNo, "Go to page %0".format([pageNo]), onNaviButtonClick, buttonClass);
			button.setAttribute("page",(pageIndex).toString());
		}
		
		if (currentPageIndex < lastPageIndex) {
			button = renderTiddlyButton(place, "Next", "Go to next page (Shortcut: Alt-'>')", onNaviButtonClick, "next");
			button.setAttribute("page",(currentPageIndex+1).toString());
			button.setAttribute("accessKey",">");
		}
	}
}); // abego_PageWiseRenderer_prototype

// Class abego.LimitedTextRenderer ===========================================================
//
// Renders a given text, ensuring that a given limit of number of characters 
// is not exceeded.
//
// A "markRegExp" may be specified. Substring matching this regular expression 
// ("matched strings") are rendered with the class "marked". 
//
// if the given text is longer than the limit the matched strings are preferred 
// to be included in the rendered text (with some leading and trailing "context text"). 
// 
// Example:
//     var renderer = new abego.LimitedTextRenderer();
//
//     var place = ... // a DOM element that should contain the rendered (limited) text
//     var s = "This is another 'Hello World' example, as saying 'Hello' is always nice. So let's say it again: >Hello!<";
//     var maxLen = 50;
//     var markRE = /hello/gi;
//     renderer.render(place,s,maxLen,markRE);
// 
//
abego.LimitedTextRenderer = function() { // abego_LimitedTextRenderer
	var minMatchWithContextSize = 40; 
	var maxMovementForWordCorrection = 4; // When a "match" context starts or end on a word the context borders may be changed to at most this amount to include or exclude the word.
	
	//----------------------------------------------------------------------------
	//
	// Ranges
	//
	// Objects with a "start" and "end" property (not a specific class). 
	// 
	// In a corresponding "Ranges array" these objects are sorted by their start 
	// and no Range object intersects/touches any other in the array.
	//
	//----------------------------------------------------------------------------
	
	// Adds the Range [startIndex,endIndex[ to the ranges, ensuring that the Ranges
	// in the array are sorted by their start and no Range object 
	// intersects/touches any other in the array (i.e. possibly the new Range is 
	// "merged" with existing ranges)
	//
	// @param ranges array of Range objects
	//
	var addRange = function(ranges, startIndex, endIndex) {
		var n = ranges.length;
		
		// When there are no ranges in ranges, just add it.
		if (n == 0) {
			ranges.push({start: startIndex, end: endIndex});
			return;
		}
		
		var i = 0;
		for (; i < n; i++) {
			var range = ranges[i];
			
			// find the first range that intersects or "touches" [startIndex, endIndex[
			if (range.start <= endIndex && startIndex <= range.end) {
				// Found.
				
				var r;
				// find the first range behind the new range that does not interfere
				var rIndex = i+1;
				for (; rIndex < n; rIndex++) {
					r = ranges[rIndex];
					if (r.start > endIndex || startIndex > range.end) {
						break;
					}
				}
				
				// Replace the ranges i to rIndex-1 with the union of the new range with these ranges.
				var unionStart = startIndex;
				var unionEnd = endIndex;
				for (var j = i; j < rIndex; j++) {
					r = ranges[j];
					unionStart = Math.min(unionStart, r.start);
					unionEnd = Math.max(unionEnd, r.end);
				}
				ranges.splice(i, rIndex-i, {start: unionStart, end: unionEnd});
				return;			
			}
			
			// if we found a range R that is right of the new range there is no
			// intersection and we can insert the new range before R.
			if (range.start > endIndex) {
				break;
			}
		}
	
		// When we are here the new range does not interfere with any range in ranges and
		// i is the index of the first range right to it (or ranges.length, when the new range
		// becomes the right most range). 
	
		ranges.splice(i, 0, {start: startIndex, end: endIndex});
	};
	
	// Returns the total size of all Ranges in ranges
	//
	var getTotalRangesSize = function(ranges) {
		var totalRangeSize = 0;
		for (var i=0; i < ranges.length; i++) {
			var range = ranges[i];
			totalRangeSize += range.end-range.start;
		}
		return totalRangeSize;
	};
	
	//----------------------------------------------------------------------------
	
	var isWordChar = function(c) {return (c >= "a" && c <= "z") || (c >= "A" && c <= "Z") || c == "_";};
	
	// Returns the bounds of the word in s around offset as a {start: , end:} object.
	//
	// Returns null when the char at offset is not a word char.
	//
	var getWordBounds = function(s, offset) {
		// Handle the "offset is not in word" case
		if (!isWordChar(s[offset])) return null;
	
		for (var i = offset-1; i >= 0 && isWordChar(s[i]); i--){/*empty*/}
			
		var startIndex = i + 1;
		var n = s.length;
		for (i = offset + 1; i < n && isWordChar(s[i]); i++){/*empty*/}
		
		return {start: startIndex, end: i};
	};
	
	var moveToWordBorder = function(s, offset, isStartOffset) {
		var wordBounds;
		if (isStartOffset) {
			wordBounds = getWordBounds(s, offset);
		} else {
			if (offset <= 0) return offset;
			wordBounds = getWordBounds(s, offset-1);
		}
		if (!wordBounds) return offset;
		
		if (isStartOffset) {
			if (wordBounds.start >= offset-maxMovementForWordCorrection) return wordBounds.start;
			if (wordBounds.end <= offset+maxMovementForWordCorrection) return wordBounds.end;
		} else {
			if (wordBounds.end <= offset+maxMovementForWordCorrection) return wordBounds.end;
			if (wordBounds.start >= offset-maxMovementForWordCorrection) return wordBounds.start;
		}
		return offset;
	};
	
	// Splits s into a sequence of "matched" and "unmatched" substrings, using the 
	// matchRegExp to do the matching.
	// 
	// Returns an array of objects with a "text" property containing the substring text. 
	// Substrings that are "matches" also contain a boolean "isMatch" property set to true.
	// 
	// @param matchRegExp [may be null] when null no matching is performed and the returned 
	// 			array just contains one item with s as its text
	// 
	var getTextAndMatchArray = function(s, matchRegExp) {
		var result = [];
		if (matchRegExp) {
			var startIndex = 0;
			do {
				matchRegExp.lastIndex = startIndex;
				var match = matchRegExp.exec(s);
				if (match) {
					if (startIndex < match.index) {
						var t = s.substring(startIndex, match.index);
						result.push({text:t});
					}
					result.push({text:match[0], isMatch:true});
					startIndex = match.index + match[0].length;
				} else {
					result.push({text: s.substr(startIndex)});
					break;
				}
			} while (true);
		} else {
			result.push({text: s});
		}
		return result;
	};
	
	var getMatchedTextCount = function(textAndMatches) {
		var result = 0;
		for (var i=0; i < textAndMatches.length; i++) {
			if (textAndMatches[i].isMatch) {
				result++;
			}
		}
		return result;	
	};
	
	var getContextRangeAround = function(s, startIndex, endIndex, matchCount, maxLen) {
		// Partition the available space into equal sized areas for each match and one 
		// for the text start.
		// But the size should not go below a certain limit
		var size = Math.max(Math.floor(maxLen/(matchCount+1)), minMatchWithContextSize);
		
		// Substract the size of the range to get the size of the context.
		var contextSize = Math.max(size-(endIndex-startIndex), 0);
		// Two thirds of the context should be before the match, one third after.
		var contextEnd = Math.min(Math.floor(endIndex+contextSize/3), s.length);
		var contextStart = Math.max(contextEnd - size, 0);
	
		// If the contextStart/End is inside a word and the end of the word is
		// close move the pointers accordingly to make the text more readable.
		contextStart = moveToWordBorder(s, contextStart, true);
		contextEnd = moveToWordBorder(s, contextEnd, false);
		
		return {start: contextStart, end: contextEnd};
	};
	
	// Get all ranges around matched substrings with their contexts
	//
	var getMatchedTextWithContextRanges = function(textAndMatches, s, maxLen) {
		var ranges = [];
		var matchCount = getMatchedTextCount(textAndMatches);
		var pos = 0;
		for (var i=0; i < textAndMatches.length; i++) {
			var t = textAndMatches[i];
			var text = t.text;
			if (t.isMatch) {
				var range = getContextRangeAround(s, pos, pos+text.length, matchCount, maxLen);
				addRange(ranges, range.start, range.end);
			}
			pos += text.length;
		}
		return ranges;
	};
	
	var fillUpRanges = function(s, ranges, maxLen) {
		var remainingLen = maxLen - getTotalRangesSize(ranges);
		while (remainingLen > 0) {
			if (ranges.length == 0) {
				// No matches added yet. Make one large range.
				addRange(ranges, 0, moveToWordBorder(s, maxLen, false));
				return;
			} else {
				var range = ranges[0];
				var startIndex;
				var maxEndIndex;
				if (range.start == 0) {
					// The first range already starts at the beginning of the string.
	
					// When there is a second range fill to the next range start or to the maxLen.
					startIndex = range.end;
					if (ranges.length > 1) {
						maxEndIndex =  ranges[1].start;
					} else {
						// Only one range. Add a range after that with the complete remaining len 
						// (corrected to "beautify" the output)
						addRange(ranges, startIndex, moveToWordBorder(s, startIndex+remainingLen, false));
						return;
					}
				} else {
					// There is unused space between the start of the text and the first range.
					startIndex = 0;
					maxEndIndex = range.start;
				}
				var endIndex = Math.min(maxEndIndex, startIndex+remainingLen);
				addRange(ranges, startIndex, endIndex);
				remainingLen -= (endIndex-startIndex);
			}
		}
	};
	
	// Write the given ranges of s, using textAndMatches for marking portions of the text.
	//
	var writeRanges = function(place, s, textAndMatches, ranges, maxLen) {
		if (ranges.length == 0) return;
		
		// Processes the text between startIndex and endIndex of the textAndMatches
		// "writes" them (as DOM elements) at the given place, possibly as "marked" text.
		//
		// When endIndex is not the end of the full text an ellisis is appended. 
		//
		var writeTextAndMatchRange = function(place, s, textAndMatches, startIndex, endIndex) {
			var t;
			var text;
			
			// find the first text item to write
			var pos = 0;
			var i = 0;
			var offset = 0;
			for (;i < textAndMatches.length; i++) {
				t = textAndMatches[i];
				text = t.text;
				if (startIndex < pos+text.length) {
					offset = startIndex - pos;
					break;
				}
				pos += text.length;
			}
			
			var remainingLen = endIndex - startIndex;
			for (; i < textAndMatches.length && remainingLen > 0; i++) {
				t = textAndMatches[i];
				text = t.text.substr(offset);
				offset = 0;
				if (text.length > remainingLen) text = text.substr(0,remainingLen);
				
				if (t.isMatch) {
					createTiddlyElement(place,"span",null,"marked",text);
				} else {
					createTiddlyText(place, text);
				}
				remainingLen -= text.length;
			}
			
			if (endIndex < s.length) {
				abego.createEllipsis(place);
			}
		};
		
		// When the first range is not at the start of the text write an ellipsis("...")
		// (Ellipses between ranges are written in the writeTextAndMatchRange method)
		if (ranges[0].start > 0) abego.createEllipsis(place);
	
		var remainingLen = maxLen;
		for (var i = 0; i < ranges.length && remainingLen > 0; i++) {
			var range = ranges[i];
			var len = Math.min(range.end - range.start, remainingLen);
			writeTextAndMatchRange(place, s, textAndMatches, range.start, range.start+len);
			remainingLen -= len;
		}
	};
	
	this.render = function(place,s,maxLen,markRegExp) {
		if (s.length < maxLen) maxLen = s.length;
		
		var textAndMatches = getTextAndMatchArray(s, markRegExp);
		
		var ranges = getMatchedTextWithContextRanges(textAndMatches, s, maxLen);
		
		// When the maxLen is not yet reached add more ranges 
		// starting from the beginning until either maxLen or 
		// the end of the string is reached.
		fillUpRanges(s, ranges, maxLen);
	
		writeRanges(place, s, textAndMatches, ranges, maxLen);
	};
}; // abego_LimitedTextRenderer

(function() { // abego_closure

function alertAndThrow(msg) {
	alert(msg);
	throw msg;
};

abego.YourSearch = {};

//----------------------------------------------------------------------------
// The Search Core
//----------------------------------------------------------------------------

// Model Variables
var lastResults = undefined; // Array of tiddlers that matched the last search
var lastQuery = undefined; // The last Search query (TiddlerQuery)

var setLastResults = function(array) {
	lastResults = array;
};

var getLastResults = function() {
	return lastResults ? lastResults : [];
};

var getLastResultsCount = function() {
	return lastResults ? lastResults.length : 0;
};

// Standard Ranking Weights
var matchInTitleWeight = 4;
var precisionInTitleWeight = 10;
var matchInTagsWeight = 2;

var getMatchCount = function(s, re) {
	var m = s.match(re);
	return m ? m.length : 0;
};

var standardRankFunction = function(tiddler, query) {	
	// Count the matches in the title and the tags
	var markRE = query.getMarkRegExp();
	if (!markRE) return 1;
	
	var matchesInTitle = tiddler.title.match(markRE);
	var nMatchesInTitle =  matchesInTitle ? matchesInTitle.length : 0;
	var nMatchesInTags = getMatchCount(tiddler.getTagsTuple(), markRE);

	// Calculate the "precision" of the matches in the title as the ratio of
	// the length of the matches to the total length of the title.
	var lengthOfMatchesInTitle = matchesInTitle ? matchesInTitle.join("").length : 0;
	var precisionInTitle = tiddler.title.length > 0 ? lengthOfMatchesInTitle/tiddler.title.length : 0;
	
	// calculate a weighted score
	var rank= nMatchesInTitle * matchInTitleWeight 
			+ nMatchesInTags * matchInTagsWeight 
			+ precisionInTitle * precisionInTitleWeight 
			+ 1;

	return rank;
};

// @return Tiddler[]
//
var findMatches = function(store, searchText, caseSensitive, useRegExp, sortField, excludeTag) {
	lastQuery = null;
		
	var candidates = store.getArticlesQuickly();
	try {
		var defaultFields = [];
		if (config.options.chkSearchInTitle) defaultFields.push("title");
		if (config.options.chkSearchInText) defaultFields.push("text");
		if (config.options.chkSearchInTags) defaultFields.push("tags");
		lastQuery = new abego.TiddlerQuery(searchText, caseSensitive, useRegExp, defaultFields, config.options.chkSearchExtendedFields);
	} catch (e) {
		// when an invalid query is given no tiddlers are matched
		return [];
	}

	var results = lastQuery.filter(candidates);

	// Rank the results
	var rankFunction = abego.YourSearch.getRankFunction();
	for (var i = 0; i < results.length; i++) {
		var tiddler = results[i];
		var rank = rankFunction(tiddler, lastQuery);
		// Add the rank information to the tiddler.
		// This is used during the sorting, but it may also
		// be used in the result, e.g. to display some "relevance" 
		// information in the result	
		tiddler.searchRank = rank;	
	}
	
	// sort the result, taking care of the rank and the sortField	
	if (! sortField) {
		sortField = "title";
	}
	
	var sortFunction = function (a,b) {
		var searchRankDiff = a.searchRank - b.searchRank;
		if (searchRankDiff == 0) {
			if (a[sortField] == b[sortField]) {
				return(0); 
			} else {
				return (a[sortField] < b[sortField]) ? -1 : +1; 
			}
		} else {
			return (searchRankDiff > 0) ? -1 : +1; 
		}
	};
	results.sort(sortFunction);
	return results;
};

//----------------------------------------------------------------------------
// The Search UI (Result page)
//----------------------------------------------------------------------------

// Visual appearance of the result page
var maxCharsInTitle = 80;
var maxCharsInTags = 50;
var maxCharsInText = 250;
var maxCharsInField = 50;

var itemsPerPageDefault = 25; // Default maximum number of items on one search result page
var itemsPerPageWithPreviewDefault = 10; // Default maximum number of items on one search result page when PreviewText is on

// DOM IDs
var yourSearchResultID = "yourSearchResult";
var yourSearchResultItemsID = "yourSearchResultItems";

var lastSearchText = null; // The last search text, as passed to findMatches

var resultElement = null; // The (popup) DOM element containing the search result [may be null]
var searchInputField = null; // The "search" input field
var searchButton = null; // The "search" button

var isResultOpen = function() {
	return resultElement != null && resultElement.parentNode == document.body;
};

var closeResult = function() {
	if (isResultOpen()) {
		document.body.removeChild(resultElement);
	}
};

// Closes the Search Result window and displays the tiddler 
// defined by the "tiddlyLink" attribute of this element
//
var closeResultAndDisplayTiddler = function(e) {
	closeResult();
	
	var title = this.getAttribute("tiddlyLink");
	if(title) {
		var withHilite = this.getAttribute("withHilite");
		var oldHighlightHack = highlightHack;
		if (withHilite && withHilite == "true" && lastQuery) {
			highlightHack = lastQuery.getMarkRegExp();
		}
		story.showArticle(title);
		highlightHack = oldHighlightHack;
	}
	return(false);
};

// Adjusts the resultElement's size and position, relative to the search input field.
//
var adjustResultPositionAndSize = function() {
	if (!searchInputField) return;
	
	var root = searchInputField;
	
	// Position the result below the root and resize it if necessary.
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var rootHeight = root.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;

	// Make sure the result is not wider than the window
	var winWidth = findWindowWidth();
	if (winWidth < resultElement.offsetWidth) {
		resultElement.style.width = (winWidth - 100)+"px";
		winWidth = findWindowWidth();
	}

	// Ensure that the left and right of the result are not
	// clipped by the window. Move it to the left or right, if necessary.	
	var popupWidth = resultElement.offsetWidth;
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth-30;
	if (popupLeft < 0) popupLeft = 0;
	
	// Do the actual moving
	resultElement.style.left = popupLeft + "px";
	resultElement.style.top = popupTop + "px";
	resultElement.style.display = "block";
};

// Makes sure the result page has a good size and position and visible
// (may scroll the window)
//
var	ensureResultIsDisplayedNicely = function() {
	adjustResultPositionAndSize();	
};

var indexInPage = undefined; // The index (in the current page) of the tiddler currently rendered.

var currentTiddler = undefined; // While rendering the page the tiddler that is currently rendered.

var pager = new abego.PageWiseRenderer();

var MyItemRenderer = function(parent) {
	// Load the template how to display the items that represent a found tiddler
	this.itemHtml = store.getArticleTextPartOrSlice("YourSearchItemTemplate");
	if (!this.itemHtml) alertAndThrow("YourSearchItemTemplate not found");
	
	// Locate the node that shall contain the list of found tiddlers
	this.place = document.getElementById(yourSearchResultItemsID);
	if(!this.place)
		this.place = createTiddlyElement(parent,"div",yourSearchResultItemsID);
};

merge(MyItemRenderer.prototype, {
	render: function(pager, object, index, indexOnPage) {
		// Define global variables, referenced by macros during applyHtmlMacros
		indexInPage = indexOnPage;
		currentTiddler = object;
		
		var item = createTiddlyElement(this.place, "div", null, "yourSearchItem");
		item.innerHTML = this.itemHtml;
		applyHtmlMacros(item, null);
		refreshElements(item, null);
	},

	endRendering: function(pager) {
		// The currentTiddler must only be defined while rendering the found tiddlers
		currentTiddler = null;
	}
});

// Refreshes the content of the result with the current search result
// of the selected page.
//
// Assumes that the result is already open. 
//
var refreshResult = function() {
	if (!resultElement || !searchInputField) return;

	// Load the template for the YourSearchResult
	var html = store.getArticleTextPartOrSlice("YourSearchResultTemplate");
	if (!html) html = "<b>Tiddler YourSearchResultTemplate not found</b>";
	resultElement.innerHTML = html;

	// Expand the template macros etc.
	applyHtmlMacros(resultElement,null);
	refreshElements(resultElement,null);
	
	var itemRenderer = new MyItemRenderer(resultElement);
	pager.renderPage(itemRenderer);

	ensureResultIsDisplayedNicely();
};

pager.getItemsPerPage = function() {
	var n = (config.options.chkPreviewText) 
			? abego.toInt(config.options.txtItemsPerPageWithPreview, itemsPerPageWithPreviewDefault) 
			: abego.toInt(config.options.txtItemsPerPage, itemsPerPageDefault);
	return (n > 0) ? n : 1;
};

pager.onPageChanged = function() {
	refreshResult();
};

var	reopenResultIfApplicable = function() {
	if (searchInputField == null) return;
	
	if ((searchInputField.value == lastSearchText) && lastSearchText && !isResultOpen()) {
		// For speedup we check re-use the previously created resultElement, if possible.
		if (resultElement && (resultElement.parentNode != document.body)) {
			document.body.appendChild(resultElement);
			ensureResultIsDisplayedNicely();
		} else {
			abego.YourSearch.onShowResult(true);
		}
	}
};

var invalidateResult = function() {
	closeResult();
	resultElement = null;
	lastSearchText = null;
};

//-------------------------------------------------------------------------
// Close the search result page when the user clicks on the document
// (and not into the searchInputField, on the search button or in the result)
// or presses the ESC key

// Returns true if e is either self or a descendant (child, grandchild,...) of self.
//
// @param self DOM:Element
// @param e DOM:Element or null
//
var isDescendantOrSelf = function(self, e) {
	while (e != null) {
		if (self == e) return true;
		e = e.parentNode;
	}
	return false;
};

var onDocumentClick = function(e) {
	if (e.target == searchInputField) return; 
	if (e.target == searchButton) return; 
	if (resultElement && isDescendantOrSelf(resultElement, e.target)) return; 
	
	closeResult();
};

var onDocumentKeyup = function(e) {
	// Close the search result page when the user presses "ESC"
	if (e.keyCode == 27) closeResult();
};
addEvent(document,"click",onDocumentClick);
addEvent(document,"keyup",onDocumentKeyup);

// Our Search Macro Hijack Function ==========================================

// Helper
var myStorySearch = function(text,useCaseSensitive,useRegExp) {
	lastSearchText = text;
	setLastResults(findMatches(store, text,useCaseSensitive,useRegExp,"title","excludeSearch"));

	abego.YourSearch.onShowResult();
};

var myMacroSearchHandler = function(place, macroName, params, wikifier, paramString, tiddler) { // Implements IMacroResolver.handler()
	lastSearchText = "";
	var searchTimeout = null;
	var doSearch = function(txt) {		
		myStorySearch(txt.value, config.options.chkCaseSensitiveSearch, config.options.chkRegExpSearch);
		lastSearchText = txt.value;
	};
	var clickHandler = function(e) {
		doSearch(searchInputField);
		return false;
	};
	var keyHandler = function(e) {
		if (!e) e = window.event;
		searchInputField = this;
		switch (e.keyCode) {
			case 13:
				doSearch(this);
				break;
			case 27:
				// When the result is open, close it, 
				// otherwise clear the content of the input field
				if (isResultOpen()) {
					closeResult();
				} else {
					this.value = "";
					clearMessage();
				}
				break;
		}
		
		if (this.value.length < 3 && searchTimeout) clearTimeout(searchTimeout);
		
		if (this.value.length > 2) {
		 	if (this.value != lastSearchText) {
				if (config.options.chkSearchAsYouType) {
					if (searchTimeout) clearTimeout(searchTimeout);
					var txt = this;
					searchTimeout = setTimeout(function() {doSearch(txt);}, 500);
				}
			}	else {
				if(searchTimeout) clearTimeout(searchTimeout);
			}
		};
		if (this.value.length == 0) {closeResult();}
	};

	var focusHandler = function(e) {
		this.select();
		clearMessage();
		reopenResultIfApplicable();
	};
	
	var args = paramString.parseParams("list",null,true);		
	var txt = createTiddlyElement(null, "input", null, "txtOptionInput searchField", null);
	if (params[0])
		txt.value = params[0];
	txt.onkeyup = keyHandler;
	txt.onfocus = focusHandler;	
	// txt.setAttribute("accessKey", "f");
	txt.setAttribute("autocomplete", "off");
	if (config.browser.isSafari)	{
		txt.setAttribute("type", "search");
		txt.setAttribute("results", "5");
	}	else if (! config.browser.isIE) txt.setAttribute("type", "text");

	var btn = renderTiddlyButton(null, "🔎", null, clickHandler);
	place.appendChild(txt);
	place.appendChild(btn);

	searchInputField = txt;
	searchButton = btn;
};

//----------------------------------------------------------------------------
// Support for Macros
//----------------------------------------------------------------------------

var createOptionWithRefresh = function(place, optionParams, wikifier, tiddler) {
	invokeMacro(place, "option", optionParams, wikifier, tiddler);
	// The option macro appended the component at the end of the place.
	var elem = place.lastChild;
	var oldOnClick = elem.onclick;
	elem.onclick = function(e) {
		var result = oldOnClick.apply(this, arguments);
		refreshResult();
		return result;
	};
	return elem;
};

var removeTextDecoration = function(s) {
	var removeThis = ["''", "{{{", "}}}", "//", "<<<", "/***", "***/"];
	var reText = "";
	for (var i = 0; i < removeThis.length; i++) {
		if (i != 0) reText += "|";
		reText += "("+removeThis[i].escapeRegExp()+")";
	}
	return s.replace(new RegExp(reText, "mg"), "").trim();
};

// Returns the "shortcut number" of the currentTiddler. 
// I.e. When the user presses Alt-n the given tiddler is opened/display.
//
// @return 0-9 or -1 when no number is defined
//
var getShortCutNumber = function() {
	var i = indexInPage;
	return (i >= 0 && i <= 9) 
		? (i < 9 ? (i+1) : 0)
		: -1;
};

var limitedTextRenderer = new abego.LimitedTextRenderer();
var renderLimitedText = function(place, s, maxLen) {
	limitedTextRenderer.render(place,s,maxLen,lastQuery.getMarkRegExp());
};

// When any tiddler are changed reset the result.
// 
var oldTiddlyWikiSaveTiddler = ArticleStore.prototype.saveTiddler;
ArticleStore.prototype.saveTiddler = function(title, newTitle, newBody, modifier, modified, tags, fields) {
	oldTiddlyWikiSaveTiddler.apply(this, arguments);
	invalidateResult();
};

var oldTiddlyWikiRemoveTiddler = ArticleStore.prototype.removeTiddler;
ArticleStore.prototype.removeTiddler = function(title) {
	oldTiddlyWikiRemoveTiddler.apply(this, arguments);
	invalidateResult();
};

//----------------------------------------------------------------------------
// Macros
//----------------------------------------------------------------------------

// ====Macro yourSearch ================================================

config.macros.yourSearch = {
	// Standard Properties
	label: "yourSearch",
	prompt: "Gives access to the current/last YourSearch result",
	
	handler: function(place, macroName, params, wikifier, paramString, tiddler) {
		if (params.length == 0) return;
	
		var name = params[0];
		var func = config.macros.yourSearch.funcs[name];
		if (func) func(place, macroName, params, wikifier, paramString, tiddler);
	},
	
	tests: {
		"true" : function() {return true;},
		"false" : function() {return false;},
		"found" : function() {return getLastResultsCount() > 0;},
		"previewText" : function() {return config.options.chkPreviewText;}
	},

	funcs: {
		itemRange: function(place) {
			if (getLastResultsCount()) {
				var lastIndex = pager.getLastIndexOnPage();
				var s = "%0 - %1".format([pager.getFirstIndexOnPage()+1,lastIndex+1]);
				createTiddlyText(place, s);
			}
		},
		
		count: function(place) {
			createTiddlyText(place, getLastResultsCount().toString());
		},
		
		query: function(place) {
			if (lastQuery) {
				createTiddlyText(place, lastQuery.toString());
			}
		},
		
		linkButton: function(place, macroName, params, wikifier, paramString, tiddler) {
			if (params < 2) return;
			
			var	tiddlyLink = params[1];
			var text = params < 3 ? tiddlyLink : params[2];
			var tooltip = params < 4 ? text : params[3];
			var accessKey = params < 5 ? null : params[4];
			
			var btn = renderTiddlyButton(place, text, tooltip, closeResultAndDisplayTiddler, null, null, accessKey);
			btn.setAttribute("tiddlyLink", tiddlyLink);
		},
		
		closeButton: function(place,macroName,params,wikifier,paramString,tiddler) {
			renderTiddlyButton(place, "close", "Close the Search Results (Shortcut: ESC)", closeResult);
		},

		naviBar: function(place,macroName,params,wikifier,paramString,tiddler) {
			pager.addPageNavigation(place);
		},
		
		"if": function(place,macroName,params,wikifier,paramString,tiddler) {
			if (params.length < 2) return;
			
			var testName = params[1];
			var negate = (testName == "not");
			if (negate) {
				if (params.length < 3) return;
				testName = params[2];
			}
			
			var test = config.macros.yourSearch.tests[testName];
			var showIt = false;
			try {
				if (test) {
					showIt = test(place,macroName,params,wikifier,paramString,tiddler) != negate;
				} else {
					// When no predefined test is specified try to evaluate it as a JavaScript expression.
					showIt = (!eval(testName)) == negate;
				}
			} catch (ex) {
			}
			
			if (!showIt) {
				place.style.display="none";
			}
		},
		
		chkPreviewText: function(place,macroName,params,wikifier,paramString,tiddler) {
			var elem = createOptionWithRefresh(place, "chkPreviewText", wikifier,tiddler);
			elem.setAttribute("accessKey", "P");
			elem.title = "Show text preview of found tiddlers (Shortcut: Alt-P)";	
			return elem;
		}
	}
};

// ====Macro foundTiddler ================================================

config.macros.foundTiddler = {
	// Standard Properties
	label: "foundTiddler",
	prompt: "Provides information on the tiddler currently processed on the YourSearch result page",
	
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var name = params[0];
		var func = config.macros.foundTiddler.funcs[name];
		if (func) func(place,macroName,params,wikifier,paramString,tiddler);
	},
		
	funcs: {
		title: function(place,macroName,params,wikifier,paramString,tiddler) {
			if (!currentTiddler) return;
			
			var shortcutNumber = getShortCutNumber();
			var tooltip = shortcutNumber >= 0 
					? "Open tiddler (Shortcut: Alt-%0)".format([shortcutNumber.toString()])
					: "Open tiddler";
		
			var btn = renderTiddlyButton(place, null, tooltip, closeResultAndDisplayTiddler,null);
			btn.setAttribute("tiddlyLink", currentTiddler.title);
			btn.setAttribute("withHilite", "true");
			
			renderLimitedText(btn, currentTiddler.title, maxCharsInTitle);
		
			if (shortcutNumber >= 0) {
				btn.setAttribute("accessKey",shortcutNumber.toString());
			}
		},
		
		tags: function(place, macroName, params, wikifier, paramString, tiddler) {
			if (!currentTiddler) return;
		
			renderLimitedText(place, currentTiddler.getTagsTuple(), maxCharsInTags);
		},
		
		text: function(place, macroName, params, wikifier, paramString, tiddler) {
			if (!currentTiddler) return;
		
			renderLimitedText(place, removeTextDecoration(currentTiddler.text), maxCharsInText);
		},
		
		field:  function(place,macroName,params,wikifier,paramString,tiddler) {
			if (!currentTiddler) return;
			var	name = params[1];
			var len = params.length > 2 ? abego.toInt(params[2],maxCharsInField) : maxCharsInField;
			var v = store.getValue(currentTiddler,name);
			if (v)
				renderLimitedText(place, removeTextDecoration(v), len);
		},
		
		// Renders the "shortcut number" of the current tiddler, to indicate to the user
		// what number to "Alt-press" to open the tiddler.
		//
		number: function(place,macroName,params,wikifier,paramString,tiddler) {
			var numberToDisplay = getShortCutNumber();
			if (numberToDisplay >= 0) {
				var text = "%0)".format([numberToDisplay.toString()]);
				createTiddlyElement(place,"span",null,"shortcutNumber",text);
			}
		}
	}
};

//----------------------------------------------------------------------------
// Configuration Stuff
//----------------------------------------------------------------------------

var opts = {
	chkPreviewText:true,
	chkSearchAsYouType:true,
	chkSearchInTitle:true,
	chkSearchInText:true,
	chkSearchInTags:true,
	chkSearchExtendedFields:true,
	txtItemsPerPage:itemsPerPageDefault,
	txtItemsPerPageWithPreview:itemsPerPageWithPreviewDefault
};

for (var n in opts) 
	if (config.options[n] == undefined) config.options[n] = opts[n];

//----------------------------------------------------------------------------
// Shadow Tiddlers
//----------------------------------------------------------------------------

config.shadowTiddlers["YourSearch Help"] =
"!Field Search\nWith the Field Search you can restrict your search to certain fields of a tiddler, e.g"+
" only search the tags or only the titles. The general form is //fieldname//'':''//textToSearch// (e."+
"g. {{{title:intro}}}). In addition one-character shortcuts are also supported for the standard field"+
"s {{{title}}}, {{{text}}} and {{{tags}}}:\n|!What you want|!What you type|!Example|\n|Search ''titles "+
"only''|start word with ''!''|{{{!jonny}}} (shortcut for {{{title:jonny}}})|\n|Search ''contents/text "+
"only''|start word with ''%''|{{{%football}}} (shortcut for {{{text:football}}})|\n|Search ''tags only"+
"''|start word with ''#''|{{{#Plugin}}} (shortcut for {{{tags:Plugin}}})|\n\nUsing this feature you may"+
" also search the extended fields (\"Metadata\") introduced with TiddlyWiki 2.1, e.g. use {{{priority:1"+
"}}} to find all tiddlers with the priority field set to \"1\".\n\nYou may search a word in more than one"+
" field. E.g. {{{!#Plugin}}} (or {{{title:tags:Plugin}}} in the \"long form\") finds tiddlers containin"+
"g \"Plugin\" either in the title or in the tags (but does not look for \"Plugin\" in the text). \n\n!Boole"+
"an Search\nThe Boolean Search is useful when searching for multiple words.\n|!What you want|!What you "+
"type|!Example|\n|''All words'' must exist|List of words|{{{jonny jeremy}}} (or {{{jonny and jeremy}}}"+
")|\n|''At least one word'' must exist|Separate words by ''or''|{{{jonny or jeremy}}}|\n|A word ''must "+
"not exist''|Start word with ''-''|{{{-jonny}}} (or {{{not jonny}}})|\n\n''Note:'' When you specify two"+
" words, separated with a space, YourSearch finds all tiddlers that contain both words, but not neces"+
"sarily next to each other. If you want to find a sequence of word, e.g. '{{{John Brown}}}', you need"+
" to put the words into quotes. I.e. you type: {{{\"john brown\"}}}.\n\nUsing parenthesis you may change "+
"the default \"left to right\" evaluation of the boolean search. E.g. {{{not (jonny or jeremy)}}} finds"+
" all tiddlers that contain neither \"jonny\" nor \"jeremy. In contrast to this {{{not jonny or jeremy}}"+
"} (i.e. without parenthesis) finds all tiddlers that either don't contain \"jonny\" or that contain \"j"+
"eremy\".\n\n!'Exact Word' Search\nBy default a search result all matches that 'contain' the searched tex"+
"t. E.g. if you search for {{{Task}}} you will get all tiddlers containing 'Task', but also '~Complet"+
"edTask', '~TaskForce' etc.\n\nIf you only want to get the tiddlers that contain 'exactly the word' you"+
" need to prefix it with a '='. E.g. typing '=Task' will find the tiddlers that contain the word 'Tas"+
"k', ignoring words that just contain 'Task' as a substring.\n\n!~CaseSensitiveSearch and ~RegExpSearch"+
"\nThe standard search options ~CaseSensitiveSearch and ~RegExpSearch are fully supported by YourSearc"+
"h. However when ''~RegExpSearch'' is on Filtered and Boolean Search are disabled.\n\nIn addition you m"+
"ay do a \"regular expression\" search even with the ''~RegExpSearch'' set to false by directly enterin"+
"g the regular expression into the search field, framed with {{{/.../}}}. \n\nExample: {{{/m[ae][iy]er/"+
"}}} will find all tiddlers that contain either \"maier\", \"mayer\", \"meier\" or \"meyer\".\n\n!~JavaScript E"+
"xpression Filtering\nIf you are familiar with JavaScript programming and know some TiddlyWiki interna"+
"ls you may also use JavaScript expression for the search. Just enter a JavaScript boolean expression"+
" into the search field, framed with {{{ { ... } }}}. In the code refer to the variable tiddler and e"+
"valuate to {{{true}}} when the given tiddler should be included in the result. \n\nExample: {{{ { tidd"+
"ler.modified > new Date(\"Jul 4, 2005\")} }}} returns all tiddler modified after July 4th, 2005.\n\n!Com"+
"bined Search\nYou are free to combine the various search options. \n\n''Examples''\n|!What you type|!Res"+
"ult|\n|{{{!jonny !jeremy -%football}}}|all tiddlers with both {{{jonny}}} and {{{jeremy}}} in its tit"+
"les, but no {{{football}}} in content.|\n|{{{#=Task}}}|All tiddlers tagged with 'Task' (the exact wor"+
"d). Tags named '~CompletedTask', '~TaskForce' etc. are not considered.|\n\n!Access Keys\nYou are encour"+
"aged to use the access keys (also called \"shortcut\" keys) for the most frequently used operations. F"+
"or quick reference these shortcuts are also mentioned in the tooltip for the various buttons etc.\n\n|"+
"!Key|!Operation|\n|{{{Alt-F}}}|''The most important keystroke'': It moves the cursor to the search in"+
"put field so you can directly start typing your query. Pressing {{{Alt-F}}} will also display the pr"+
"evious search result. This way you can quickly display multiple tiddlers using \"Press {{{Alt-F}}}. S"+
"elect tiddler.\" sequences.|\n|{{{ESC}}}|Closes the [[YourSearch Result]]. When the [[YourSearch Resul"+
"t]] is already closed and the cursor is in the search input field the field's content is cleared so "+
"you start a new query.|\n|{{{Alt-1}}}, {{{Alt-2}}},... |Pressing these keys opens the first, second e"+
"tc. tiddler from the result list.|\n|{{{Alt-O}}}|Opens all found tiddlers.|\n|{{{Alt-P}}}|Toggles the "+
"'Preview Text' mode.|\n|{{{Alt-'<'}}}, {{{Alt-'>'}}}|Displays the previous or next page in the [[Your"+
"Search Result]].|\n|{{{Return}}}|When you have turned off the 'as you type' search mode pressing the "+
"{{{Return}}} key actually starts the search (as does pressing the 'search' button).|\n\n//If some of t"+
"hese shortcuts don't work for you check your browser if you have other extensions installed that alr"+
"eady \"use\" these shortcuts.//";

// todo remove shadow tiddler and integrate into global options
config.shadowTiddlers["YourSearch Options"] =
"|>|!YourSearch Options|\n|!|<<option chkPreviewText"+
">> Show Text Preview|\n|!|<<option chkSearchAsYouType>> 'Search As You Type' Mode (No RETURN required"+
" to start search)|\n|!|Default Search Filter:<<option chkSearchInTitle>>Title ('!')     <<option chk"+
"SearchInText>>Text ('%')     <<option chkSearchInTags>>Tags ('#')    <<option chkSearchExtendedFiel"+
"ds>>Extended Fields<html><br><font size=\"-2\">The fields of a tiddlers that are searched when you don"+
"'t explicitly specify a filter in the search text <br>(Explictly specify fields using one or more '!"+
"', '%', '#' or 'fieldname:' prefix before the word/text to find).</font></html>|\n|!|Number of items "+
"on search result page: <<option txtItemsPerPage>>|\n|!|Number of items on search result page with pre"+
"view text: <<option txtItemsPerPageWithPreview>>|\n";

config.shadowTiddlers["YourSearchResultTemplate"] =
"<!--\n" +
"{{{\n" +
"-->\n" +
"<span macro=\"yourSearch if found\">\n" +
"<!-- The Summary Header ============================================ -->\n" +
"<table class=\"summary\" border=\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\">"+
"<tbody>\n" +
"<tr>\n" +
"\t<td align=\"left\">\n" +
"\t\tResult <span class=\"yourSearchRange\" macro=\"yourSearch itemRange\"></span>\n" +
"\t\t&nbsp;of&nbsp;<span class=\"yourSearchCount\" macro=\"yourSearch count\"></span>\n" +
"\t\tfor&nbsp;<span class=\"yourSearchQuery\" macro=\"yourSearch query\"></span>\n" +
"\t</td>\n" +
"\t<td class=\"yourSearchButtons\" align=\"right\">\n" +
"\t\t<span macro=\"yourSearch chkPreviewText\"></span><span class=\"chkBoxLabel\">preview text</span>\n" +
"\t\t<span macro=\"yourSearch linkButton 'YourSearch Options' options 'Configure YourSearch'\"></span>\n" +
"\t\t<span macro=\"yourSearch linkButton 'YourSearch Help' help 'Get help how to use YourSearch'\"></span>\n" +
"\t\t<span macro=\"yourSearch closeButton\"></span>\n" +
"\t</td>\n" +
"</tr>\n" +
"</tbody></table>\n" +
"\n" +
"<!-- The List of Found Tiddlers ============================================ -->\n" +
"<div id=\"yourSearchResultItems\" itemsPerPage=\"25\" itemsPerPageWithPr"+
"eview=\"10\"></div>\n" +
"\n" +
"<!-- The Footer (with the Navigation) ============================================ -->\n" +
"<div class=\"yourSearchFooter\">Result page: <span class=\"yourSearchNaviBar\" macro=\"yourSearch naviBar\"></span>"+
"\n" +
"</div><!-- end of the 'tiddlers found' case =========================================== -->\n" +
"</span>\n" +
"\n" +
"\n" +
"<!-- The \"No tiddlers found\" case =========================================== -->\n" +
"<span macro=\"yourSearch if not found\">\n" +
"<table class=\"summary\" border="+
"\"0\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tbody>\n" +
"  <tr>\n" +
"\t<td align=\"left\">\n" +
"\t\tResu"+
"lt: No tiddlers found for <span class=\"yourSearchQuery\" macro=\"yourSearch query\"></span>.\n" +
"\t</td>\n" +
"\t<t"+
"d class=\"yourSearchButtons\" align=\"right\">\n" +
"\t\t<span macro=\"yourSearch linkButton 'YourSearch Options' options 'Configure YourSearch'\"></span>\n" +
"\t\t<span macro=\"yourSearch linkButton 'YourSearch Help' help 'Get help how to use YourSearch'\"></span>\n" +
"\t\t<span macro=\"yourSearch closeButton\"></span>\n" +
"\t</td>\n" +
"  <"+
"/tr>\n" +
"</tbody></table>\n" +
"</span>\n" +
"\n" +
"\n" +
"<!--\n" +
"}}}\n" +
"-->\n"
;

config.shadowTiddlers["YourSearchItemTemplate"] = 
	"<!--\n" +
	"{{{\n" +
	"-->\n" +
	"<span class='yourSearchNumber' macro='foundTiddler number'></span>\n" +
	"<span class='yourSearchTitle' macro='foundTiddler title'/></span>&nbsp;-&nbsp;\n" +
	"<span class='yourSearchTags' macro='foundTiddler field tags 50'/></span>\n" +
	"<span macro=\"yourSearch if previewText\"><div class='yourSearchText' macro='foundTiddler field text 250'/></div></span>\n" +
	"<!--\n}}}\n" +
	"-->"
;

//----------------------------------------------------------------------------
// Install YourSearch
//----------------------------------------------------------------------------

config.macros.search.handler = myMacroSearchHandler;

// === Public API =================================

abego.YourSearch.getStandardRankFunction = function() {
	return standardRankFunction;
};

abego.YourSearch.getRankFunction = function() {
	return abego.YourSearch.getStandardRankFunction();
};

abego.YourSearch.getCurrentTiddler = function() {
	return currentTiddler;
};

abego.YourSearch.closeResult = function() {
	closeResult();
};

// Returns an array of tiddlers that matched the last search
abego.YourSearch.getFoundTiddlers = function() {
	return lastResults;
};

// The last Search query (TiddlerQuery), or null
abego.YourSearch.getQuery = function() {
	return lastQuery;
};

abego.YourSearch.onShowResult = function(useOldResult) {
	highlightHack = lastQuery ? lastQuery.getMarkRegExp() : null;
	if (!useOldResult)
		pager.setItems(getLastResults());
	if (!resultElement) {
		resultElement = createTiddlyElement(document.body,"div",yourSearchResultID,"yourSearchResult");
	} else if (resultElement.parentNode != document.body) {
		document.body.appendChild(resultElement);
	}
	refreshResult();
	highlightHack = null;
};

})();  // abego_closure
} // // Ensure_that_the_Plugin_is_only_installed_once.

// Global Keyboard Handling

window.onkeydown = function(e) {
	if (e.ctrlKey && e.keyCode == 69) { // [Ctrl]-[E]
		var searchField = document.getElementsByClassName('searchField')[0];
		if (! searchField.onkeypress) {
			searchField.onkeypress = function(e) { // todo patch this directly into search code
				if (e.keyCode == 13) {
					// document.getElementsByClassName('yourSearchTitle')[0].firstChild.focus();
					var foundTiddlers = abego.YourSearch.getFoundTiddlers();
					story.showArticle(foundTiddlers[0].title);
					abego.YourSearch.closeResult();
					return false;
				};
			};
		}
		searchField.focus();
		searchField.select();
		return false;
	}
	if (e.ctrlKey && e.keyCode == 13) { // [Ctrl]-[Enter]
		config.commands.editTiddler.handler(e);  // Expects ICommand.handler()
    return false;
  };
};

//--
//-- Saving
//--

var storeAreaStartString = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var storeAreaStartRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var storeAreaEndString = '</d' + 'iv>';
var storeAreaEndStringUpperCase = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit() {
	hadConfirmExit = true;
	if ((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges() {
	if (store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if (confirm(config.messages.unsavedChangesWarning))	saveChangesAction();
	}
}

function updateMarkupBlock(s, blockName, tiddlerName) {
	return s.replaceChunk(
		"<!--%0-START-->".format([blockName]),
		"<!--%0-END-->".format([blockName]),
		"\n" + store.getArticleRawTextResolveIncludes(tiddlerName, "") + "\n"
	);
}

function injectAllArticles(htmlSource) {
	
	storeAreaRange = locateStoreArea(htmlSource);
	if (! storeAreaRange) throw "storeAreaRange not found!";
	
	var revisedHtmlSource = htmlSource.substr(0, storeAreaRange[0] + storeAreaStartString.length) + "\n" +
													store.allTiddlersAsHtml() + "\n" +
													htmlSource.substr(storeAreaRange[1]);
								
	var newSiteTitle = getPageTitle().htmlEncode();
	revisedHtmlSource = revisedHtmlSource.replaceChunk("<title"+">", "</title"+">", " " + newSiteTitle + " ");
	return revisedHtmlSource;
}

function locateStoreArea(original) {
	// Locate the storeArea divs
	if (! original) return null;
	var posOpeningDiv = original.search(storeAreaStartRE);
	var limitClosingDiv = original.indexOf("<" + "!--POST-STOREAREA--" + ">");
	if (limitClosingDiv == -1) limitClosingDiv = original.indexOf("<" + "!--POST-BODY-START--" + ">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(storeAreaEndString, start);
	if (posClosingDiv == -1) posClosingDiv = original.lastIndexOf(storeAreaEndStringUpperCase, start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv, posClosingDiv] : null;
}

function autoSaveChanges() {
	if (config.options.chkAutoSave) saveChangesAction();
}

function getHtmlSourceWithoutDynamicallyAddedContent() {
	var content = window.originalHTML || recreateOriginal();
	return content;
}

// Save this tiddlywiki with the pending changes
function saveChangesAction(forceManualMode) {
	clearMessage();	
	var msg = config.messages;
	var originalUrl = decodeURIComponent(document.location.toString()); // document.location is URL escaped like "file:///C:/Foo/V%C3%B6di%F0%9F%92%ADWiki.html"
	var localPath = getLocalPath(originalUrl);
	var outdatedHtmlSource = getHtmlSourceWithoutDynamicallyAddedContent();
	if (outdatedHtmlSource == null) {
		alert(msg.cantSaveError);
		return;
	}		
	var couldBeSavedAutomatically = injectArticlesAndSave(localPath, outdatedHtmlSource, forceManualMode);
	if (couldBeSavedAutomatically){
		store.setDirty(false);	
		displayMessage(config.messages.mainSaved);
	}
}

function injectArticlesAndSave(localPath, htmlSource, forceManualMode) {
	try {
		var revisedHtmlSource = injectAllArticles(htmlSource);
		return saveFile(localPath, revisedHtmlSource, forceManualMode);
	} catch (ex) {
		showException(ex);
		return false;
	}
}

function createEmptyWikiAction() {
	
	var originalPath = document.location.toString();
	var localPath = getLocalPath(originalPath);
	
	var emptyPath, p;
	if ((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if ((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	
	emptyPath += "New Wiki.html";
	
	var original = window.originalHTML;
	var storeAreaRange = locateStoreArea(original);
	var empty = original.substr(0, storeAreaRange[0] + storeAreaStartString.length) + original.substr(storeAreaRange[1]);
	
	var emptySave = saveFile(emptyPath, empty);
			
	if (emptySave){
		emptyPath = "file:///" + emptyPath;
		displayMessage(config.messages.emptySaved, emptyPath, -1);
	} else {
		alert(config.messages.emptyFailed);
	}
}

// Translate URL to local path [Preemption]
// e.g. "file:///C:/Foo/Bar/Batz.html" =>
//              "C:\\Foo\\Bar\\Batz.html"
window.getLocalPath = window.getLocalPath || function(uri) {	
	// Remove any location or query part of the URL
	var argPos = uri.indexOf("?");
	if (argPos != -1) uri = uri.substr(0, argPos);
	var hashPos = uri.indexOf("#");
	if (hashPos != -1) uri = uri.substr(0, hashPos);	
	if (uri.indexOf("file://localhost/") == 0) uri = "file://" + uri.substr(16); // Convert file://localhost/ to file:///
	// Convert to a native file format
	var localPath;
	if (uri.charAt(9) == ":") // pc local file
		localPath = uri.substr(8).replace(new RegExp("/","g"),"\\");
	else if (uri.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + uri.substr(10).replace(new RegExp("/","g"),"\\");
	else if (uri.indexOf("file:///") == 0) // mac/unix local file
		localPath = uri.substr(7);
	else if (uri.indexOf("file:/") == 0) // mac/unix local file
		localPath = uri.substr(5);
	else // pc network file
		localPath = "\\\\" + uri.substr(7).replace(new RegExp("/","g"),"\\");
				
	return localPath;
}

function getFileName(url, withoutExtension){
	
	var fileName, p;
	if ((p = url.lastIndexOf("/")) != -1)
		fileName = url.substr(p + 1);
	else if ((p = url.lastIndexOf("\\")) != -1)
		fileName = url.substr(p + 2);
	else
		fileName = url;
	
	if (withoutExtension){
		if ((p = fileName.lastIndexOf(".")) != -1) fileName = fileName.substr(0, p);
	}
	return fileName;
}

//--
//-- Filesystem code
//--

// Save a file in filesystem [Preemption]
// Returns true, if saving was possible unattendedly (without forcing the user to download manually)
window.saveFile = window.saveFile || function(fileUrl, htmlSource, forceManualMode) {
	
	if (! forceManualMode) if (saveFileViaBlobApi(fileUrl, htmlSource)) return true;
		
	// Fallback: Create data URL link for manual download
		
	var dataUrl = "data:text/html;charset=UTF-8;base64," + encodeBase64(unescape(encodeURIComponent(htmlSource)));
	// JavaScript strings are UTF-16.
	// encodeURIComponent() will re-encode the UTF-16 string to UTF-8, but unfortunalely escape all URL-poison-chars/spaces
	// after calling unescape() you get pure UTF-8
	
	displayMessage(config.messages.mainDownloadManual, dataUrl, -1);		
	return false;
}

// Resolve the element that triggered an event
function resolveSender(e) {
	var obj;
	if (e.target)
		obj = e.target;
	else if (e.srcElement)
		obj = e.srcElement;
	if (obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e, message) {
	var s = e.description || e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message) {
	alert(exceptionText(e,message));
}

function alertAndThrow(m) {
	alert(m);
	throw(m);
}

function createTiddlyText(parent, text) {
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent, caption, checked, onChange) {
	var cb = document.createElement("input");
	cb.setAttribute("type", "checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if (caption) wikify(caption, parent);
	return cb;
}

function createTiddlyElement(parent, tagName, id, className, text, attribs) {
	var e = document.createElement(tagName);
	if (className != null) e.className = className;
	if (id != null)	e.setAttribute("id", id);
	if (text != null)	e.appendChild(document.createTextNode(text));
	if (attribs) {
		for (var n in attribs) {
			e.setAttribute(n, attribs[n]);
		}
	}
	if (parent != null)	parent.appendChild(e);
	return e;
}

/**
	* Renders a link.
	*
	* @param  {element}   parent    - Optional. The newly created link will be appended as new child to the parent element.
	* @param  {string}    text      - Optional. The text will become the inner html of the <a>...</a>.
	* @param  {string}    tooltip   - Optional.
	* @param  {function}  action    - Optional. This delegate will be called when the link is invoked.
	* @param  {string}    className - Optional. CSS class name(s). If omitted, "button" will be used as default.
	* @param  {string}    id        - Optional.
	* @param  {string}    accessKey - Optional.
	* @param  {hashtable} attribs   - Optional. These attributes will be added to the <a> tag.
*/
function renderTiddlyButton(parent, text, tooltip, action, className, id, accessKey, attribs, icon) {
	var btn = document.createElement("a");
	btn.setAttribute("href", "javascript:;");
	if (action) btn.onclick = action;
	if (tooltip) btn.setAttribute("title", tooltip);
	if (icon)	btn.appendChild((function() { var i = document.createElement("div"); i.innerHTML = icon; return i;})());
	if (text)	btn.appendChild(document.createTextNode(text));
	btn.className = className || (icon ? "button buttonWithIcon" : "button");
	if (id)	btn.id = id;
	if (attribs) {
		for (var i in attribs) {
			btn.setAttribute(i, attribs[i]);
		}
	}
	if (parent)	parent.appendChild(btn);
	if (accessKey) btn.setAttribute("accessKey", accessKey);
	return btn;
}

function renderExternalLink(place, url, label) {
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	var f = config.messages.externalLinkTooltip;
	link.title = f ? f.format([url]) : url;
	if (config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	if (label)
		createTiddlyText(link, label);
	return link;
}

function buildClassNames(title, additionalClassNames) {
	var classes = additionalClassNames ? additionalClassNames.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.getArticle(title);
	if (tiddler) {
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if (isShadowTiddler(title)) {
			classes.pushUnique("shadow");
		} else {
			classes.remove("shadow");
		}
	}	
	return classes.join(" ");
}

function onLinkElementClicked(ev) {
	var e = ev || window.event;
	var sender = resolveSender(e);
	var title = sender.getAttribute("tiddlyLink");
	var sectionName = sender.getAttribute('section');
	var articleView = story.getArticleViewByChild(sender); 
	var senderTitle = articleView ? articleView.getAttribute('tiddler') : '';
	
	if (title != senderTitle || ! sectionName) { // link target is not on the current page
		story.showArticle(title);
	}
	
	clearMessage();
	
	// Select section element
	
	if (sectionName) {
		var sectionElement = story.scrollToSection(title, sectionName);
		if (sectionElement){
			var range = document.createRange();
			range.selectNodeContents(sectionElement);
			var sel = window.getSelection();
			sel.removeAllRanges();
			sel.addRange(range);
		}
	}
			
	return false;
}

/**
	* Renders a link element (<a>)
	*
	* @param  {element} place                - Container element in which the link should be created
	* @param  {string}  titleAndSection      - Target. E.g. "##SectionName"
	* @param  {boolean} useTitleAsLabel      - If true, the title will become the inner html of the <a>...</a> tag. Otherwise it'll be left empty, so one has to insert stuff afterwards.
	* @param  {string}  additionalClassNames - Additional CSS class names (to be added after default class names).
	*                                          Defaults for internal links: "tiddlyLink", "tiddlyLinkExisting", "tiddlyLinkNonExisting"
	*                                          Defaults for external links: "externalLink"
	* @param  {boolean} isStatic             - Set true for external links.
	*
	* @return {element} - An <a> element.
*/
function renderLinkElement(place, titleAndSection, useTitleAsLabel, additionalClassNames, isStatic) {
	var parts = titleAndSection.split(config.textPrimitives.sectionSeparator);
	var title = parts[0]; 
	var section = parts[1]; 
	if (section) section = section.trim();
	
	if (! title.length) { // Fallback: if title is empty => use title of the article in which the link is rendered
		var articleView = story.getArticleViewByChild(place);
		title = articleView ? articleView.getAttribute('tiddler') : '';
	}
	
	title = title.trim();
	var label = useTitleAsLabel ? title : null;
	var classNames = buildClassNames(title, additionalClassNames);
	var btn;
	if (isStatic) {
		btn = renderExternalLink(place, store.getArticleTextPartOrSlice("SiteUrl", null) + "#" + title) 
		btn.className += ' ' + additionalClassNames;
	} else {
		btn = renderTiddlyButton(place, label, null, onLinkElementClicked, classNames);
	}
	btn.setAttribute("refresh", "link");
	btn.setAttribute("tiddlyLink", title);
	if (section) {
		btn.setAttribute('section', section);
		if (! store.getArticleTextPartOrSlice(title + config.textPrimitives.sectionSeparator + section))
			addClass(btn, 'tiddlyLinkNonExistingSection');
	}
	return btn;
}

function createTiddlyDropDown(place, onchange, options, defaultValue) {
	var sel = createTiddlyElement(place, "select");
	sel.onchange = onchange;
	var t;
	for (t = 0; t < options.length; t++) {
		var e = createTiddlyElement(sel, "option", null, null, options[t].caption);
		e.value = options[t].name;
		if (options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}

//--
//-- Popup utility functions
//--

/**
	* Event handler after clicking on a tag - will pop up a list of articles matching the clicked tag.
	*
	* @param  {element} ev - the <a> which represented the tag
*/
function onClickTag(ev) { // (do not mix up with onTagClick)
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getArticleTitle();
	if (popup && tag) {
		var foundArticles = tag.indexOf("[") == -1 ? store.getArticlesByTag(tag) : store.filterTiddlers(tag);
		var sortBy = this.getAttribute("sortby");
		if (sortBy && sortBy.length) {
			store.sortTiddlers(foundArticles, sortBy);
		}
		var titles = [];
		var r;
		for (r = 0; r < foundArticles.length; r++) {
			if (foundArticles[r].title != title)
				titles.push(foundArticles[r].title);
		}
		var lingo = config.views.wikified.tag;
		if (titles.length > 0) {
			createTiddlyElement(createTiddlyElement(popup, "li", null, "listBreak"), "div");
			for (r = 0; r < titles.length; r++) {
				renderLinkElement(createTiddlyElement(popup, "li"), titles[r], true);
			}
		} else {
			createTiddlyElement(popup, "li", null, "disabled", lingo.popupNone.format([tag])); // HACK: Kann theoretisch niemals vorkommen, dass tags aufgelistet werden, für die es keine Artikel gibt.
		}		
	}
	Popup.show();
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place, tag, excludeTiddler, title, tooltip) {
	var btn = renderTiddlyButton(place, title || tag, (tooltip || config.views.wikified.tag.tooltip).format([tag]), onClickTag);
	btn.setAttribute("tag", tag);
	if (excludeTiddler)
		btn.setAttribute("tiddler", excludeTiddler);
	return btn;
}

// Renders a popup showing the error detail text.
function onClickError(ev) {
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorDetails").split("\n");
	var t;
	for (t = 0; t < lines.length; t++)
		createTiddlyElement(popup, "li", null, null, lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return false;
}

// Renders a button showing the error (label) text and carrying the error detail text inside - which will be shown as popup when the button is clicked.
function createTiddlyError(place, label, details) {
	var btn = renderTiddlyButton(place, label, null, onClickError, "errorButton");
	if (details) btn.setAttribute("errorDetails", details);
}

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
};

Popup.create = function(root, elem, className) {
	var stackPosition = this.find(root, "popup");
	Popup.remove(stackPosition + 1);
	var popup = createTiddlyElement(document.body, elem || "ol", "popup", className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev) {
	var e = ev || window.event;
	if (e.eventPhase == undefined)
		Popup.remove();
	else if (e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign, halign, offset) {
	var curr = Popup.stack[Popup.stack.length - 1];
	this.place(curr.root, curr.popup, valign, halign, offset);
	jQuery(curr.root).addClass("highlight");	
	window.scrollTo(0, ensureVisible(curr.popup));
};

Popup.place = function(root, popup, valign, halign, offset) {
	if (!offset)
		offset = {x:0,y:0};
	if (popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if (popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if (popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if (halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e) {
	var t,pos = -1;
	for (t = this.stack.length - 1; t >= 0; t--) {
		if (isDescendant(e, this.stack[t].popup))
			pos = t;
	}
	return pos;
};

Popup.remove = function(pos) {
	if (!pos) pos = 0;
	if (Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from) {
	var t;
	for (t = Popup.stack.length - 1; t >= from; t--) {
		var p = Popup.stack[t];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- WizardPresenter
//--

function WizardPresenter(anyElementInAnExistingWizardView) {
	if (anyElementInAnExistingWizardView) {
		this.formElem = navigateThroughDom(anyElementInAnExistingWizardView, "wizard", "className");
		this.bodyElem = navigateThroughDom(this.formElem.firstChild, "wizardBody", "className", "nextSibling");
		this.footElem = navigateThroughDom(this.formElem.firstChild, "wizardFooter", "className", "nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

WizardPresenter.prototype.setValue = function(name,value) {
	jQuery(this.formElem).data(name, value);
};

WizardPresenter.prototype.getValue = function(name) {
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

// Creates a new wizard view element (a form with class "wizard"). The view will carry all wizard states (the presenter is passive).
WizardPresenter.prototype.renderNewView = function(place, title) {
	this.formElem = createTiddlyElement(place, "form", null, "wizard");
	createTiddlyElement(this.formElem, "div", null, "title", title);
	this.bodyElem = createTiddlyElement(this.formElem, "div", null, "wizardBody");
	this.footElem = createTiddlyElement(this.formElem, "div", null, "wizardFooter");
	return this.formElem;
};

WizardPresenter.prototype.clear = function() {
	jQuery(this.bodyElem).empty();
};

WizardPresenter.prototype.renderFooterContent = function(buttonInfos, statusText) {
	jQuery(this.footElem).empty();
	
	var e = createTiddlyElement(this.footElem, "div", null, "status");
	if (statusText) e.innerHTML = statusText;
		
	for (var i = 0; i < buttonInfos.length; i++) {
		renderTiddlyButton(this.footElem, buttonInfos[i].caption, buttonInfos[i].tooltip, buttonInfos[i].onClick);
		insertSpacer(this.footElem);
	}
};

WizardPresenter.prototype.renderBodyContent = function(headlineText, html) {
	jQuery(this.bodyElem).empty();
	var wrapper = createTiddlyElement(this.bodyElem, "div");
	createTiddlyElement(wrapper, "h1", null, null, headlineText);
	var step = createTiddlyElement(wrapper, "div", null, "wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step);
};

WizardPresenter.prototype.getElement = function(name) {
	return this.formElem.elements[name];
};

//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview

ListView.create = function(place, dataSource, listTemplate, callback, className) {
	var table = createTiddlyElement(place, "table", null, className || "listView twtable");
	var thead = createTiddlyElement(table, "thead");
	var tr = createTiddlyElement(thead, "tr");
	
	// Render header cells
	
	for (var i = 0; i < listTemplate.columns.length; i++) {
		var columnTemplate = listTemplate.columns[i];
		var td = createTiddlyElement(tr, "th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if (colType && colType.createHeader) {
			colType.createHeader(td, columnTemplate, i);
			if (columnTemplate.className) jQuery(td).addClass(columnTemplate.className);
		}
	}
	
	// Render rows
	
	var i, tbody = createTiddlyElement(table, "tbody");
	for (i = 0; i < dataSource.length; i++) {
		var item = dataSource[i];
		tr = createTiddlyElement(tbody, "tr");
		for (var j = 0; j < listTemplate.rowClasses.length; j++) {
			if (item[listTemplate.rowClasses[j].field]) // if the item contains a non-null-property mathing the name of any "rowClasses" field...
				jQuery(tr).addClass(listTemplate.rowClasses[j].className); // ...add the CSS class of rowClasses[td].className to the whole tr
		}
		item.rowElement = tr;
		item.tableCellByFieldName = {};
		for (x = 0; x < listTemplate.columns.length; x++) { // cells
			td = createTiddlyElement(tr, "td");
			columnTemplate = listTemplate.columns[x];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if (colType && colType.createItem) {
				colType.createItem(td,item,field,columnTemplate,x,i);
				if (columnTemplate.className)
					jQuery(td).addClass(columnTemplate.className);
			}
			item.tableCellByFieldName[field] = td; // HACK: bi-directional wire-up from view model to UI element
		}
	}
	
	if (callback && listTemplate.actions) createTiddlyDropDown(place, ListView.getCommandHandler(callback), listTemplate.actions);
	
	if (callback && listTemplate.buttons) {
		for (x = 0; x < listTemplate.buttons.length; x++) {
			var a = listTemplate.buttons[x];
			if (a && a.name != "")
				renderTiddlyButton(place, a.caption, null, ListView.getCommandHandler(callback, a.name, a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback, name, allowEmptySelection) {
	return function(e) {
		var view = navigateThroughDom(this, "TABLE", null, "previousSibling");
		var tiddlers = [];
		ListView.forEachSelectedCheckbox(view,function(e, rowName) {
			if (e.checked)
				tiddlers.push(rowName);
		});
		if (tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if (this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selected checkbox in the listview
ListView.forEachSelectedCheckbox = function(view, callback) { // view is a table element
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for (var i = 0; i < checkboxes.length; i++) {
		var cb = checkboxes[i];
		if (cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if (rn) {
				callback(cb, rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view) {
	var rowNames = [];
	ListView.forEachSelectedCheckbox(view,function(e, rowName) {
		if (e.checked)
			rowNames.push(rowName);
	});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place, columnTemplate, col) {
		createTiddlyText(place, columnTemplate.title);
	},
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		if (v != undefined)
			createTiddlyText(place,v);
	}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		if (v != undefined)
			wikify(v,place,null,null);
	}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var v = listObject[field];
		if (v != undefined && v.title)
			renderLinkElement(place, v.title, true);
	}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var msg = config.messages.sizeTemplates;
		var v = listObject[field];
		if (v != undefined) {
			var t = 0;
			while (t<msg.length-1 && v<msg[t].unit)
				t++;
			createTiddlyText(place,msg[t].template.format([Math.round(v/msg[t].unit)]));
		}
	}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		var c = columnTemplate.text;
		if (v != undefined)
			renderExternalLink(place,v,c || v);
	}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		if (v != undefined)
			createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
	}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		if (v != undefined) {
			var t;
			for (t=0; t<v.length; t++) {
				createTiddlyText(place,v[t]);
				createTiddlyElement(place,"br");
			}
		}
	}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col) {
		createTiddlyCheckbox(place,null,false,this.onHeaderChange);
	},
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var e = createTiddlyCheckbox(place,null,listObject[field],null);
		e.setAttribute("rowName",listObject[columnTemplate.rowName]);
	},
	onHeaderChange: function(e) {
		var state = this.checked;
		var view = navigateThroughDom(this, "TABLE");
		if (!view)
			return;
		ListView.forEachSelectedCheckbox(view, function(e, rowName) {
			e.checked = state;
		});
	}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var tags = listObject[field];
		createTiddlyText(place,String.buildInternalLinksTuple(tags));
	}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		if (listObject[field] == true)
			createTiddlyText(place,columnTemplate.trueText);
		if (listObject[field] == false)
			createTiddlyText(place,columnTemplate.falseText);
	}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place, listObject, field, columnTemplate, col, row) {
		var e = createTiddlyCheckbox(place, null, listObject[field], this.onChange);
		e.setAttribute("tiddler", listObject.title);
		e.setAttribute("tag", columnTemplate.tag);
	},
	onChange : function(e) {
		var tag = this.getAttribute("tag");
		var title = this.getAttribute("tiddler");
		store.setTiddlerTag(title, this.checked, tag);
	}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row) {
		var v = listObject[field];
		if (v != undefined) {
			var link = renderLinkElement(place, listObject[columnTemplate.tiddlerLink]);
			createTiddlyText(link, listObject[field]);
		}
	}
};

//--
//-- Augmented methods for the JavaScript Array() object
//--

// Add indexOf function if browser does not support it
if (! Array.indexOf) {
	Array.prototype.indexOf = function(item, from) {
		if (! from) from = 0;
		for (var i = from; i < this.length; i++) {
			if (this[i] === item) return i;
		}
		return -1;
	};
}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field, value) {
	for (var i = 0; i < this.length; i++) {
		if (this[i][field] === value)
			return i;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item) {
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.addOrRemoveOrToggle = function(value, mode) {
	var p = this.indexOf(value);
	if (mode == 0) mode = (p == -1) ? +1 : -1;
	if (mode == +1) {
		if (p == -1) this.push(value);
	} else if (mode == -1) {
		if (p != -1) this.splice(p, 1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items) {
	var i;
	for (i=0; i<items.length; i++) {
		if (this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items) {
	var i;
	for (i = 0; i<items.length; i++) {
		if (this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item, unique) {
	if (unique === false) {
		this.push(item);
	} else {
		if (this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item) {
	var p = this.indexOf(item);
	if (p != -1)
		this.splice(p,1);
};

if (!Array.prototype.map) {
	Array.prototype.map = function(fn,thisObj) {
		var scope = thisObj || window;
		var i,j,a = [];
		for (i=0, j=this.length; i < j; ++i) {
			a.push(fn.call(scope,this[i],i,this));
		}
		return a;
	};
}

//--
//-- Augmented methods for the JavaScript String() object
//--

// Get characters from the right end of a string
String.prototype.right = function(n) {
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function() {
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function() {
	var t,s = this.split("-");
	if (s.length > 1) {
		for (t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s) {
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match,r = [];
	do {
		match = subRegExp.exec(this);
		if (match && match[1]) {
			if (match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1],10)]);
			currPos = subRegExp.lastIndex;
		}
	} while (match);
	if (currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function() {
	var s = "\\^$*+?()=!|,{}[].";
	var t,c = this;
	for (t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function() {
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function() {
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

String.prototype.lineBreaksToBr = function() {
	return this.replace(/(?:\r\n|\r|\n)/g, '<br/>');
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function() {
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function() {
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

/**
	* Parse a space-separated string tuple of lone tags or name:value pairs. Valid Examples (all creating an equal result)
	*   idiot nickName:john age:42 fullName:[[John Smith]] [[Zip Number]]:12345 iq:
	*   idiot nickName:john age:42 fullName:"John Smith" "Zip Number":12345 iq:
	*   idiot nickName:john age:42 fullName:'John Smith' 'Zip Number':12345 iq:
	*
	* @param  {string}  defaultName     - Optional. Will be used as boilerplate name for tags (in the example: "idiot" => "defaultName:idiot")
	* @param  {string}  defaultValue    - Optional: Will be used as fallback value for missing values (in the example: "iq:" => "iq:defaultValue")
	* @param  {boolean} allowEval       - If true, names or values quoted with {{double-curly braces}} are evaluated as a JavaScript expression
	* @param  {boolean} noNames         - Name prefixes are not allowed if the 'noNames' parameter is true - huh???
	* @param  {boolean} cascadeDefaults - If true, then the defaults are modified by updated by each specified name or value - huh???
	*
	* @return {array[0]}  - object with a member for each parameter name, value of that member being an array of values
	* @return {array[>0]} - one object for each parameter, with 'name' and 'value' members
*/
String.prototype.parseParams = function(defaultName, defaultValue, allowEval, noNames, cascadeDefaults) {
	var parseToken = function(match, p) {
		var n;
		if (match[p]) // Double quoted
			n = match[p];
		else if (match[p + 1]) // Single quoted
			n = match[p + 1];
		else if (match[p + 2]) // Double-square-bracket quoted
			n = match[p + 2];
		else if (match[p + 3]) // Double-brace quoted
			try {
				n = match[p + 3];
				if (allowEval && config.evaluateMacroParameters != "none") {
					if (config.evaluateMacroParameters == "restricted") {
						if (window.restrictedEval) {
							n = window.restrictedEval(n);
						}
					} else {
						n = window.eval(n);
					}
				}
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if (match[p + 4]) // Unquoted
			n = match[p + 4];
		else if (match[p + 5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var match;
	do {
		match = re.exec(this);
		if (match) {
			var n = parseToken(match, 1);
			if (noNames) {
				r.push({name: "", value: n});
			} else {
				var v = parseToken(match, 8);
				if (v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if (v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if (cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while (match);
	// Summarise parameters into first element
	for (var t = 1; t < r.length; t++) {
		if (r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval) {
	var p = this.parseParams("list", null, ! notAllowEval, true);
	var n = [];
	for (var t = 1; t < p.length; t++) n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique) {
	var p = this.parseParams("list", null, false, true);
	var n = [];
	for (var t = 1; t < p.length; t++) {
		if (p[t].value) n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end) {
	var s = this.indexOf(start);
	if (s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if (e != -1) return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub) {
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end) {
	var r = this.getChunkRange(start,end);
	if (r)
		return this.substring(r[0],r[1]);
};

// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title) {
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.buildInternalLinksTuple = function(list) {
	if (list) {
		var results = [];
		for (var t = 0; t < list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a space-separated string tuple of "name:value name:value ..." pairs into a hashmap (= Dictionary(Of String, String))
String.prototype.decodeHashMap = function() {
	var fields = this.parseParams("anon", "", false);
	var r = {};
	for (var t = 1; t < fields.length; t++) r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a [name:"value" name:"value" ...] string tuple (space separated)
String.encodeHashMap = function(hashmap) {
	var t,r = [];
	for (t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d) {
	var s = n.toString();
	if (s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix) {
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue) {
	if (!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue) {
	return !!getParam(params,name,defaultValue);
}

//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template) {
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	t = t.replace(/\\/g,"");
	return t;
};

Date.prototype.getWeek = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function() {
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function() {
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function() {
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function() {
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function() {
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function() {
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),3) +"0";
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d) {
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,12));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d) {
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,14));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d) {
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2)||"00",10),
			parseInt(d.substr(10,2)||"00",10),
			parseInt(d.substr(12,2)||"00",10),
			parseInt(d.substr(14,3)||"000",10)));
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r, g, b) {
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if (typeof r == "string") {
		if (r.substr(0,1) == "#") {
			if (r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if (c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f) {
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function() {
	var clamp = function(x, min, max) {
		return x < min ? min : (x > max ? max : x);
	};
	return "#" +
			("0" + Math.floor(clamp(this.r,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.g,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.b,0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function addEvent(obj, type, fn) { // xxx
	if (obj.attachEvent) {
		obj["e"+type+fn] = fn;
		obj[type+fn] = function() {obj["e"+type+fn](window.event);};
		obj.attachEvent("on"+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn) {
	if (obj.detachEvent) {
		obj.detachEvent("on"+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

// Navigate through me and my parents until a tag of name <value> is found.
// value                  - 
// searchBy               - Normally the element's tagName is inspected (like "div, span, table, ..."). By specifying searchBy you can e.g. search by "className".
// navigationPropertyName - Normally, the crawler navigates invoking "parentNode" - you can specify any suitable element property name here.
function navigateThroughDom(e, value, searchBy, navigationPropertyName) {
	searchBy = searchBy || "tagName";
	navigationPropertyName = navigationPropertyName || "parentNode";
	if (searchBy == "className") {
		while (e && !jQuery(e).hasClass(value)) {
			e = e[navigationPropertyName]; // Reflection! The string value in the square brackets will be invoked!
		}
	} else {
		while (e && e[searchBy] != value) {
			e = e[navigationPropertyName]; // Reflection! The string value in the square brackets is invoked!
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e) {
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if (posTop < winTop) {
		return posTop;
	} else if (posBot > winBot) {
		if (e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth() {
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight() {
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
	var D = document;
	return Math.max(
			Math.max(D.body.scrollHeight, D.documentElement.scrollHeight),
			Math.max(D.body.offsetHeight, D.documentElement.offsetHeight),
			Math.max(D.body.clientHeight, D.documentElement.clientHeight)
	);
}

// Get the current horizontal page scroll position
function findScrollX() {
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY() {
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj) {
	var curleft = 0;
	while (obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj) {
	var curtop = 0;
	while (obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e) {
	if (e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place) {
	var e = document.createTextNode(String.fromCharCode(160));
	if (place) place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e, text) {
	if (e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0,e.selectionStart).split("\n").length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if (document.selection) {
		var range = document.selection.createRange();
		if (range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if (!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e, pos) {
	if (e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if (document.selection) {
		// IE support xxx
		e.focus ();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character',pos);
		sel.moveEnd('character',0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e) {
	var t = "";
	while (e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor) {
	while (e) {
		if (e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}

// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e) {
	var ev = e || window.event;
	ev.cancelBubble = true;
	if (ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e) {
	if (!config.browser.isIE) return;
	var att = e.attributes;
	if (att) {
		var t;
		for (t=0; t<att.length; t++) {
			var n = att[t].name;
			if (n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while (c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s,id,doc) {
	jQuery.twStylesheet(s,{id:id,doc:doc});
}

function removeStyleSheet(id) {
	jQuery.twStylesheet.remove({id:id});
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(sourceElement, destinationStore, articles) {
	var title = this.getTitle(sourceElement);
	if (! title) return;
	if (safeMode && isShadowTiddler(title)) return;
		
	var article = destinationStore.getOrAddNewArticle(title);
	this.populateArticleFromElement(article, title, sourceElement);
	articles.push(article);
};

LoaderBase.prototype.loadArticles = function(sourceElements, destinationStore) {
	var articles = [];
	for (var i = 0; i < sourceElements.length; i++) {
		try {
			this.loadTiddler(sourceElements[i], destinationStore, articles);
		} catch(ex) {
			showException(ex, config.messages.tiddlerLoadError.format([this.getTitle(sourceElements[i])]));
		}
	}
	return articles;
};

function SaverBase() {}

SaverBase.prototype.transformAllArticlesToDivs = function(store) {
	var divBlocks = [];
	var articles = store.getArticlesQuickly("title", true); // sorted by "title", include hidden
	for (var i = 0; i < articles.length; i++) {
		divBlocks.push(this.transformArticleToDiv(store, articles[i]));
	}
	return divBlocks.join("\n");
};

//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(node) {
	// Line breaks in HTML source appear as "text elements" here which don't have "getAttribute" and must be ignored
	return (node.getAttribute) ? node.getAttribute("title") : null;	
};

TW21Loader.prototype.populateArticleFromElement = function(targetArticle, title, sourceDivElement) {
	var preElement = sourceDivElement.firstChild;
	while (preElement.nodeName != "PRE" && preElement.nodeName != "pre") { // Line breaks in HTML source appear as "text elements" here which must be skipped
		preElement = preElement.nextSibling;
	}
	var text = preElement.innerHTML.replace(/\r/mg,"").htmlDecode(); // Remove CR (keep LF), unescape HTML stuff like "&lt;&gt;" to "<>"

	var creator = sourceDivElement.getAttribute("creator");
	var modifier = sourceDivElement.getAttribute("modifier");
	var c = sourceDivElement.getAttribute("created");
	var m = sourceDivElement.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : new Date();
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = sourceDivElement.getAttribute("tags");
	var fields = {};
	var attrs = sourceDivElement.attributes;
	for (var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if (attrs[i].specified && ! ArticleStore.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	targetArticle.assign(title, text, modifier, modified, tags, created, fields, creator);
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.transformArticleToDiv = function(store, article) {
	try {
		var attributes =
			' created="' + article.created.convertToYYYYMMDDHHMM() + '"' +
 			' modified="' + article.modified.convertToYYYYMMDDHHMM() + '"' +
			' modifier="' + article.modifier.htmlEncode() + '"'
		;
		var tags = article.getTagsTuple();
		if (tags) attributes += ' tags="' + tags.htmlEncode() + '"';
		
		var extendedAttributes = ""; // changecount parenttitle
		
		store.forEachField(article,
			function(article, fieldName, value) {
				// don't store stuff from the temp namespace
				if (typeof value != "string") value = "";
				if (value && ! fieldName.match(/^temp\./)) extendedAttributes += ' %0="%1"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);
			}, true
		);
		
		return ('<div title="%0"%1%2>\n<pre>%3</pre>\n</'+'div>').format([
			article.title.htmlEncode(),
			attributes,
			extendedAttributes,
			article.text.htmlEncode()
		]);
	} catch (ex) {
		throw exceptionText(ex, config.messages.tiddlerSaveError.format([article.title]));
	}
};

//]]>
</script>
<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str) {
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be) {
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be) {
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str) {
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str) {
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x, blen) {
	return jQuery.encoding.digests.sha1(x, blen);
};

//--
//-- Deprecated code
//--

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item) {
	var i = this.indexOf(item);
	return i == -1 ? null : i;
};

//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Return the content of an element as plain text with no formatting
function getPlainText(e) {
	return jQuery(e).text();
}

function addClass(e,className) {
	jQuery(e).addClass(className);
}

function removeClass(e,className) {
	jQuery(e).removeClass(className);
}

function hasClass(e,className) {
	return jQuery(e).hasClass(className);
}

//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if (!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for (i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while (j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for (var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for (var i = 0; i < be.length * 4; i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if (!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for (var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while (j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while (j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while (j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while (j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while (j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);
/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet";

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if (doc.createStyleSheet) { // IE-specific handling
		if (el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if (el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if (el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);

//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
